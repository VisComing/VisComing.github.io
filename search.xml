<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>C++ STL 简介</title>
    <url>/2020/09/12/c++%20stl%20%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="C-STL-简介"><a href="#C-STL-简介" class="headerlink" title="C++ STL 简介"></a>C++ STL 简介</h1><h2 id="vector"><a href="#vector" class="headerlink" title="vector"></a>vector</h2><a id="more"></a>
<h3 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h3><p><code>#include &lt;vector&gt;</code></p>
<p><code>using std::vector</code></p>
<h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p><code>vector&lt;int&gt;  a</code>//初始化一个空vector</p>
<p><code>vector&lt;int&gt; a(10, 3)</code>/10个int型元素，它们的值均为3</p>
<p><code>vector&lt;int&gt; a(10)</code>//10个int型元素，执行类的默认初始化，这里10个元素均被初始化为0</p>
<p><code>vector&lt;int&gt; b = a</code>//b中包含a中所有元素的副本</p>
<p><code>vector&lt;int&gt; b(a)</code>//同上</p>
<p><code>vector&lt;int&gt; a&#123;1,2,3,4&#125;</code>//列表初始化，</p>
<h3 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="a-push-back-x"><a href="#a-push-back-x" class="headerlink" title="a.push_back(x)"></a>a.push_back(x)</h4><p>向a末尾插入元素x</p>
<h4 id="a-empty"><a href="#a-empty" class="headerlink" title="a.empty()"></a>a.empty()</h4><p>判断a是否为空，空则返回true</p>
<h4 id="a-size"><a href="#a-size" class="headerlink" title="a.size()"></a>a.size()</h4><p>返回a中元素的个数</p>
<h4 id="a-n"><a href="#a-n" class="headerlink" title="a[n]"></a>a[n]</h4><p>支持随机寻址，返回a中第n个元素的引用，相当于对数组的操作</p>
<h4 id="a-b-a-b"><a href="#a-b-a-b" class="headerlink" title="a==b    a!=b"></a>a==b    a!=b</h4><p>判断a和b是否相等（当且仅当它们的元素数量相同且相同位置的元素值都相同）</p>
<h4 id="lt-lt-gt-gt"><a href="#lt-lt-gt-gt" class="headerlink" title="&lt;    &lt;=    &gt;    &gt;="></a>&lt;    &lt;=    &gt;    &gt;=</h4><p>按照字典序比较两个vector</p>
<h4 id="a-clear"><a href="#a-clear" class="headerlink" title="a.clear()"></a>a.clear()</h4><p>删除a中所有的元素</p>
<h4 id="a-front-a-back"><a href="#a-front-a-back" class="headerlink" title="a.front()    a.back()"></a>a.front()    a.back()</h4><p>返回a中的第一个数 返回a中的最后一个数</p>
<h4 id="a-begin-a-end"><a href="#a-begin-a-end" class="headerlink" title="a.begin()    a.end()"></a>a.begin()    a.end()</h4><p>指向a中的第一个元素，指向a中最后一个元素的下一个位置</p>
<h3 id="遍历方式"><a href="#遍历方式" class="headerlink" title="遍历方式"></a>遍历方式</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; a.size(); i ++) <span class="built_in">cout</span> &lt;&lt; a[i] &lt;&lt; <span class="string">&#x27; &#x27;</span>;<span class="comment">//使用下标来遍历</span></span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::iterator it = a.begin(); it != a.end(); it ++) <span class="built_in">cout</span> &lt;&lt; *it &lt;&lt; <span class="string">&#x27; &#x27;</span>;<span class="comment">//使用迭代器来遍历</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> x:a) <span class="built_in">cout</span> &lt;&lt; x &lt;&lt; <span class="string">&#x27; &#x27;</span>;<span class="comment">//范围遍历</span></span><br></pre></td></tr></table></figure>

<h3 id="vector的增长"><a href="#vector的增长" class="headerlink" title="vector的增长"></a>vector的增长</h3><p>vector可以理解为动态数组，为了减少分配空间的次数，vector大概是在每次需要分配新的内存空间时讲当前容量翻倍</p>
<blockquote>
<p>使用vector时不建议先指定好vector的大小，而是应该先创建一个空的vector对象，然后在运行时利用push_back向其中添加元素。</p>
</blockquote>
<h3 id="二维vector"><a href="#二维vector" class="headerlink" title="二维vector"></a>二维vector</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt; a;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; m; i ++) &#123;<span class="comment">//将二维数组array的元素插入到二维vector中</span></span><br><span class="line">	<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; temp;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; n; j ++) &#123;</span><br><span class="line">		temp.push_back(<span class="built_in">array</span>[m][n]);</span><br><span class="line">	&#125;</span><br><span class="line">	a.push_back(temp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历二维vector</span></span><br><span class="line"><span class="keyword">for</span>(<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt;::iterator it = a.begin(); it != a.end(); it ++) &#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;::iterator t = (*it).begin(); t != (*it).end(); t ++) &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; *t &lt;&lt; <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="string"><a href="#string" class="headerlink" title="string"></a>string</h2><h3 id="头文件-1"><a href="#头文件-1" class="headerlink" title="头文件"></a>头文件</h3><p><code>#include &lt;string&gt;</code></p>
<p><code>using std::string</code></p>
<h3 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h3><p><code>string s</code>//默认初始化，s是一个空字符串</p>
<p><code>string s = &quot;nihaoya&quot;</code>//拷贝初始化，s是该字符串字面值的副本</p>
<p><code>string s(&quot;nihaoya&quot;)</code>//直接初始化</p>
<p><code>string s(10,&#39;c&#39;)</code>//s包含10个重复的c</p>
<h3 id="常用操作-1"><a href="#常用操作-1" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="s-size"><a href="#s-size" class="headerlink" title="s.size()"></a>s.size()</h4><p>返回s中字符的个数</p>
<h4 id="s-empty"><a href="#s-empty" class="headerlink" title="s.empty()"></a>s.empty()</h4><p>判断s是否为空，空则返回true</p>
<h4 id="s-clear"><a href="#s-clear" class="headerlink" title="s.clear()"></a>s.clear()</h4><p>删除字符串的所有字符</p>
<h4 id="s-n"><a href="#s-n" class="headerlink" title="s[n]"></a>s[n]</h4><p>string支持随机访问</p>
<h4 id><a href="#" class="headerlink" title="+"></a>+</h4><p>在字符串末尾追加字符串，注意必须确保每个加号的两侧的运算对象至少有一个是string</p>
<h4 id="s-substr-pos-n"><a href="#s-substr-pos-n" class="headerlink" title="s.substr(pos, n)"></a>s.substr(pos, n)</h4><p>返回从s字符串的pos位置（从0开始）开始的向后n个字符的字符串，如果不写第二个参数，则默认返回从pos位置开始到最后一个字符的字符串</p>
<h4 id="s-c-str"><a href="#s-c-str" class="headerlink" title="s.c_str()"></a>s.c_str()</h4><p>该函数返回一个const char*，指向以空值结尾的字符串（即c风格的字符串）。当你想要将一个string对象传递给需要c风格字符串的函数的时候，就可以使用该函数</p>
<h4 id="stoi-s"><a href="#stoi-s" class="headerlink" title="stoi(s)"></a>stoi(s)</h4><p>将字符串转换为int型，stoi()会做范围检查，默认范围是在int的范围内的，如果超出范围的话则会出现runtime error</p>
<h4 id="to-string-val"><a href="#to-string-val" class="headerlink" title="to_string(val)"></a>to_string(val)</h4><p>将数字转化成字符串</p>
<h3 id="遍历方式-1"><a href="#遍历方式-1" class="headerlink" title="遍历方式"></a>遍历方式</h3><p><code>for(int i = 0; i &lt; s.size(); i ++) cout &lt;&lt; s[i] &lt;&lt; &#39; &#39;; </code></p>
<p><code>for(string::iterator it = s.begin(); it != s.end(); i ++) cout &lt;&lt; *it &lt;&lt; endl;</code></p>
<p><code>for(auto c:s) cout &lt;&lt; c &lt;&lt; &#39; &#39;;</code></p>
<h2 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h2><h3 id="头文件-2"><a href="#头文件-2" class="headerlink" title="头文件"></a>头文件</h3><p><code>#include&lt;vector&gt;</code></p>
<p><code>using std::vector</code></p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p><code>queue&lt;int&gt; q</code></p>
<h3 id="常用操作-2"><a href="#常用操作-2" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="q-front"><a href="#q-front" class="headerlink" title="q.front()"></a>q.front()</h4><p>返回队列第一个元素的引用</p>
<h4 id="q-back"><a href="#q-back" class="headerlink" title="q.back()"></a>q.back()</h4><p>返回队列的最后一个元素的引用</p>
<h4 id="q-push-i"><a href="#q-push-i" class="headerlink" title="q.push(i)"></a>q.push(i)</h4><p>向队尾添加元素</p>
<h4 id="q-pop"><a href="#q-pop" class="headerlink" title="q.pop()"></a>q.pop()</h4><p>删除队列中第一个元素</p>
<h4 id="q-size"><a href="#q-size" class="headerlink" title="q.size()"></a>q.size()</h4><p>返回队列元素的个数</p>
<h4 id="q-empty"><a href="#q-empty" class="headerlink" title="q.empty()"></a>q.empty()</h4><p>判断队列是否为空，如果为空，则返回true</p>
<h2 id="priority-queue"><a href="#priority-queue" class="headerlink" title="priority_queue"></a>priority_queue</h2><p>优先队列，底层是用堆实现的</p>
<h3 id="头文件-3"><a href="#头文件-3" class="headerlink" title="头文件"></a>头文件</h3><p><code>#include &lt;queue&gt;</code></p>
<p><code>using std::queue</code></p>
<h3 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h3><p><code>priority_queue&lt;int&gt; p</code>//默认是大根堆</p>
<p><code>priority_queue&lt;int, vector&lt;int&gt;, greater&lt;int&gt;)</code>//小根堆</p>
<h3 id="常用操作-3"><a href="#常用操作-3" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="p-push"><a href="#p-push" class="headerlink" title="p.push()"></a>p.push()</h4><p>向堆中插入一个元素</p>
<h4 id="p-top"><a href="#p-top" class="headerlink" title="p.top()"></a>p.top()</h4><p>返回堆顶元素</p>
<h4 id="p-pop"><a href="#p-pop" class="headerlink" title="p.pop()"></a>p.pop()</h4><p>弹出堆顶元素</p>
<h4 id="p-empty"><a href="#p-empty" class="headerlink" title="p.empty()"></a>p.empty()</h4><p>判断优先队列是否为空，空则返回true</p>
<h4 id="p-size"><a href="#p-size" class="headerlink" title="p.size()"></a>p.size()</h4><p>返回优先队列中元素的个数</p>
<h4 id="p-push-i"><a href="#p-push-i" class="headerlink" title="p.push(i)"></a>p.push(i)</h4><p>向堆中插入一个元素</p>
<h2 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h2><h3 id="头文件-4"><a href="#头文件-4" class="headerlink" title="头文件"></a>头文件</h3><p><code>#include &lt;stack&gt;</code></p>
<p><code>using std::stack</code></p>
<h3 id="定义-2"><a href="#定义-2" class="headerlink" title="定义"></a>定义</h3><p><code>stack&lt;int&gt; s</code></p>
<h3 id="常用操作-4"><a href="#常用操作-4" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="s-push-i"><a href="#s-push-i" class="headerlink" title="s.push(i)"></a>s.push(i)</h4><p>向栈顶插入一个元素</p>
<h4 id="s-pop"><a href="#s-pop" class="headerlink" title="s.pop()"></a>s.pop()</h4><p>弹出栈顶元素</p>
<h4 id="s-top"><a href="#s-top" class="headerlink" title="s.top()"></a>s.top()</h4><p>返回栈顶元素</p>
<h4 id="s-empty-1"><a href="#s-empty-1" class="headerlink" title="s.empty()"></a>s.empty()</h4><p>判断栈是否为空，空则返回true</p>
<h4 id="s-size-1"><a href="#s-size-1" class="headerlink" title="s.size()"></a>s.size()</h4><p>返回栈中元素的个数</p>
<h2 id="deque"><a href="#deque" class="headerlink" title="deque"></a>deque</h2><p>双端队列</p>
<h3 id="定义-3"><a href="#定义-3" class="headerlink" title="定义"></a>定义</h3><p>deque<int> d;</int></p>
<h3 id="常用操作-5"><a href="#常用操作-5" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="d-size"><a href="#d-size" class="headerlink" title="d.size()"></a>d.size()</h4><p>返回双端队列的大小</p>
<h4 id="d-empty"><a href="#d-empty" class="headerlink" title="d.empty()"></a>d.empty()</h4><p>判断双端队列是否为空</p>
<h4 id="d-clear"><a href="#d-clear" class="headerlink" title="d.clear()"></a>d.clear()</h4><p>删除双端队列的所有元素</p>
<h4 id="d-front-d-back"><a href="#d-front-d-back" class="headerlink" title="d.front()/d.back()"></a>d.front()/d.back()</h4><p>返回双端队列的队头/队尾元素</p>
<h4 id="d-push-back-d-pop-back"><a href="#d-push-back-d-pop-back" class="headerlink" title="d.push_back/d.pop_back()"></a>d.push_back/d.pop_back()</h4><p>插入队尾/弹出队尾元素</p>
<h4 id="d-push-front-d-pop-front"><a href="#d-push-front-d-pop-front" class="headerlink" title="d.push_front()/d.pop_front()"></a>d.push_front()/d.pop_front()</h4><p>插入队首/弹出队首元素</p>
<h4 id="-1"><a href="#-1" class="headerlink" title="[]"></a>[]</h4><p>支持随机访问</p>
<h2 id="set-multiset"><a href="#set-multiset" class="headerlink" title="set/multiset"></a>set/multiset</h2><p>set是一个内部自动有序且不含重复元素的容器 ,multiset可以含重复元素</p>
<h3 id="常用操作-6"><a href="#常用操作-6" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="begin-end-size-empty"><a href="#begin-end-size-empty" class="headerlink" title="begin()    end()    size()    empty()"></a>begin()    end()    size()    empty()</h4><h4 id="s-insert-x"><a href="#s-insert-x" class="headerlink" title="s.insert(x)"></a>s.insert(x)</h4><p>将x插入set容器中，并且自动递增排序和去重，时间复杂度为logn</p>
<h4 id="s-find-x"><a href="#s-find-x" class="headerlink" title="s.find(x)"></a>s.find(x)</h4><p>返回set中对应值为x的迭代器，时间复杂度为logn，如果找不到，则返回end迭代器</p>
<h4 id="s-count-x"><a href="#s-count-x" class="headerlink" title="s.count(x)"></a>s.count(x)</h4><p>返回值为x数的个数</p>
<h4 id="s-erase"><a href="#s-erase" class="headerlink" title="s.erase()"></a>s.erase()</h4><p>输入是一个数x，删除所有x，时间复杂度为</p>
<p>输入一个迭代器，则删除该迭代器</p>
<h4 id="lower-bound-upper-bound"><a href="#lower-bound-upper-bound" class="headerlink" title="lower_bound()/upper_bound"></a>lower_bound()/upper_bound</h4><p>lower_bound(x) 返回大于等于x的最小的数的迭代器</p>
<p>upper_bound(x)返回大于x的最小的数的迭代器</p>
<h2 id="pair"><a href="#pair" class="headerlink" title="pair"></a>pair</h2><h3 id="头文件-5"><a href="#头文件-5" class="headerlink" title="头文件"></a>头文件</h3><p><code>#include &lt;utility&gt;</code></p>
<h3 id="初始化-2"><a href="#初始化-2" class="headerlink" title="初始化"></a>初始化</h3><p><code>pair&lt;string, int&gt; p</code>;</p>
<p><code>pair&lt;string, int&gt; p(&quot;zrf&quot;, 1)</code></p>
<p><code>pair&lt;string, int&gt; p = &#123;&quot;zrf&quot;, 1&#125;</code></p>
<p><code>pair&lt;string, int&gt; p = make_pair(&quot;zrf&quot;, 1)</code></p>
<h3 id="常用操作-7"><a href="#常用操作-7" class="headerlink" title="常用操作"></a>常用操作</h3><h4 id="p-first"><a href="#p-first" class="headerlink" title="p.first"></a>p.first</h4><p>返回p的第一个数据成员</p>
<h4 id="p-second"><a href="#p-second" class="headerlink" title="p.second"></a>p.second</h4><p>返回p的第二个数据成员</p>
<h4 id="make-pair-v1-v2"><a href="#make-pair-v1-v2" class="headerlink" title="make_pair(v1, v2)"></a>make_pair(v1, v2)</h4><p>返回一个用v1，v2初始化的pair</p>
<h4 id="p1-p2-p1-p2"><a href="#p1-p2-p1-p2" class="headerlink" title="p1 == p2    p1 != p2"></a>p1 == p2    p1 != p2</h4><p>当first和second成员分别相等时，两个pair相等</p>
<h2 id="map-multimap"><a href="#map-multimap" class="headerlink" title="map/multimap"></a>map/multimap</h2><h4 id="insert"><a href="#insert" class="headerlink" title="insert()"></a>insert()</h4><p>插入的数是一个pair</p>
<h4 id="erase"><a href="#erase" class="headerlink" title="erase()"></a>erase()</h4><p>c.erase(k)    从c中删除每个关键字为k的元素。返回一个size_type值，指出删除的元素的数量</p>
<p>c.erase(p)    从c中删除迭代器p指定的元素。p不能指向尾后迭代器，返回一个指向p之后元素的迭代器</p>
<h4 id="find"><a href="#find" class="headerlink" title="find()"></a>find()</h4><p>返回一个迭代器，指向第一个关键字为k的元素，若k不在容器中，则返回尾后迭代器</p>
<h4 id="count-k"><a href="#count-k" class="headerlink" title="count(k)"></a>count(k)</h4><p>返回关键字等于k的元素的数量</p>
<h4 id="clear"><a href="#clear" class="headerlink" title="clear()"></a>clear()</h4><p>删除map中所有的元素</p>
<h4 id="size-empty"><a href="#size-empty" class="headerlink" title="size()    empty()"></a>size()    empty()</h4><h4 id="-2"><a href="#-2" class="headerlink" title="[]"></a>[]</h4><p>可以像数组一样使用，时间复杂度是O(logn)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">map&lt;string,int&gt; m;</span><br><span class="line">m[&quot;zrf&quot;] &#x3D; 1;&#x2F;&#x2F;插入</span><br></pre></td></tr></table></figure>

<h4 id="lower-bound-k-upper-bound-k"><a href="#lower-bound-k-upper-bound-k" class="headerlink" title="lower_bound(k)/upper_bound(k)"></a>lower_bound(k)/upper_bound(k)</h4><p>返回一个迭代器，指向第一个关键字大于等于/大于k的元素</p>
<h2 id="unorder-set-unorder-multiset-unorder-map-unorder-multimap"><a href="#unorder-set-unorder-multiset-unorder-map-unorder-multimap" class="headerlink" title="unorder_set    unorder_multiset    unorder_map    unorder_multimap"></a>unorder_set    unorder_multiset    unorder_map    unorder_multimap</h2><p>优点：增删改查时间复杂度是O(1)</p>
<p>缺点：不支持lower_bound()    upper_bound()</p>
]]></content>
  </entry>
  <entry>
    <title>listen music</title>
    <url>/2020/11/10/listen-music/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>
        <div id="aplayer-XyoveHPh" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">
            <pre class="aplayer-lrc-content"></pre>
        </div>
        <script>
          var ap = new APlayer({
            element: document.getElementById("aplayer-XyoveHPh"),
            narrow: false,
            autoplay: false,
            showlrc: false,
            music: {
              title: "雨幕",
              author: "许嵩",
              url: "许嵩-雨幕-新天龙八部端游主题曲.mp3",
              pic: "",
              lrc: ""
            }
          });
          window.aplayers || (window.aplayers = []);
          window.aplayers.push(ap);
        </script>

        <div id="aplayer-klnlDtEe" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">
            <pre class="aplayer-lrc-content"></pre>
        </div>
        <script>
          var ap = new APlayer({
            element: document.getElementById("aplayer-klnlDtEe"),
            narrow: false,
            autoplay: false,
            showlrc: false,
            music: {
              title: "放肆",
              author: "许嵩",
              url: "许嵩-放肆.mp3",
              pic: "",
              lrc: ""
            }
          });
          window.aplayers || (window.aplayers = []);
          window.aplayers.push(ap);
        </script>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=1488737309&auto=1&height=66"></iframe>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=2&id=28747068&auto=1&height=66"></iframe>

        <div id="aplayer-oAdOJlVZ" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>
			  <script>
				  var options = {"narrow":false,"autoplay":false,"showlrc":0,"music":[{"title":"彩券","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-彩券.mp3","pic":""},{"title":"摩天大楼","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-摩天大楼.mp3","pic":""},{"title":"那是你离开了北京的生活","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-那是你离开了北京的生活.mp3","pic":""},{"title":"肆无忌惮","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-肆无忌惮.mp3","pic":""},{"title":"天份","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-天份.mp3","pic":""},{"title":"天外来物","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-天外来物.mp3","pic":""},{"title":"哑巴","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-哑巴.mp3","pic":""},{"title":"最好","author":"薛之谦","url":"/2020/11/10/listen-music/薛之谦-最好.mp3","pic":""}]};
				  options.element = document.getElementById("aplayer-oAdOJlVZ");
				  var ap = new APlayer(options);
			    window.aplayers || (window.aplayers = []);
				  window.aplayers.push(ap);
			  </script>

<p>nini</p>
]]></content>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/09/12/hello-world/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>picture-test</title>
    <url>/2020/11/10/picture-test/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><img src="/2020/11/10/picture-test/1.png" alt="测试图片"></p>
]]></content>
  </entry>
  <entry>
    <title>kmp</title>
    <url>/2020/09/15/kmp/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100010</span>, M = <span class="number">10010</span>;</span><br><span class="line"><span class="keyword">int</span> ne[N];</span><br><span class="line"><span class="keyword">char</span> n[N], p[M];<span class="comment">//n是字符串，p是模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//求next过程，字符串下标从1开始</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>, j =<span class="number">0</span>; i &lt;= <span class="keyword">sizeof</span>(p); i ++ ) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (j &amp;&amp; p[i] != p[j + <span class="number">1</span>]) j = ne[j];</span><br><span class="line">    <span class="keyword">if</span>(p[i] == p[j + <span class="number">1</span>]) j ++;</span><br><span class="line">    ne[i] = j;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//匹配过程,字符串下标从1开始</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>, j = <span class="number">0</span>; i &lt;= <span class="keyword">sizeof</span>(n); i ++ )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(j &amp;&amp; s[i] != p[j + <span class="number">1</span>]) j = ne[j];</span><br><span class="line">    <span class="keyword">if</span>(s[i] == p[j + <span class="number">1</span>]) j ++;</span><br><span class="line">    <span class="keyword">if</span>(j == <span class="keyword">sizeof</span>(n))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//匹配成功</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>Python程序设计作业#1</title>
    <url>/2020/11/10/py1-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计作业-1"><a href="#Python程序设计作业-1" class="headerlink" title="Python程序设计作业#1"></a>Python程序设计作业#1</h1><p>提交邮箱：<a href="mailto:&#x62;&#117;&#112;&#116;&#x6e;&#x65;&#64;&#x67;&#x6d;&#x61;&#105;&#108;&#x2e;&#x63;&#x6f;&#109;">&#x62;&#117;&#112;&#116;&#x6e;&#x65;&#64;&#x67;&#x6d;&#x61;&#105;&#108;&#x2e;&#x63;&#x6f;&#109;</a></p>
<p>邮件标题：py1-班级-学号-姓名</p>
<p>邮件附件：py1-班级-学号-姓名.md（即本文件）</p>
<p>截止时间：2020年10月26日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>使用asyncio的streams（coroutine based API）实现SOCKS5服务器。</p>
<p>协议参考：RFC 1928 - SOCKS Protocol Verison 5</p>
<p>只需要实现CMD X‘01’（即CONNECT）</p>
<p>只需要实现METHOD X‘00’（即NO AUTHENTICATION REQUIRED）</p>
<h2 id="作业内容"><a href="#作业内容" class="headerlink" title="作业内容"></a>作业内容</h2><p>程序源代码嵌入下方的code block中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line">VERSION = <span class="number">5</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">2</span>)</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="number">1</span>:</span><br><span class="line">            reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(address,port[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            writer.close()</span><br><span class="line">            writer.wait_closed()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">        logging.error(error)</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#第一个字节为0表示成功代理</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="number">1</span> <span class="keyword">and</span> reply[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(handle, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10086</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h2 id="代码说明（可选）"><a href="#代码说明（可选）" class="headerlink" title="代码说明（可选）"></a>代码说明（可选）</h2><p>源代码中不要出现大段的说明注释，如果需要可以可以在本节中加上说明。</p>
]]></content>
  </entry>
  <entry>
    <title>Python程序设计作业#2</title>
    <url>/2020/11/10/py2-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计-2作业"><a href="#Python程序设计-2作业" class="headerlink" title="Python程序设计#2作业"></a>Python程序设计#2作业</h1><p>截止时间：2020年11月02日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>实现localProxy双协议（SOCKS5和HTTP tunnel）本地代理。</p>
<p>支持（SOCKS5代理）基于#1作业的成果。</p>
<p>支持HTTP tunnel（ 即HTTP CONNECT method）可用于HTTPS代理。</p>
<p>关于HTTP tunnel可以参见：<a href="https://www.zhihu.com/question/21955083">https://www.zhihu.com/question/21955083</a></p>
<h2 id="作业内容"><a href="#作业内容" class="headerlink" title="作业内容"></a>作业内容</h2><p>程序源代码嵌入下方的code block中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line">VERSION = <span class="number">5</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">socks5</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    header = first + header</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="number">1</span>:</span><br><span class="line">            reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(address,port[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            writer.close()</span><br><span class="line">            writer.wait_closed()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">        logging.error(error)</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#第一个字节为0表示成功代理</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="number">1</span> <span class="keyword">and</span> reply[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">httptunnel</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = (first + http_connect).decode()</span><br><span class="line"></span><br><span class="line">    logging.info(http_connect)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line">    </span><br><span class="line">    logging.info(<span class="string">&#x27;domain_name:%s &#x27;</span> % domain_name)</span><br><span class="line">    logging.info(<span class="string">&#x27;port:%s&#x27;</span> % port)</span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(domain_name,port)</span><br><span class="line">    tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">reader, writer</span>):</span></span><br><span class="line">    first = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(first == <span class="string">b&#x27;\x05&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> socks5(first, reader, writer)</span><br><span class="line">    <span class="keyword">elif</span>(first == <span class="string">b&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> httptunnel(first, reader, writer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(test, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10086</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h2 id="代码说明（可选）"><a href="#代码说明（可选）" class="headerlink" title="代码说明（可选）"></a>代码说明（可选）</h2><p>源代码中不要出现大段的说明注释，如果需要可以可以在本节中加上说明。</p>
]]></content>
  </entry>
  <entry>
    <title>Python程序设计作业#3</title>
    <url>/2020/11/10/py3-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计-3作业"><a href="#Python程序设计-3作业" class="headerlink" title="Python程序设计#3作业"></a>Python程序设计#3作业</h1><p>截止时间：2020年11月09日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>实现localProxy和remoteProxy分离式代理。</p>
<p>支持SOCKS5代理和HTTPS代理（基于#2作业的成果）。</p>
<p>localProxy收到的每个TCP连接单独建立代理TCP连接。</p>
<h2 id="作业内容"><a href="#作业内容" class="headerlink" title="作业内容"></a>作业内容</h2><p>程序源代码嵌入下方的code block中。</p>
<p>local proxy</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line">VERSION = <span class="number">5</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">socks5</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    header = first + header</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="number">1</span>:</span><br><span class="line">            reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">            http_connect = <span class="string">&#x27;CONNECT &#x27;</span> + address.decode() + <span class="string">&#x27;:&#x27;</span> + str(port[<span class="number">0</span>]) + <span class="string">&#x27; HTTP/1.1&#x27;</span></span><br><span class="line">            print(<span class="string">&#x27;http_connect&#x27;</span>)</span><br><span class="line">            print(http_connect)</span><br><span class="line">            writer_remote.write(http_connect.encode())</span><br><span class="line">            <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">            reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            writer.close()</span><br><span class="line">            writer.wait_closed()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">        logging.error(error)</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#第一个字节为0表示成功代理</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="number">1</span> <span class="keyword">and</span> reply[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">httptunnel</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = (first + http_connect).decode()</span><br><span class="line"></span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">10010</span>)</span><br><span class="line">    writer_remote.write(http_connect.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    <span class="comment">#连接建立成功</span></span><br><span class="line">    tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">reader, writer</span>):</span></span><br><span class="line">    first = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(first == <span class="string">b&#x27;\x05&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> socks5(first, reader, writer)</span><br><span class="line">    <span class="keyword">elif</span>(first == <span class="string">b&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> httptunnel(first, reader, writer)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(test, <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10086</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p>remote proxy</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">reader_local, writer_local</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader_local.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = http_connect.decode()</span><br><span class="line">    logging.info(http_connect)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line"></span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(domain_name,port)</span><br><span class="line"></span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer_local.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_local.drain()</span><br><span class="line"></span><br><span class="line">    tasks = [read_trans(reader_local, writer_remote), write_trans(reader_remote, writer_local)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(handle, <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>





<h2 id="代码说明（可选）"><a href="#代码说明（可选）" class="headerlink" title="代码说明（可选）"></a>代码说明（可选）</h2><p>源代码中不要出现大段的说明注释，如果需要可以可以在本节中加上说明。</p>
]]></content>
  </entry>
  <entry>
    <title>Python程序设计作业#4</title>
    <url>/2020/11/18/py4-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计-4作业"><a href="#Python程序设计-4作业" class="headerlink" title="Python程序设计#4作业"></a>Python程序设计#4作业</h1><p>截止时间：2020年11月16日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>在作业#3的基础上实现localProxy命令行参数账号登录</p>
<p>在作业#3的基础上实现remoteProxy多账号认证</p>
<p>remoteProxy采用SQLite3数据库进行用户账号管理（用户名、密码）</p>
<p>remoteProxy使用aiosqlite操作SQLite3数据库</p>
<h2 id="作业内容"><a href="#作业内容" class="headerlink" title="作业内容"></a>作业内容</h2><p>程序源代码嵌入下方的code block中。</p>
<p><strong>local_proxy</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line">VERSION = <span class="number">5</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">socks5</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    header = first + header</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="number">1</span>:</span><br><span class="line">            reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">            http_connect = <span class="string">&#x27;CONNECT &#x27;</span> + address.decode() + <span class="string">&#x27;:&#x27;</span> + str(port[<span class="number">0</span>]) + <span class="string">&#x27; HTTP/1.1&#x27;</span></span><br><span class="line">            print(<span class="string">&#x27;http_connect&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">            print(http_connect)</span><br><span class="line">            writer_remote.write(http_connect.encode())</span><br><span class="line">            <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">            reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            writer.close()</span><br><span class="line">            writer.wait_closed()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">        logging.error(error)</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#第一个字节为0表示成功代理</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="number">1</span> <span class="keyword">and</span> reply[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">httptunnel</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = (first + http_connect).decode()</span><br><span class="line">    http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">10010</span>)</span><br><span class="line">    writer_remote.write(http_connect.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    <span class="comment">#连接建立成功</span></span><br><span class="line">    tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">reader, writer</span>):</span></span><br><span class="line">    first = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(first == <span class="string">b&#x27;\x05&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> socks5(first, reader, writer)</span><br><span class="line">    <span class="keyword">elif</span>(first == <span class="string">b&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> httptunnel(first, reader, writer)</span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">global</span> username, password</span><br><span class="line">    <span class="keyword">if</span>(len(sys.argv) != <span class="number">3</span>):</span><br><span class="line">        logging.info(<span class="string">&#x27;usage: local-proxy.py username, password&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        username = sys.argv[<span class="number">1</span>]</span><br><span class="line">        password = sys.argv[<span class="number">2</span>]</span><br><span class="line">    print(username)</span><br><span class="line"></span><br><span class="line">    print(password)</span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(test, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10086</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p><strong>remote-proxy</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line"><span class="keyword">import</span> aiosqlite</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">reader_local, writer_local</span>):</span></span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(<span class="string">&#x27;account.db&#x27;</span>)</span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader_local.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = http_connect.decode()</span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    j = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    k = j + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[k] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">    username = http_connect[i + <span class="number">1</span>: j]</span><br><span class="line">    password = http_connect[j + <span class="number">1</span>: k]</span><br><span class="line">    print(username)</span><br><span class="line">    print(password)</span><br><span class="line">    sql = <span class="string">&#x27;SELECT * FROM accout where username = \&#x27;&#x27;</span> + username + <span class="string">&#x27;\&#x27; and password = \&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span></span><br><span class="line">    print(sql)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">await</span> cursor.close()</span><br><span class="line">    <span class="keyword">if</span>(len(row) != <span class="number">1</span>):</span><br><span class="line">        logging.error(<span class="string">&#x27;wrong account&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.info(<span class="string">&#x27;right account&#x27;</span>)</span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(domain_name,port)</span><br><span class="line"></span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer_local.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_local.drain()</span><br><span class="line"></span><br><span class="line">    tasks = [read_trans(reader_local, writer_remote), write_trans(reader_remote, writer_local)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">	<span class="keyword">await</span> db.close()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(handle, <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>



<h2 id="代码说明（可选）"><a href="#代码说明（可选）" class="headerlink" title="代码说明（可选）"></a>代码说明（可选）</h2><p>源代码中不要出现大段的说明注释，如果需要可以可以在本节中加上说明。</p>
]]></content>
  </entry>
  <entry>
    <title>Python程序设计作业#7</title>
    <url>/2020/12/07/py7-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计-7作业"><a href="#Python程序设计-7作业" class="headerlink" title="Python程序设计#7作业"></a>Python程序设计#7作业</h1><p>截止时间：2020年12月7日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>实现remoteProxy的用户数据库的REST管理接口</p>
<p>基于Sanic实现对user.db数据库（SQLite）的管理接口</p>
<p>支持对user用户的增、删、改、查操作。</p>
<p>初步掌握Sanic的使用方法。</p>
<h2 id="remoteRest代码"><a href="#remoteRest代码" class="headerlink" title="remoteRest代码"></a>remoteRest代码</h2><p>remoteRest代码嵌入下方的code block中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> response</span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> aiosqlite</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;RemoteProxyAdmin&quot;</span>)</span><br><span class="line">app.config.DB_NAME = <span class="string">&#x27;user.db&#x27;</span></span><br><span class="line"><span class="meta">@app.exception(exceptions.NotFound)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">ignore_404</span>(<span class="params">req, exc</span>):</span></span><br><span class="line">    <span class="keyword">return</span> response.text(<span class="string">&#x27;errUrl&#x27;</span>, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">userList</span>(<span class="params">req</span>):</span></span><br><span class="line">    userList = list()</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiosqlite.connect(app.config.DB_NAME) <span class="keyword">as</span> db:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> db.execute(<span class="string">&quot;SELECT name, password, dataRate FROM user;&quot;</span>) <span class="keyword">as</span> cursor:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">for</span> row <span class="keyword">in</span> cursor:</span><br><span class="line">                user = &#123;<span class="string">&#x27;name&#x27;</span> : row[<span class="number">0</span>], <span class="string">&#x27;password&#x27;</span> : row[<span class="number">1</span>], <span class="string">&#x27;dataRate:&#x27;</span> : row[<span class="number">2</span>]&#125;</span><br><span class="line">                logging.debug(<span class="string">f&#x27;<span class="subst">&#123;user&#125;</span>&#x27;</span>)</span><br><span class="line">                userList.append(user)</span><br><span class="line">    <span class="keyword">return</span> response.json(userList)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">updateUserInfo</span>(<span class="params">req</span>):</span><span class="comment">#每次只能更新一条用户的数据</span></span><br><span class="line">    update_user_info = req.json</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    password = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    dataRate = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> update_user_info.items():</span><br><span class="line">        <span class="keyword">if</span>(k == <span class="string">&#x27;name&#x27;</span>):</span><br><span class="line">            name = v</span><br><span class="line">        <span class="keyword">elif</span>(k == <span class="string">&#x27;password&#x27;</span>):</span><br><span class="line">            password = v</span><br><span class="line">        <span class="keyword">elif</span>(k == <span class="string">&#x27;dataRate&#x27;</span>):</span><br><span class="line">            dataRate = v</span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user not exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;update user set password = \&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;, dataRate = &#x27;</span> + str(dataRate) + <span class="string">&#x27; where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;update successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">insertUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    insert_user_info = req.json</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    password = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    dataRate = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> insert_user_info.items():</span><br><span class="line">        <span class="keyword">if</span>(k == <span class="string">&#x27;name&#x27;</span>):</span><br><span class="line">            name = v</span><br><span class="line">        <span class="keyword">elif</span>(k == <span class="string">&#x27;password&#x27;</span>):</span><br><span class="line">            password = v</span><br><span class="line">        <span class="keyword">elif</span>(k == <span class="string">&#x27;dataRate&#x27;</span>):</span><br><span class="line">            dataRate = v</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span>    </span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) != <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user already exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;insert into user values(\&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;,&#x27;</span> + str(dataRate) + <span class="string">&#x27;);&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;insert successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.delete(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">deleteUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    delete_user_info = req.json</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> v <span class="keyword">in</span> delete_user_info.values():</span><br><span class="line">        name = v</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span>  </span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user not exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;delete from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()    </span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;delete successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/zrf&quot;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;hello&quot;</span>: <span class="string">&quot;world&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h2><p>源代码中不要出现大段的说明注释，所有文字描述在本节中以行号引用说明。</p>
]]></content>
  </entry>
  <entry>
    <title>Python程序设计作业#5</title>
    <url>/2020/11/30/py5-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计-5作业"><a href="#Python程序设计-5作业" class="headerlink" title="Python程序设计#5作业"></a>Python程序设计#5作业</h1><p>截止时间：2020年11月23日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>在作业#4的基础上实现remoteProxy对每个用户进行单独流控</p>
<p>SQLite3数据库的每个用户的账号信息中增加带宽信息（用户名、密码、带宽）</p>
<p>带宽的单位为BPS（Bytes / Second，字节每秒），该带宽为某个用户的所有连接的转发数据总和带宽。</p>
<p>此次作业需要在【代码说明】中陈述流控的技术方案和实现机制。</p>
<h2 id="作业内容"><a href="#作业内容" class="headerlink" title="作业内容"></a>作业内容</h2><p>程序源代码嵌入下方的code block中。</p>
<p>local-proxy</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line">VERSION = <span class="number">5</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">socks5</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    header = first + header</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="number">1</span>:</span><br><span class="line">            reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">            http_connect = <span class="string">&#x27;CONNECT &#x27;</span> + address + <span class="string">&#x27;:&#x27;</span> + str(port[<span class="number">0</span>]) + <span class="string">&#x27; HTTP/1.1&#x27;</span></span><br><span class="line">            print(<span class="string">&#x27;http_connect&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">            print(http_connect)</span><br><span class="line">            writer_remote.write(http_connect.encode())</span><br><span class="line">            <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">            reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            writer.close()</span><br><span class="line">            writer.wait_closed()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">        logging.error(error)</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#第一个字节为0表示成功代理</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="number">1</span> <span class="keyword">and</span> reply[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">httptunnel</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = (first + http_connect).decode()</span><br><span class="line">    http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">10010</span>)</span><br><span class="line">    writer_remote.write(http_connect.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    <span class="comment">#连接建立成功</span></span><br><span class="line">    tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">reader, writer</span>):</span></span><br><span class="line">    first = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(first == <span class="string">b&#x27;\x05&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> socks5(first, reader, writer)</span><br><span class="line">    <span class="keyword">elif</span>(first == <span class="string">b&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> httptunnel(first, reader, writer)</span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">global</span> username, password</span><br><span class="line">    <span class="keyword">if</span>(len(sys.argv) != <span class="number">3</span>):</span><br><span class="line">        logging.info(<span class="string">&#x27;usage: local-proxy.py username, password&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        username = sys.argv[<span class="number">1</span>]</span><br><span class="line">        password = sys.argv[<span class="number">2</span>]</span><br><span class="line">    print(username)</span><br><span class="line"></span><br><span class="line">    print(password)</span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(test, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10086</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p>remote-proxy</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line"><span class="keyword">import</span> aiosqlite</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">reader_local, writer_local</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;start working&#x27;</span>)</span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(<span class="string">&#x27;account.db&#x27;</span>)</span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader_local.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = http_connect.decode()</span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    j = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    k = j + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[k] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">    username = http_connect[i + <span class="number">1</span>: j]</span><br><span class="line">    password = http_connect[j + <span class="number">1</span>: k]</span><br><span class="line">    print(username)</span><br><span class="line">    print(password)</span><br><span class="line">    sql = <span class="string">&#x27;SELECT * FROM accout where username = \&#x27;&#x27;</span> + username + <span class="string">&#x27;\&#x27; and password = \&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span></span><br><span class="line">    print(sql)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">await</span> cursor.close()</span><br><span class="line">    <span class="keyword">if</span>(len(row) != <span class="number">1</span>):</span><br><span class="line">        logging.error(<span class="string">&#x27;wrong account&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.info(<span class="string">&#x27;right account&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(username <span class="keyword">not</span> <span class="keyword">in</span> username_to_token_bucket.keys()):<span class="comment">#用户名不在dict中，要创建令牌桶</span></span><br><span class="line">        username_to_token_bucket[username] = <span class="number">0</span></span><br><span class="line">        print(<span class="string">&#x27;init bucket&#x27;</span>)</span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(domain_name,port)</span><br><span class="line">    sql = <span class="string">&#x27;select speed FROM accout where username = \&#x27;&#x27;</span> + username + <span class="string">&#x27;\&#x27;&#x27;</span> </span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">await</span> cursor.close()</span><br><span class="line">    speed = row[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer_local.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_local.drain()</span><br><span class="line"></span><br><span class="line">    tasks = [read_trans(reader_local, writer_remote), write_trans(reader_remote, writer_local, username, speed)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks,return_when=asyncio.FIRST_COMPLETED)</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect from clinet&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer, username, speed</span>):</span></span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            data = <span class="keyword">await</span> reader_remote.read(int(<span class="number">0.01</span> * speed))<span class="comment"># 10.01s    speed  Bytes/s</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect from server&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span>(username_to_token_bucket[username] &lt; <span class="number">10</span>):<span class="comment">#如果桶里的令牌不够那么就等待，注意，这里用了asyncio.sleep(0)</span></span><br><span class="line">            <span class="comment"># 目的是让cpu去执行其他部分的代码，防止在此处阻塞</span></span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:<span class="comment">#令牌够了，把data发出去，同时把data清空</span></span><br><span class="line">            username_to_token_bucket[username] -= <span class="number">10</span></span><br><span class="line">            writer.write(data)</span><br><span class="line">            <span class="keyword">await</span> writer.drain()</span><br><span class="line">            data = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">token_bucket_plus_one</span>():</span></span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> username_to_token_bucket.keys():<span class="comment"># 每1秒可以攒够1000个令牌，所以平均速率为100KB/s</span></span><br><span class="line">            <span class="keyword">if</span> username_to_token_bucket[k] &lt; <span class="number">10000</span>:</span><br><span class="line">                username_to_token_bucket[k] += <span class="number">10</span></span><br><span class="line">                print(username_to_token_bucket[k])</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">_task</span>():</span></span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(handle, <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    tasks = [_task(), token_bucket_plus_one()]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">username_to_token_bucket = &#123;&#125;</span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>



<h2 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h2><p>源代码中不要出现大段的说明注释，所有文字描述在本节中以行号引用说明。</p>
<p><strong>用一个全局变量username_to_token_bucket{username, bucket}表示某个用户对应令牌桶的令牌数量</strong></p>
<p>这样就解决了同一用户的所有连接的总速率不会超过限制的速率</p>
<p>每个用户的令牌桶令牌数每隔一段时间自动增加，一旦加到桶满了，就不加了</p>
<p>当有数据要发送时，首先检查令牌够不够，如果够，直接发送，然后把桶里的令牌数减少</p>
<p>如果桶里令牌数不够，那么就等待，注意，为了不使程序阻塞，这里使用了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> asyncio.sleep(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<p>来让出cpu，使cpu去执行程序的其他部分</p>
]]></content>
  </entry>
  <entry>
    <title>Python程序设计作业#8</title>
    <url>/2020/12/08/py8-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计-8作业"><a href="#Python程序设计-8作业" class="headerlink" title="Python程序设计#8作业"></a>Python程序设计#8作业</h1><p>截止时间：2020年12月14日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>使用venv创建开发环境</p>
<p>使用命令冻结依赖关系生成 requirements.txt</p>
<p>测试使用requirements.txt 重新部署在其他环境位置</p>
<p>将以上内容写成报告写在Markdown文档中提交作业</p>
<h2 id="报告内容"><a href="#报告内容" class="headerlink" title="报告内容"></a>报告内容</h2><p>本次作业不涉及代码，格式不做要求。</p>
<p>我的环境为ubuntu 18.04  python3.7</p>
<p>1、使用venv创建开发环境</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">python3 -m venv myenv</span><br></pre></td></tr></table></figure>

<p>提示要安装python3-venv</p>
<p>执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt install python3.7-venv</span><br></pre></td></tr></table></figure>

<p>安装好后虚拟开发环境就搭建好了，然后我随意安装了几个pip包，供接下来的测试使用</p>
<p>2、使用命令冻结依赖关系生成 requirements.txt</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip freeze &gt; requirements.txt</span><br></pre></td></tr></table></figure>

<p>可以查看requirements.txt里的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat requirements.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">aiosqlite&#x3D;&#x3D;0.16.0</span><br><span class="line">certifi&#x3D;&#x3D;2020.12.5</span><br><span class="line">h11&#x3D;&#x3D;0.9.0</span><br><span class="line">httpcore&#x3D;&#x3D;0.11.1</span><br><span class="line">httpx&#x3D;&#x3D;0.15.4</span><br><span class="line">idna&#x3D;&#x3D;2.10</span><br><span class="line">pkg-resources&#x3D;&#x3D;0.0.0</span><br><span class="line">rfc3986&#x3D;&#x3D;1.4.0</span><br><span class="line">sniffio&#x3D;&#x3D;1.2.0</span><br><span class="line">typing-extensions&#x3D;&#x3D;3.7.4.3</span><br><span class="line">websockets&#x3D;&#x3D;8.1</span><br></pre></td></tr></table></figure>

<p>3、在新建一个虚拟环境</p>
<p>​    首先退出该虚拟环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deactivate</span><br></pre></td></tr></table></figure>

<p>​    然后新建一个虚拟环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 -m venv newenv</span><br><span class="line">source newenv&#x2F;bin&#x2F;activate</span><br></pre></td></tr></table></figure>

<p>4、使用requirements.txt 重新部署在其他环境位置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>执行后发现正在安装许多包</p>
<p>安装完成后，查看当前安装了哪些包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip list</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">aiosqlite (0.16.0)</span><br><span class="line">certifi (2020.12.5)</span><br><span class="line">h11 (0.9.0)</span><br><span class="line">httpcore (0.11.1)</span><br><span class="line">httpx (0.15.4)</span><br><span class="line">idna (2.10)</span><br><span class="line">pip (9.0.1)</span><br><span class="line">pkg-resources (0.0.0)</span><br><span class="line">rfc3986 (1.4.0)</span><br><span class="line">setuptools (39.0.1)</span><br><span class="line">sniffio (1.2.0)</span><br><span class="line">typing-extensions (3.7.4.3)</span><br><span class="line">websockets (8.1)</span><br></pre></td></tr></table></figure>

<p>发现把requirements.txt全部包部署到了新环境中</p>
<p>测试成功</p>
]]></content>
  </entry>
  <entry>
    <title>test_my_blog</title>
    <url>/2020/09/12/test-my-blog/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script>]]></content>
  </entry>
  <entry>
    <title>常用shell命令</title>
    <url>/2020/09/13/shell/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="date"><a href="#date" class="headerlink" title="date"></a>date</h2><p>会显示当前的时间</p>
<h2 id="echo"><a href="#echo" class="headerlink" title="echo"></a>echo</h2><p>回显，</p>
<p><code>$echo hello</code></p>
<p><code>hello</code></p>
<p>如果想要显示多个单词怎么办呢</p>
<p><code>$echo “hello wordl”</code></p>
<p>用引号即可</p>
<p><code>$echo hello\ world</code></p>
<h3 id="echo-PATH"><a href="#echo-PATH" class="headerlink" title="echo $PATH"></a>echo $PATH</h3><p>显示出命令执行的路径。shell是一个编程环境，就像python一样。那么shell在执行echo或者date程序时，它就要找到程序的位置，就会询问环境变量，包含在$PATH中</p>
<h3 id="which-echo"><a href="#which-echo" class="headerlink" title="which echo"></a>which echo</h3><p>显示执行echo命令的路径</p>
<h2 id="pwd"><a href="#pwd" class="headerlink" title="pwd"></a>pwd</h2><p>print working directory打印当前工作路径</p>
<h2 id="cd"><a href="#cd" class="headerlink" title="cd"></a>cd</h2><p>change directory 改变工作路径</p>
<h3 id><a href="#" class="headerlink" title="."></a>.</h3><p>当前路径</p>
<h3 id="-1"><a href="#-1" class="headerlink" title=".."></a>..</h3><p>当前路径的父目录</p>
<p>绝对路径，相对路径</p>
<h3 id="-2"><a href="#-2" class="headerlink" title="~"></a>~</h3><p>回到用户目录</p>
<h3 id="-3"><a href="#-3" class="headerlink" title="-"></a>-</h3><p>回到上一个路径</p>
<h2 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h2><h3 id="ls-l"><a href="#ls-l" class="headerlink" title="ls -l"></a>ls -l</h3><p>drwxr-xr-x</p>
<p>第一个字母如果是d，表示是一个目录，如果是-，表示是一个文件</p>
<p>第一个字母表示文件类型</p>
<p>d:目录</p>
<p>-:普通文件</p>
<p>l:符号链接文件</p>
<p>b:块设备</p>
<p>c:字符设备</p>
<p>p:命令管道文件</p>
<p>s:套接字文件</p>
<p>接下来是三组，每组有三个字母</p>
<p>r:read读权限    w:write写权限    x:excute执行权限</p>
<p>也可以用数字表示r=4,w=2,x=1，把每一组的rwx对应的数字加起来，上面的即为755</p>
<p>第一组表示文件拥有者权限，第二组表示同组用户权限，最后一组表示其他用户权限（不包括root）</p>
<p>对于目录来说，为了进入目录，你需要有执行权限，为了列出目录的内容，你需要有读权限</p>
<h2 id="mv"><a href="#mv" class="headerlink" title="mv"></a>mv</h2><p>将一个文件从一个路径移动并重命名到另一个路径下</p>
<h2 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h2><p>将一个文件从一个路径拷贝并重命名到另一个路径下</p>
<h2 id="rm"><a href="#rm" class="headerlink" title="rm"></a>rm</h2><p>移除一个文件</p>
<p>rm只能移除当个文件，如果你想移除目录，加上-r递归移除</p>
<h2 id="rmdir"><a href="#rmdir" class="headerlink" title="rmdir"></a>rmdir</h2><p>移除一个空目录</p>
<h2 id="mkdir"><a href="#mkdir" class="headerlink" title="mkdir"></a>mkdir</h2><p>创建一个目录，如果目录已存在，则会报错</p>
<p>如果想创建一个有空格的目录怎么办</p>
<p><code>$mkdir hello world</code></p>
<p>这样会创建两个目录</p>
<p><code>mkdir &quot;hello world&quot;</code></p>
<p>这样就可以了</p>
<h2 id="man"><a href="#man" class="headerlink" title="man"></a>man</h2><p>查看某个命令的手册，按q退出</p>
<p><code>$man ls</code></p>
<h2 id="ctrl-L"><a href="#ctrl-L" class="headerlink" title="ctrl L"></a>ctrl L</h2><p>清空控制台</p>
<h2 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h2><p>打印文件的内容</p>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p><code>$echo hello &gt; hello.txt</code></p>
<p>echo本来会将其输出写入到标准输出，默认情况下就是终端；使用&gt;将其输出重定向到hello.tex文件中，如果hello.txt文件不存在，则会新建一个hello.txt；如果存在hello.txt则会覆盖里面原有的内容。</p>
<p>使用&gt;&gt;将输出以追加方式重定向到hello.txt中</p>
<p>也有输入重定向</p>
<p><code>$cat &lt; hello.txt</code></p>
<p>将cat的输入重定向到hello.txt,输出为</p>
<p><code>hello</code></p>
<p><code>$cat &lt; hello.txt &gt; hello2.txt</code></p>
<p>将hello.txt中的内容拷贝到hello2.txt中</p>
<p>cat对重定向的过程一无所知</p>
<h2 id="-4"><a href="#-4" class="headerlink" title="|"></a>|</h2><p>管道，将|左边的输出作为右边的输入</p>
<p><code>$ls -l /</code></p>
<p>会输出/目录下的详细信息，如果我只想要最后一行信息怎么办呢</p>
<p><code>$tail -n1</code></p>
<p>可以输出最后一行</p>
<p><code>$ls -l / | tail -n1</code></p>
<p>左边的输出作为右边的输入，则会输出最后一行</p>
<p>ls和tail对彼此的存在毫不知情</p>
<h2 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h2><p>用于查找文件中符合条件的字符串，如果发现某文件含有指定的字符，则会把含有字符的这一行打印出来；如果不指定任何文件名称，或者给予的文件名是-，则grep命令会从标准输入设备读取数据</p>
<p><code>$curl --head www.baidu.com</code></p>
<p><img src="/2020/09/13/shell/Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200913150417575.png" alt="image-20200913150417575"></p>
<p><code>curl --head www.baidu.com | grep -i content-length</code></p>
<p><img src="/2020/09/13/shell/Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200913150514334.png" alt="image-20200913150514334"></p>
<h2 id="tee"><a href="#tee" class="headerlink" title="tee"></a>tee</h2><p>从标准输入设备读取数据，将其内容输出到标准输出设备，同时保存到文件，</p>
<h2 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h2><p>change mode,修改用户对文件的权限</p>
<p>只有文件所有者和root用户可以修改权限</p>
<p>chmod mode file</p>
<p>mode：</p>
<p>[ugoa] [+-=] [rwx]</p>
<p>u表示该文件拥有者，g表示与该文件的拥有者属于同一个群组的用户，o表示其他用户，a表示所有用户</p>
<p>+表示增加权限，-表示取消权限，=表示唯一设定权限</p>
<p>r表示可读取，w表示可写入，x表示可执行</p>
<p><code>chomd u+x foo.bar</code></p>
<p><code>chmod ug+w, o-w foo.bar</code></p>
<p>此外chmod也可以用数字来表示权限</p>
<p><code>chmod 777 foo.bar</code></p>
]]></content>
  </entry>
  <entry>
    <title>typora行内公式</title>
    <url>/2021/01/08/typora%E8%A1%8C%E5%86%85%E5%85%AC%E5%BC%8F/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>这个是需要先设置一下的</p>
<p>点击文件-偏好设置-markdown</p>
<p>在内联公式打勾即可</p>
<p><img src="https://i.loli.net/2021/01/08/ajFDUSG4O2QNKV3.png" alt="image-20210108105517989"></p>
<p>如果还是不行，重启typora就可以了</p>
]]></content>
  </entry>
  <entry>
    <title>二维vector</title>
    <url>/2021/01/08/%E4%BA%8C%E7%BB%B4vector/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>vector&lt; vector<int> &gt; v(n，vector<int>(m))；</int></int></p>
<p>它有n个元素，每个元素都是包含m个int型元素的一维向量</p>
]]></content>
  </entry>
  <entry>
    <title>tire树</title>
    <url>/2020/09/16/trie/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100010</span>;</span><br><span class="line"><span class="comment">//son表示子节点，这里仅考虑26个小写字母。</span></span><br><span class="line"><span class="keyword">int</span> son[N][<span class="number">26</span>], cnt[N], idx;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">char</span> str[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p  = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; str[i]; i ++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> u = str[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">		<span class="keyword">if</span>(!son[p][u]) son[p][u] = ++ idx;</span><br><span class="line">        p = son[p][u];</span><br><span class="line">    &#125;</span><br><span class="line">    cnt[p] ++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">char</span> str[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> p = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; str[i]; i ++)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="keyword">int</span> u = str[i] - <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(!son[p][u]) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        p = son[p][u];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cnt[p];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>数组模拟单链表</title>
    <url>/2020/09/13/%E6%95%B0%E7%BB%84%E6%A8%A1%E6%8B%9F%E9%93%BE%E8%A1%A8/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="数组模拟单链表"><a href="#数组模拟单链表" class="headerlink" title="数组模拟单链表"></a>数组模拟单链表</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100010</span>;</span><br><span class="line"><span class="keyword">int</span> e[N], ne[N], idx, head;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    head = <span class="number">-1</span>;</span><br><span class="line">    idx = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//往链表头部插入元素</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert_head</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    e[idx] = x;<span class="comment">//首先将元素的值保存起来</span></span><br><span class="line">    ne[idx] = head;</span><br><span class="line">    head = idx;</span><br><span class="line">    idx ++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在k位置的后面插入x</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    e[idx] = x;</span><br><span class="line">    ne[idx] = ne[k];</span><br><span class="line">    ne[k] = idx;</span><br><span class="line">    idx ++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//移除k位置后面的x元素</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> k, <span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ne[k] = ne[ne[k]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//移除头节点</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_head</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    head = ne[head];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数组模拟双链表"><a href="#数组模拟双链表" class="headerlink" title="数组模拟双链表"></a>数组模拟双链表</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100010</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> idx, l[N], r[N], e[N];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    l[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    r[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在a的右边插入一个数x</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert_right</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> x)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    e[idx] = x;</span><br><span class="line">    r[idx] = r[a];</span><br><span class="line">    l[idx] = a;</span><br><span class="line">    l[r[a]] = idx;</span><br><span class="line">    r[a] = idx;</span><br><span class="line">    idx ++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//在a的左边插入一个数x</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert_left</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    insert_right(l[a], x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//删除节点a</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    l[r[a]] = l[a];</span><br><span class="line">    r[l[a]] = r[a];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="数组模拟栈、队列"><a href="#数组模拟栈、队列" class="headerlink" title="数组模拟栈、队列"></a>数组模拟栈、队列</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100010</span>;</span><br><span class="line"><span class="comment">/************栈*************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//tt表示栈顶</span></span><br><span class="line"><span class="keyword">int</span> stk[N], tt;</span><br><span class="line"></span><br><span class="line"><span class="comment">//进栈</span></span><br><span class="line">stk[++ tt] = x;</span><br><span class="line"></span><br><span class="line"><span class="comment">//出栈</span></span><br><span class="line">tt --;</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断栈是否为空</span></span><br><span class="line"><span class="keyword">if</span>(tt &gt; <span class="number">0</span>) 不空</span><br><span class="line"><span class="keyword">else</span> 空</span><br><span class="line">    </span><br><span class="line"><span class="comment">//栈顶元素</span></span><br><span class="line">stk[tt];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********队列***************/</span></span><br><span class="line"><span class="comment">//hh表示队头，tt表示队尾，在队尾插入元素，在队头弹出元素</span></span><br><span class="line"><span class="keyword">int</span> q[N], hh, tt = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//插入</span></span><br><span class="line">q[++ tt] = x;</span><br><span class="line"><span class="comment">//弹出</span></span><br><span class="line">hh ++;</span><br><span class="line"><span class="comment">//判断是否为空</span></span><br><span class="line"><span class="keyword">if</span>(hh &lt;= tt)非空</span><br><span class="line"><span class="keyword">else</span> 空</span><br><span class="line"><span class="comment">//取出队头元素</span></span><br><span class="line">q[hh];</span><br><span class="line"><span class="comment">//取出队尾元素</span></span><br><span class="line">q[tt];</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>图床测试</title>
    <url>/2021/01/01/%E6%9C%AA%E5%91%BD%E5%90%8D/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><img src="https://i.loli.net/2021/01/01/FT8fAWpjEdLKsOy.png" alt="image-20210101185711624"></p>
]]></content>
  </entry>
  <entry>
    <title>植物大战僵尸制作说明</title>
    <url>/2020/11/12/%E6%A4%8D%E7%89%A9%E5%A4%A7%E6%88%98%E5%83%B5%E5%B0%B8/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="植物大战僵尸制作说明"><a href="#植物大战僵尸制作说明" class="headerlink" title="植物大战僵尸制作说明"></a>植物大战僵尸制作说明</h1><p><a href="%E6%A4%8D%E7%89%A9%E5%A4%A7%E6%88%98%E5%83%B5%E5%B0%B8/releaseTest.exe" title="植物大战僵尸游戏下载">点击下载</a></p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>双人网络对战游戏，一人摆植物，一人摆僵尸。</p>
<h2 id="用户的注册和登录"><a href="#用户的注册和登录" class="headerlink" title="用户的注册和登录"></a>用户的注册和登录</h2><p>要有一张背景图，尺寸1400 * 600像素，设计几个按钮，显示登录，注册</p>
<p>比如，就像许多软件的登录注册</p>
<p>用户名输入框</p>
<p>密码输入框</p>
<p>  登录按钮</p>
<p>​                —没有账号？注册一个！</p>
<p>如果点击登录按钮，那么来到游戏主界面；如果点击注册按钮，来到注册界面。</p>
<p>注册时要求用户名不能重复，密码复杂度要求（自己设计）。点击注册按钮后，提示注册是否成功，如果失败，则提示失败。如果成功，则提示成功，然后回到登录界面。</p>
<p>以上为一个场景，登录界面、注册界面用不同的层来表示。</p>
<p>数据库的设计—mysql</p>
<p>目前需要保存用户名和密码，可以再添加一些胜率等信息</p>
<h2 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h2><p>数据库保存在linux服务器上，服务器上运行程序，接收来自客户端的tcp连接 ， 我们要在此处体现多线程，高并发</p>
<p>用python 的 async io来写？这是异步io，可能无法满足老师要求</p>
<p>处理客户端发来的sql查询，插入请求，将结果返回客户端。</p>
<p>当用户进行双人对战时，如何显示对方的信息。可以当对方每放一个植物/僵尸时，向服务器发送放植物的种类和位置，服务器发送给另一客户端</p>
<p>多线程？采用线程池</p>
<p>NO！采用python的async IO，可以减少很多不必要的麻烦。当然如果你的C++很好，并且可以很好的控制多线程的同步问题以及很好的使用TCP，也可以采用C++。</p>
<p>python的异步IO可以满足并发要求，利用python课学到的知识即可。</p>
<h3 id="需求："><a href="#需求：" class="headerlink" title="需求："></a>需求：</h3><h4 id="1、登录："><a href="#1、登录：" class="headerlink" title="1、登录："></a>1、登录：</h4><p><strong>不允许一个账号多人登录</strong></p>
<p>你会收到来自客户端的登录请求 </p>
<p>格式为 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOGIN;username;password;\n</span><br></pre></td></tr></table></figure>

<p>​        比如:    </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOGIN;zrf;123456;\n</span><br></pre></td></tr></table></figure>

<p>你需要根据收到的用户名和密码，查询sql数据库，并且返回登录成功或失败。</p>
<p>登录成功，返回  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOGIN;1;\n    </span><br></pre></td></tr></table></figure>

<p>登陆失败（用户名或密码错误） </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOGIN;0;\n</span><br></pre></td></tr></table></figure>

<p>账户已经登录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOGIN;2;\n</span><br></pre></td></tr></table></figure>



<h4 id="2、注册："><a href="#2、注册：" class="headerlink" title="2、注册："></a>2、注册：</h4><p>你会收到来自客户端的注册请求   </p>
<p>格式为  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REGISTER;username;password;\n</span><br></pre></td></tr></table></figure>

<p>  比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REGISTER;zrf;123456;\n</span><br></pre></td></tr></table></figure>

<p>根据得到的用户名和密码，查询用户名是否已经存在，</p>
<p>若存在，返回错误   </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REGISTER;0;\n  </span><br></pre></td></tr></table></figure>

<p> 如果不存在，注册成功，返回 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REGISTER;1;\n</span><br></pre></td></tr></table></figure>

<p> 并且把用户名密码存入数据库中</p>
<h4 id="3、匹配"><a href="#3、匹配" class="headerlink" title="3、匹配"></a>3、匹配</h4><p>当用户点击主界面的匹配按钮时，就会向服务器发送  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MATCH;\n</span><br></pre></td></tr></table></figure>

<p>再还未匹配到对手之前，用户可以点击取消匹配按钮，然后客户端重新回到主界面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CANCELMATCH;\n</span><br></pre></td></tr></table></figure>

<p>当匹配成功后，服务器向客户端发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MATCHSUCCESS;0;\n</span><br></pre></td></tr></table></figure>

<p>客户端收到后，则自己为植物</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MATCHSUCCESS;1;\n</span><br></pre></td></tr></table></figure>

<p>客户端收到后，则自己为僵尸</p>
<p>2020/11/14</p>
<p>由于程序切换场景时要加载很多东西，麻烦服务器在匹配好对手后，<strong>延迟3秒</strong>再向客户端发送MATCHSUCCESS信息  ？（是否可以在客户端解决这个问题）</p>
<p>同步问题，由于从匹配场景切换到对战场景需要加载好几秒中，并且不同电脑加载时间也不一样，为了同步两个客户端的信息，服务器需要在发送过MATCHSUCCESS信息后，<strong>过5秒后</strong>（这段时间留给客户端加载信息），向两个客户端<strong>同时</strong>发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">START;\n</span><br></pre></td></tr></table></figure>



<p>注意，服务器收到两个客户端的匹配请求后，要随机向其中一个客户端发送MATCHSUCCESS;0;向另一个客户端发送MATCHSUCCESS;1;</p>
<h4 id="4、对战过程"><a href="#4、对战过程" class="headerlink" title="4、对战过程"></a>4、对战过程</h4><p>两个客户端匹配成功后，服务器保持与这两个客户端的连接</p>
<p>每个客户端每隔0.5秒会向服务器发送自己方（植物方或僵尸方）的信息，以此来同步两个客户端</p>
<p>你不需要处理其中的内容，只需要将信息发送个另一个客户端</p>
<p>1、植物方，发送植物的信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PLANT:PeaShooter:x,y;Peashooter:x,y;.....\n</span><br></pre></td></tr></table></figure>

<p>2、僵尸端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ZOMBIE:NormalZombie:x,y;NormalZombie:x,y;......\n</span><br></pre></td></tr></table></figure>

<h4 id="5、比赛结果"><a href="#5、比赛结果" class="headerlink" title="5、比赛结果"></a>5、比赛结果</h4><p>如果一方获胜，则会向服务器发送；注意，失败方不会向服务器发送任何信息；注意，服务器判定第一次收到发送WIN的客户端是胜利方。如果客户端收到WIN则胜利了，如果客户端收到LOSE则失败。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WIN;\n</span><br></pre></td></tr></table></figure>

<p>判定那一方胜利后，向胜利的客户端发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WIN;\n</span><br></pre></td></tr></table></figure>

<p>然后服务器向失败的客户端发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LOSE;\n</span><br></pre></td></tr></table></figure>

<p>其中一个客户端收到LOSE后，再向服务器发送一个LOSE</p>
<p>这次比赛结束，服务器释放与这两个客户端的连接。</p>
<h4 id="6、TCP心跳包"><a href="#6、TCP心跳包" class="headerlink" title="6、TCP心跳包"></a>6、TCP心跳包</h4><p>客户端每隔一秒向服务器发送一个心跳包，内容为，服务器每隔一段时间也向客户端发送同样的内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HeartBeat;\n</span><br></pre></td></tr></table></figure>

<h4 id="7、同步方案"><a href="#7、同步方案" class="headerlink" title="7、同步方案"></a>7、同步方案</h4><p>以植物方的为准，植物方决定僵尸何时行走、攻击、掉头、死亡，以及僵尸的位置。</p>
<p>僵尸方不进行任何计算，只展示僵尸的位置和动作。</p>
<p>植物方植物死亡时，向僵尸方发送植物死亡的信息。</p>
<h2 id="ISSUE"><a href="#ISSUE" class="headerlink" title="ISSUE"></a>ISSUE</h2><p>1、土豆地雷只能炸死完全重合的多只僵尸，邻近的僵尸不能同时炸死</p>
<p>​    //目前只能炸掉一个僵尸，以后再做调整</p>
<p>2、土豆地雷的价格为25，每次应该减去25  <strong>已解决</strong></p>
<p>3、僵尸掉头动作与前进动作一块执行时，会发生闪烁，是否要删除僵尸死亡动画？</p>
<p>4、缓存？每当创建一个精灵时，都是从硬盘里读plist，是否应该做成缓存以加快图片绘制速度？</p>
<p>5、食人花吃僵尸时，僵尸会停顿一下，主要原因是把僵尸从总僵尸数组中删除了，于是僵尸就停止运动了   <strong>已解决</strong> 2020/11/16</p>
]]></content>
  </entry>
  <entry>
    <title>算法笔记笔记</title>
    <url>/2020/09/12/%E7%AE%97%E6%B3%95%E7%AC%94%E8%AE%B0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="第二章"><a href="#第二章" class="headerlink" title="第二章"></a>第二章</h2><p>1、用double, 不用 float, double的精度为15-16位， float 的精度为6-7位</p>
<p>2、c语言用字符数组保存字符串    字符串常量使用双引号标注的字符集合     char str[30] = “wo ai zhong guo”;</p>
<p>3、尽量不要使用宏定义（#define）定义除了定义常量之外的事情</p>
<p>4、i ++ 先使用i再将i加一        ++ i 先将i加一再使用i</p>
<p>5、条件运算符（?   :）三目运算符    A ? B : C     判断A， 如果为真，执行B，如果为假，执行C</p>
<p>6、int的上限为2的32次方减1            INT_MAX =（1 &lt;&lt; 31）- 1 = 2147483647    左移相当于乘法</p>
<p>7、^ 运算符 异或 相异为1， 相同为0</p>
<p>8、连续等号 m = n = 10      赋值m, n均为10</p>
<p>9、scanf(“%d:%d:%d”, &amp;hour, &amp;minute, &amp;second);                10:27:54    scanf中的双引号内容就是整个输入</p>
<p>​      scanf(“%d,%lf,%d”, &amp;a, &amp;b, &amp;c);                    输入数据：12,17.2,23</p>
<p>10、除%c之外，scanf对其他格式符的输入是以空白符（空格、Tab）为结束判断标志的</p>
<p>​        注意，scanf的%c格式是可以读入空格跟空行的</p>
<p>​                scanf(“%d%c%s”, &amp;a, &amp;ch, &amp; str);            输入：8 q nihao            结果： a = 8; ch =  ; str = q;</p>
<p>​        所以，读入字符时，最好用字符串的方式读入，比如读入一个字符，int st[2]; scanf(“%s”, st);//%s遇到空格就会停止读入</p>
<p>11、%.mf，让浮点数保留m位进行输出</p>
<p>12、getchar()用来输入单个字符， putchar用来输出单个字符</p>
<p>13、typedef 给数据类型起一个别名      如 ：typedef long long LL;</p>
<p>14、常用math函数</p>
<p>​                fabs(double x)  对double变量取绝对值</p>
<p>​                floor(double x) 对double变量向下取整            ceil(double x) double变量向上取整</p>
<p>​                double pow(double a, double b) 计算a的b次方，参数和返回值都是double</p>
<p>​                double sqrt(double x)  计算x的算术平方根， 参数和返回值均为double</p>
<p>​                double log(double x) 计算x以自然对数为底的对数</p>
<p>​                sin(double x)    cos(double x)    tan(double x)  参数和返回值都是double</p>
<p>15、每个case后，必须加上break，否则执行完该case后，不会break，会继续向下执行，执行下面的case</p>
<p>16、一维数组初始化 int a[10] = {0}; 注意 int a[10] = {1} 不会将数组全初始化为1！memset(a, 1, sizeof a) 依然不能将数组置为1，memset按字节对内存进行初始化，所以内存里存的其实是0x0101 0101……，也就是16843009。</p>
<p>17、建议只用memset置0或者-1.memset是按字节赋值</p>
<p>18、gets用来输入一行字符串，注意识别\n作为输入结束标志</p>
<p>19、字符数组以\0结尾，开字符数组的时候一定要至少比要存储的字符串长度多1，int数组则不需要多1</p>
<p>20、如果不是用scanf的%s或者gets输入字符串的，则务必要在字符串后加上\0</p>
<p>21、strlen, 注意返回类型是无符号整型（unsigned int），strlen(str) &lt; -1可能为真， 无符号数和有符号数比较大小时，会转换为无符号数比较</p>
<p>22、strcmp(字符串1， 字符串2) 按照字典序比较， 如果等于，返回0，如果大于，返回正整数，如果小于，返回负整数</p>
<p>23、strcpy(字符数组1， 字符数组2) ，把字符数组2赋给字符数组1</p>
<p>24、strcat(字符数组1， 字符数组2)，把字符数组2接在字符数组1后面</p>
<p>25、数组作为函数的参数，int func(int a[], int b[][5] [] [8]), 注意 二维数组的第二维需要填写个数</p>
<p>26、在函数中对数组修改就相当于对原数组修改</p>
<p>27、指针是一个unsigned类型的整数</p>
<p>28、浮点数的比较</p>
<p>​                const double esp = 1e-8</p>
<p>​                if(fabs(a - b) &lt; esp)  则可说明两个浮点数相等</p>
<p>29、const double pi = acos(-1.0)</p>
<p>30、while(scanf(“%d”, &amp;a) != EOF) 如果没有读到文件末尾，就继续读</p>
<p>31、while(gets(str) != NULL) 使用gets读取字符串时</p>
<h2 id="第三章"><a href="#第三章" class="headerlink" title="第三章"></a>第三章</h2><p>1、简单模拟：不需要什么算法，题目怎么说，我就怎么做，就好像把题目翻译成了代码语言</p>
<p>2、闰年：if ((year % 4 == 0 &amp;&amp; year %100 != 0)  || (year % 400 == 0))</p>
<p>3、product ：乘积</p>
<h2 id="第四章"><a href="#第四章" class="headerlink" title="第四章"></a>第四章</h2><p>​    </p>
]]></content>
  </entry>
  <entry>
    <title>2020-2021算法设计与分析期中考试参考答案</title>
    <url>/2020/11/10/%E7%AE%97%E6%B3%95%E7%AD%94%E6%A1%88/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="2020-2021算法设计与分析期中考试参考答案"><a href="#2020-2021算法设计与分析期中考试参考答案" class="headerlink" title="2020-2021算法设计与分析期中考试参考答案"></a>2020-2021算法设计与分析期中考试参考答案</h1><h3 id="一、写出O，Θ，Ω的含义"><a href="#一、写出O，Θ，Ω的含义" class="headerlink" title="一、写出O，Θ，Ω的含义"></a>一、写出O，Θ，Ω的含义</h3><p>O(g(n)) = {f(n):  存在正常量c和n0，使得对所有n≥ n0，有0≤f(n)≤cg(n)}</p>
<p>Θ(g(n)) = {f(n):  存在正常量c1、c2和n0，使得对所有n≥ n0，有c1g(n)≤f(n)≤c2g(n)}</p>
<p>Ω(g(n)) = {f(n):  存在正常量c和n0，使得对所有n≥ n0，有f(n)≥cg(n)≥0}</p>
<h3 id="二、写出快速排序的Partition方法"><a href="#二、写出快速排序的Partition方法" class="headerlink" title="二、写出快速排序的Partition方法"></a>二、写出快速排序的Partition方法</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Partition</span><span class="params">(<span class="keyword">int</span> q[], <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x = q[(l + r) &gt;&gt; <span class="number">1</span>], i = l - <span class="number">1</span>, j = r + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; j)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(q[++i] &lt; x);</span><br><span class="line">        <span class="keyword">while</span>(q[--j] &gt; x);</span><br><span class="line">        <span class="keyword">if</span>(i &lt; j)</span><br><span class="line">            <span class="built_in">std</span>::swap(q[i], q[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>附：快速排序</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1000010</span>;</span><br><span class="line"><span class="keyword">int</span> q[N];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quick_sort</span><span class="params">(<span class="keyword">int</span> q[], <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l &gt;= r) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//一、确定边界点，一般是左边界q[l]，中间值q[l + r &gt;&gt; 1]，右边界q[r]，或者随机取</span></span><br><span class="line">    <span class="keyword">int</span> x = q[l + r &gt;&gt; <span class="number">1</span>], i = l - <span class="number">1</span>, j = r + <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//二、调整区间，根据边界点的值x将整个区间分为两部分，使得左半边所有数均小于等于x，右半边所有数均大于等于x</span></span><br><span class="line">    <span class="keyword">while</span>(i &lt; j)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span>(q[++i] &lt; x);<span class="comment">//从左边开始，找出第一个大于等于x的数</span></span><br><span class="line">        <span class="keyword">while</span>(q[--j] &gt; x);<span class="comment">//从右边开始，找出第一个小于等于x的数</span></span><br><span class="line">        <span class="keyword">if</span>(i &lt; j)</span><br><span class="line">            <span class="built_in">std</span>::swap(q[i], q[j]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//三、递归处理左右两个区间</span></span><br><span class="line">    quick_sort(q, l, j);</span><br><span class="line">    quick_sort(q, j + <span class="number">1</span>, r);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;q[i]);</span><br><span class="line">    quick_sort(q, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, q[i]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="三、按照渐进阶从低到高的顺序排列以下表达式："><a href="#三、按照渐进阶从低到高的顺序排列以下表达式：" class="headerlink" title="三、按照渐进阶从低到高的顺序排列以下表达式："></a>三、按照渐进阶从低到高的顺序排列以下表达式：</h3><p>$$<br>4n^2, logn, 3^n, 20n, 2, n^{2/3}, n!<br>$$</p>
<p>答案：<br>$$<br>2, logn, n^{2/3}, 20n, 4n^2, 3^n, n!<br>$$</p>
<h3 id="四、逆序对"><a href="#四、逆序对" class="headerlink" title="四、逆序对"></a>四、逆序对</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="comment">//逆序对</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1000010</span>;</span><br><span class="line"><span class="keyword">int</span> q[N], temp[N];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">reverse_pair</span><span class="params">(<span class="keyword">int</span> q[], <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l &gt;= r) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = l + r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> res = reverse_pair(q, l, mid) + reverse_pair(q, mid + <span class="number">1</span>, r);</span><br><span class="line">    <span class="keyword">int</span> i = l, j = mid + <span class="number">1</span>, k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= mid &amp;&amp; j &lt;= r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (q[i] &lt;= q[j]) temp[k++] = q[i++];</span><br><span class="line">        <span class="keyword">else</span> temp[k++] = q[j++], res += mid - i + <span class="number">1</span>;<span class="comment">//仅此处与归并排序不同</span></span><br><span class="line">        <span class="comment">/*左边和右边均已排好序，如果q[i] &gt; q[j]，那么i~mid之间的数字都会大于q[j],所以</span></span><br><span class="line"><span class="comment">        *对于左边第i个数，右边有mid - i + 1个数小于q[i]，逆序对数量要加上mid - i + 1</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= mid) temp[k++] = q[i++];</span><br><span class="line">    <span class="keyword">while</span> (j &lt;= r) temp[k++] = q[j++];</span><br><span class="line">    <span class="keyword">for</span>(i = l, k = <span class="number">0</span>; i &lt;= r; i++, k++) q[i] = temp[k];</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;q[i]);</span><br><span class="line">    <span class="keyword">int</span> res = reverse_pair(q, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>复杂度分析 T(n) = 2T(n / 2) + O(n)</p>
<p>由主定理得：T(n) = O(nlogn)</p>
<p>附：归并排序</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">1000010</span>;</span><br><span class="line"><span class="keyword">int</span> q[N], temp[N];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge_sort</span><span class="params">(<span class="keyword">int</span> q[], <span class="keyword">int</span> l, <span class="keyword">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(l &gt;= r) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">int</span> mid = l + r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    merge_sort(q, l, mid);<span class="comment">//左边排序</span></span><br><span class="line">    merge_sort(q, mid + <span class="number">1</span>, r);<span class="comment">//右边排序</span></span><br><span class="line">    <span class="keyword">int</span> i = l, j = mid + <span class="number">1</span>, k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= mid &amp;&amp; j &lt;= r)<span class="comment">//合并，依次比较左右两边的数，较小的填入temp数组中</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(q[i] &lt;= q[j]) temp[k++] = q[i++];<span class="comment">//为了保证归并排序的稳定性，如果左右两边有相同的数，那么把左边的数先放入temp数组中</span></span><br><span class="line">        <span class="keyword">else</span> temp[k++] = q[j++];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= mid) temp[k++] = q[i++];<span class="comment">//将左边剩余的数填入temp数组中</span></span><br><span class="line">    <span class="keyword">while</span>(j &lt;= r) temp[k++] = q[j++];<span class="comment">//将右边剩余的数字填入temp数组中</span></span><br><span class="line">    <span class="keyword">for</span>(i = l, k = <span class="number">0</span>; i &lt;= r; i++, k++) q[i] = temp[k];<span class="comment">//将temp的数组移到原来的数组中</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;q[i]);</span><br><span class="line">    merge_sort(q, <span class="number">0</span>, n - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) <span class="built_in">printf</span>(<span class="string">&quot;%d &quot;</span>, q[i]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="五、摆花"><a href="#五、摆花" class="headerlink" title="五、摆花"></a>五、摆花</h3><p>设f[i][j]表示前i个<strong>花瓶</strong>里放了j朵花的最大价值，对于第i个花瓶，只有放与不放两种选择</p>
<p>状态转移方程：<br>$$<br>f[i][j] = max(f[i - 1][j], f[i - 1][j - 1] + w[j][i])<br>$$<br>时间复杂度O(mn)，假设价值均大于0</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">10010</span>;</span><br><span class="line"><span class="keyword">int</span> w[N][N], f[N][N];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m, n;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;m, &amp;n);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n; j++)</span><br><span class="line">            <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;w[i][j]);</span><br><span class="line">    <span class="comment">//f[i][j]表示前i个花瓶里放前j束花的价值</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= <span class="built_in">std</span>::min(m, i); j++)</span><br><span class="line">            f[i][j] = <span class="built_in">std</span>::max(f[i - <span class="number">1</span>][j], f[i - <span class="number">1</span>][j - <span class="number">1</span>] + w[j][i]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, f[n][m]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>计算机基础知识</title>
    <url>/2020/09/15/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>字：计算机一次存取、加工、传送的数据长度称为字</p>
<p>字长：计算机每个字所包含的位数称为字长</p>
<h2 id="ROM"><a href="#ROM" class="headerlink" title="ROM"></a>ROM</h2><p>掩膜只读存储器（Mask ROM）：掉电后依然存在，可靠性高。缺点是信息只能一次写入（在制造的过程中），不灵活</p>
<p>可编程只读存储器（PROM）：允许用户通过专用的色号被一次性写入自己所需要的东西，一般只可编程一次</p>
<p>可编程可擦除只读存储器（EPROM）：可读可写，用紫外线或脉冲电流先将原有的信息擦除，然后重新写入</p>
<p>电可擦除可编程只读存储器（EEPROM）：随时可以写入而无需擦除原先内容</p>
<p>快擦除读写存储器（Flash）：闪存，广泛用于制作各种移动存储器，如U盘以及存储卡</p>
<p>严格意义上：机械硬盘不属于ROM</p>
<p>固态硬盘和U盘属于ROM</p>
<h2 id="RAM"><a href="#RAM" class="headerlink" title="RAM"></a>RAM</h2><p>SRAM：静态随机存储器，利用双稳态触发器来存储信息，即使信息被读出后，它仍保持其原状态而不需要再生（非破坏性读出）。SRAM存取速度快，但是集成度低，功耗大，价格昂贵（价格是DRAM的几十倍），一般用来组成高速缓冲存储器。</p>
<p>DRAM：动态随机存储器是利用存储元电路中的栅极电容上的电荷来存储信息的，电容上的电荷一般只能维持1-2ms，即使电源不断电，信息也会自动消失，因此每隔一段时间需要刷新。</p>
<p>打开任务管理器即可看到L1、L2、L3缓存</p>
<h2 id="机械硬盘"><a href="#机械硬盘" class="headerlink" title="机械硬盘"></a>机械硬盘</h2><p>HDD，数据通过离磁性表面很近的磁头由电磁流来改变极性的方式被写入到磁盘上</p>
<p>接口：一种是IDE，一种是SATA，现在大多数都是SATA</p>
<p>固态硬盘接口：市面上销售的大多是m.2接口和sata接口</p>
<h2 id="BIOS"><a href="#BIOS" class="headerlink" title="BIOS"></a>BIOS</h2><p>基本输入输出系统，预安装在个人电脑的主板上，是个人电脑启动时加载的第一个软件。现在，BIOS的作用是初始化和测试<a href="https://zh.wikipedia.org/wiki/%E7%A1%AC%E9%AB%94">硬件</a>组件，以及从大容量存储设备（如硬盘）加载<a href="https://zh.wikipedia.org/wiki/%E5%95%9F%E5%8B%95%E7%A8%8B%E5%BC%8F">引导程序</a>，并由<a href="https://zh.wikipedia.org/wiki/%E5%95%9F%E5%8B%95%E7%A8%8B%E5%BC%8F">引导程序</a>加载操作系统。现在BIOS大多存储在flash芯片上。</p>
<p>以前BIOS存储在CMOS中，没电信息就会丢失。</p>
<p>CMOS中存储的内容掉电就会丢失，主板上通常有一块电池给CMOS供电。电脑关机后，过段时间再开机，发现时间依然是正确的，这就是这快电池在为时钟模块供电</p>
<h2 id="大端法-小端法"><a href="#大端法-小端法" class="headerlink" title="大端法/小端法"></a>大端法/小端法</h2><p>假设一个int型变量x的地址为0x100,那么x的4个字节将被存储在内存的0x100,0x101,0x102,0x103的位置。</p>
<p>字节序即为多字节对象在内存中的字节顺序</p>
<p>大端法：</p>
<p>最高有效字节在最前面的方式称为大端法，假设x的值为0x12345678。对于大端法的机器来说</p>
<p>0x100:12    0x101:34    0x102:56    0x103:78</p>
<p>小端法：</p>
<p>0x100:78    0x101:56    0x102:34    0x103:12</p>
<h2 id="括弧匹配"><a href="#括弧匹配" class="headerlink" title="括弧匹配"></a>括弧匹配</h2><p>1、任意前缀中，左括号数量大于右括号数量</p>
<p>2、左右括号数量相等</p>
<h2 id="KMP"><a href="#KMP" class="headerlink" title="KMP"></a>KMP</h2><p>next[i] :在str[1~i]中，前缀和后缀相等的最长子串的长度</p>
<h2 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h2><p>1s可以算10的7次方到10的8次方次</p>
<h2 id="电脑开机过程"><a href="#电脑开机过程" class="headerlink" title="电脑开机过程"></a>电脑开机过程</h2>]]></content>
  </entry>
  <entry>
    <title>1.两数之和</title>
    <url>/2021/01/05/hot-100/1.%E4%B8%A4%E6%95%B0%E4%B9%8B%E5%92%8C/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="解法1-暴力"><a href="#解法1-暴力" class="headerlink" title="解法1    暴力"></a>解法1    暴力</h2><p>首先最容易想到的就是O(n^2)的做法，非常简单，枚举第一个数，然后对每一个数遍历所有数字。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">twoSum</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.size(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; nums.size(); j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(i != j)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(nums[i] + nums[j] == target)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">return</span> &#123;i, j&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="解法2-排序-双指针"><a href="#解法2-排序-双指针" class="headerlink" title="解法2    排序+双指针"></a>解法2    排序+双指针</h2><p>复杂度O(nlogn)，首先排序，然后用双指针从两头向中间扫描。如果和大于target，那么j指针–，如果小于target，i指针++。如果相等，表明找到了，然后再<strong>原数组</strong>中找到下标即可。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">twoSum</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> temp = nums;</span><br><span class="line">        sort(nums.begin(), nums.end());</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j = nums.size() - <span class="number">1</span>; i &lt; j ;)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> t = nums[i] + nums[j];</span><br><span class="line">            <span class="keyword">if</span>(t &lt; target) i++;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(t &gt; target) j--;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> n, m;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; temp.size(); k++)</span><br><span class="line">                    <span class="keyword">if</span>(temp[k] == nums[i]) </span><br><span class="line">                    &#123;   </span><br><span class="line">                        n = k; </span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> k = nums.size() - <span class="number">1</span>; k &gt;= <span class="number">0</span>; k--)</span><br><span class="line">                    <span class="keyword">if</span>(temp[k] == nums[j]) </span><br><span class="line">                    &#123;</span><br><span class="line">                        m = k; </span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">return</span> &#123;n, m&#125;;</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h2 id="解法3-哈希表"><a href="#解法3-哈希表" class="headerlink" title="解法3    哈希表"></a>解法3    哈希表</h2><p>哈希表，时间复杂度为O(n)</p>
<p>unordered_map底层实现为哈希表，插入查询操作复杂度为O(1); map底层实现为平衡树，插入查询操作复杂度均为O(logn);</p>
<p>我们遍历第二个数，然后找第一个数是否出现过。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; <span class="title">twoSum</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums, <span class="keyword">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; hash;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.size(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> t = target - nums[i];</span><br><span class="line">            <span class="keyword">if</span>(hash.count(t))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> &#123;hash[t], i&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            hash[nums[i]] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
  <entry>
    <title>质数</title>
    <url>/2020/09/12/%E8%B4%A8%E6%95%B0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="质数"><a href="#质数" class="headerlink" title="质数"></a>质数</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>在大于1的整数中，如果只包含1和本身这两个约数，就被称为质数（素数）</p>
<h3 id="质数的判定–试除法"><a href="#质数的判定–试除法" class="headerlink" title="质数的判定–试除法"></a>质数的判定–试除法</h3><p>时间复杂度O(n)</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">is_prime</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(n &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i&lt; n; i ++) &#123;</span><br><span class="line">		<span class="keyword">if</span>(n % i == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若d|n,则（n/d)|n,不妨设d &lt;= n/d,则d2 &lt;= n,则d&lt;=根号n</p>
<p>那么d只需要枚举到根号n，时间复杂度O(根号n)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">is_prime</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(n &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n / i; i ++) &#123;</span><br><span class="line">    <span class="comment">//注意 写法 i &lt;= sqrt(n)，每次都要执行开方函数，速度较慢</span></span><br><span class="line">    <span class="comment">//写法 i * i &lt;= n， 存在溢出风险</span></span><br><span class="line">		<span class="keyword">if</span>(n % i == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分解质因数–试除法"><a href="#分解质因数–试除法" class="headerlink" title="分解质因数–试除法"></a>分解质因数–试除法</h3><p>从小到大枚举所有数</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n; i ++) &#123;</span><br><span class="line">		<span class="keyword">if</span>(n % i == <span class="number">0</span>) &#123;<span class="comment">//如果成立，则i一定是质数；若i不是质数，则i存在小于i并且大于1的因子k，1 &lt; k &lt; i,并且n % k == 0,</span></span><br><span class="line">            <span class="comment">//易证，k在该循环前一定被筛掉了，不可能是n的因子。</span></span><br><span class="line">			<span class="keyword">int</span> s = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span>(n%i==<span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				n /= i;</span><br><span class="line">				s ++;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;质因数:%d 个数:%d&quot;</span>,i,s);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>n中最多只包含一个大于根号n的质因子，如果有两个，则它们的乘积会大于n，不成立</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">divide</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= n / i; i ++) &#123;</span><br><span class="line">		<span class="keyword">if</span>(n % i == <span class="number">0</span>) &#123;<span class="comment">//如果成立，则i一定是质数；若i不是质数，则i存在小于i并且大于1的因子k，1 &lt; k &lt; i,并且n % k == 0,</span></span><br><span class="line">            <span class="comment">//易证，k在该循环前一定被筛掉了，不可能是n的因子。</span></span><br><span class="line">			<span class="keyword">int</span> s = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">while</span>(n%i==<span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				n /= i;</span><br><span class="line">				s ++;</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;质因数:%d 个数:%d\n&quot;</span>,i,s);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(n &gt; <span class="number">1</span>) <span class="built_in">printf</span>(<span class="string">&quot;质因数:%d 个数:%d\n&quot;</span>,n,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
  </entry>
  <entry>
    <title>10. 正则表达式匹配</title>
    <url>/2021/01/08/hot-100/10.%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8C%B9%E9%85%8D/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>本题难度较高，以后再写</p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
  <entry>
    <title>11. 盛最多水的容器</title>
    <url>/2021/01/08/hot-100/11.%E7%9B%9B%E6%9C%80%E5%A4%9A%E6%B0%B4%E7%9A%84%E5%AE%B9%E5%99%A8/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="解法一-暴力"><a href="#解法一-暴力" class="headerlink" title="解法一    暴力"></a>解法一    暴力</h2><p>暴力很简单，只需要遍历每一组$i, j$，然后计算出$(j - i) * min(height[i], height[j])$即可</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxArea</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; height.size() - <span class="number">1</span>; i++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i + <span class="number">1</span>; j &lt; height.size(); j++)</span><br><span class="line">                <span class="keyword">if</span>((j - i) * min(height[i], height[j]) &gt; res)</span><br><span class="line">                    res = (j - i) * min(height[i], height[j]);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="解法二-双指针"><a href="#解法二-双指针" class="headerlink" title="解法二    双指针"></a>解法二    双指针</h2><p>两个指针$i, j$分别指向数组头和尾，比较两个值的大小，如果$i$的值较小，那么把$i$往后移；如果$j$的值较小，那么把$j$往前移。</p>
<p>为什么这么做呢？假如$i$的值小于$j$的值，如果把$j$往前移，那么$i$和$j$之间的距离就会变小，高度呢？肯定是小于等于$i$的值的，根据计算公式<br>$$<br>(j - i) * min(height[i], height[j])<br>$$<br>该结果肯定会减小。因此将i向后移动，才可能找出最优解。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxArea</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j = height.size() - <span class="number">1</span>; i &lt; j;)</span><br><span class="line">        &#123;</span><br><span class="line">            res = max(res, (j - i) * min(height[i], height[j]));</span><br><span class="line">            <span class="keyword">if</span>(height[i] &lt; height[j]) i++;</span><br><span class="line">            <span class="keyword">else</span> j--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
  <entry>
    <title>2.两数相加</title>
    <url>/2021/01/05/hot-100/2.%E4%B8%A4%E6%95%B0%E7%9B%B8%E5%8A%A0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>最简单的想法是把两个链表都转换为数字，然后相加，再把结果转换成链表，直接想出来的做法一般都有缺点。</p>
<p><strong>不能</strong>转换成数字再求和，这样会有问题，如果链表的位数特别大以至于int、long无法表示怎么办呢？回想一下小学算术，我们只要模拟一下加法运算就可以了。</p>
<p>t表示进位，为1或0，最开始为0。每位上的和为a+b+t，然后该数模十就是结果，该数除以10的商就是进位。</p>
<p>需要特判头节点的时候，才可能会用到虚拟头节点。</p>
<p>本题如果不用虚拟头节点的话，那么在插入第一个节点的时候需要特判一下，因为此时链表还没有建立起来，需要特判一下，建立起来链表。</p>
<p>用上虚拟头节点就方便许多了，在循环中不需要特叛了。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * struct ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode *next;</span></span><br><span class="line"><span class="comment"> *     ListNode() : val(0), next(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) : val(x), next(nullptr) &#123;&#125;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x, ListNode *next) : val(x), next(next) &#123;&#125;</span></span><br><span class="line"><span class="comment"> * &#125;;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">ListNode* <span class="title">addTwoNumbers</span><span class="params">(ListNode* l1, ListNode* l2)</span> </span>&#123;、</span><br><span class="line">        <span class="comment">//设置一个虚拟头节点，方便</span></span><br><span class="line">        <span class="keyword">auto</span> dummy = <span class="keyword">new</span> ListNode(<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">auto</span> current = dummy;</span><br><span class="line">        <span class="keyword">int</span> t = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//如果l1每遍历完，或者l2没遍历完，或者t不为0</span></span><br><span class="line">        <span class="keyword">while</span>(l1 || l2 || t)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(l1) t += l1-&gt;val, l1 = l1 -&gt; next;</span><br><span class="line">            <span class="keyword">if</span>(l2) t += l2-&gt;val, l2 = l2 -&gt; next;</span><br><span class="line">            current-&gt;next = <span class="keyword">new</span> ListNode(t % <span class="number">10</span>);</span><br><span class="line">            t /= <span class="number">10</span>;</span><br><span class="line">            current = current -&gt; next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dummy-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
  <entry>
    <title>3.无重复字符的最长子串</title>
    <url>/2021/01/06/hot-100/3.%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E6%9C%80%E9%95%BF%E5%AD%90%E4%B8%B2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>我们可以把所有子串都找出来，有n + n - 1 + n - 2 + … + 1种，然后筛出其中没有重复字符的子串，然后再从中选出一个最长的即可，判断子串中是否含有重复字符需要O(n)的时间，这样的时间复杂度为O(n^3)</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">notMultChar</span><span class="params">(<span class="built_in">string</span> &amp; s, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">unordered_set</span>&lt;<span class="keyword">char</span>&gt; heap;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> k = i; k &lt;= j; k++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(heap.count(s[k]))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            heap.insert(s[k]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(<span class="built_in">string</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.size(); i++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i; j &lt; s.size(); j++)</span><br><span class="line">            &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(notMultChar(s, i, j))</span><br><span class="line">                    res = max(res, j - i + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>我们只需要枚举出没有重复字符的子串就可以了。我们采用双指针算法，将所有情况分为这几类，以第0个，第1个，…，第n - 1个字符结尾最长的没有重复字符的子串。用指针i表示后面的一个指针，指针j表示是从j到i最长的没有重复字符的子串。如何判断是否有重复字符呢？根据单调性！对于一个已经确定好的i，再确定i + 1(i’)时，j’的位置如何确定，显然，j’的位置一定在j的右边或者j的位置上，用反证法很容易证明。这样，在扫描时，i和j指针都会向前移动，这样的时间复杂度为O(n)。当i移动到下一个位置时，i + 1只可能与j右边的数重复，将j后移直到没有重复字符为止。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(<span class="built_in">string</span> s)</span></span>&#123;</span><br><span class="line">        <span class="built_in">unordered_map</span>&lt;<span class="keyword">char</span>, <span class="keyword">int</span>&gt; heap;</span><br><span class="line">        <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; s.size(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            heap[s[i]]++;</span><br><span class="line">            <span class="keyword">while</span>(heap[s[i]] &gt; <span class="number">1</span>) heap[s[j++]]--;</span><br><span class="line">            res = max(res, i - j + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
  <entry>
    <title>4. 寻找两个正序数组的中位数</title>
    <url>/2021/01/07/hot-100/4.%E5%AF%BB%E6%89%BE%E4%B8%A4%E4%B8%AA%E6%AD%A3%E5%BA%8F%E6%95%B0%E7%BB%84%E7%9A%84%E4%B8%AD%E4%BD%8D%E6%95%B0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="解法一-暴力解法"><a href="#解法一-暴力解法" class="headerlink" title="解法一    暴力解法"></a>解法一    暴力解法</h2><p>这种解法非常好想，根据题意就能想出来。我们可以合并数组，然后找出这个新数组的中位数。如何合并呢？我们可以借鉴归并排序的合并，时间复杂度为O(n)，然后找出中位数即可。（如果长度为偶数找出中间两个数的平均值）</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums1, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; nums3;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(i &lt; nums1.size() &amp;&amp; j &lt; nums2.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums1[i] &lt;= nums2[j]) nums3.push_back(nums1[i++]);</span><br><span class="line">            <span class="keyword">else</span> nums3.push_back(nums2[j++]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(i &lt; nums1.size()) nums3.push_back(nums1[i++]);</span><br><span class="line">        <span class="keyword">while</span>(j &lt; nums2.size()) nums3.push_back(nums2[j++]);</span><br><span class="line">        <span class="keyword">int</span> k = nums3.size() / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(nums3.size() % <span class="number">2</span> == <span class="number">0</span>) <span class="keyword">return</span> (nums3[k] + nums3[k - <span class="number">1</span>]) / <span class="number">2.0</span>;</span><br><span class="line">        <span class="keyword">return</span> nums3[k];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是题目中要求的复杂度为O(log (m+n))，看来我们还需要想出更好的解法。</p>
<h2 id="解法二-对解法一的优化"><a href="#解法二-对解法一的优化" class="headerlink" title="解法二    对解法一的优化"></a>解法二    对解法一的优化</h2><p>在合并数组时，我们是不是已经直到中位数是谁了，只需要在合并时找出第( nums1.size() + nums2.size() ) / 2的数字即可。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums1, <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> k = (nums1.size() + nums2.size()) / <span class="number">2</span>;        </span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; nums3;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>, cnt = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">while</span>(i &lt; nums1.size() &amp;&amp; j &lt; nums2.size())</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(nums1[i] &lt;= nums2[j]) nums3.push_back(nums1[i++]);</span><br><span class="line">            <span class="keyword">else</span> nums3.push_back(nums2[j++]);</span><br><span class="line">            <span class="keyword">if</span>(cnt == k)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(cnt != k)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span>(i &lt; nums1.size())</span><br><span class="line">            &#123;</span><br><span class="line">                nums3.push_back(nums1[i++]);</span><br><span class="line">                <span class="keyword">if</span>(cnt == k) <span class="keyword">break</span>;</span><br><span class="line">                cnt++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span>(j &lt; nums2.size())</span><br><span class="line">            &#123;</span><br><span class="line">                nums3.push_back(nums2[j++]);</span><br><span class="line">                <span class="keyword">if</span>(cnt == k) <span class="keyword">break</span>;</span><br><span class="line">                cnt++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>((nums1.size() + nums2.size()) % <span class="number">2</span> == <span class="number">0</span>) <span class="keyword">return</span> (nums3[k] + nums3[k - <span class="number">1</span>]) / <span class="number">2.0</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> nums3[k];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样比解法一稍微快了一些，但是复杂度依旧为O(n)，没有达到题目要求。</p>
<h2 id="解法三"><a href="#解法三" class="headerlink" title="解法三"></a>解法三</h2><p>为了达到log的复杂度，显然我们不能遍历每个元素，应该使用类似二分的方法。我们分别取数组一的中位数i和数组二的中位数j。</p>
<p><strong>难度较高，以后再写</strong></p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
  <entry>
    <title>5. 最长回文子串</title>
    <url>/2021/01/07/hot-100/5.%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="解法一-暴力"><a href="#解法一-暴力" class="headerlink" title="解法一    暴力"></a>解法一    暴力</h2><p>本题一开始觉得还挺难的，因为要遍历所有子串，然后判断子串是不是回文串。这样暴力做法也是可以的，找出所有子串，然后再判断是不是回文串，复杂度为O(n^3)</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">isPalindrome</span><span class="params">(<span class="built_in">string</span> &amp; s, <span class="keyword">int</span> i , <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">while</span>(i &lt; j)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(s[i] != s[j]) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            i++;</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">longestPalindrome</span><span class="params">(<span class="built_in">string</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">string</span> res;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.size(); i++)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i; j &lt; s.size(); j++)</span><br><span class="line">                <span class="keyword">if</span>(res.size() &lt; j - i + <span class="number">1</span> &amp;&amp; isPalindrome(s, i, j) )</span><br><span class="line">                   res =  s.substr(i, j - i + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="解法二-中心扩散"><a href="#解法二-中心扩散" class="headerlink" title="解法二    中心扩散"></a>解法二    中心扩散</h2><p>仔细想想，我们如何判断一个字串是不是回文串的。回文串有两种类型，长度为奇数和长度为偶数的串。我们遍历每一个字符，并且把该字符当做回文串的中心，然后向两边拓展，找到最长的回文串。</p>
<p>时间复杂度为O(n^2)</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">longestPalindrome</span><span class="params">(<span class="built_in">string</span> s)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">string</span> res;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; s.size(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> l = i - <span class="number">1</span>, r = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(l &gt;= <span class="number">0</span> &amp;&amp; r &lt; s.size() &amp;&amp; s[l] == s[r]) l--, r++;</span><br><span class="line">            <span class="keyword">if</span>(res.size() &lt; r - l - <span class="number">1</span>) res = s.substr(l + <span class="number">1</span>, r - l - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            l = i, r = i + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(l &gt;= <span class="number">0</span> &amp;&amp; r &lt; s.size() &amp;&amp; s[l] == s[r]) l--, r++;</span><br><span class="line">            <span class="keyword">if</span>(res.size() &lt; r - l - <span class="number">1</span>) res = s.substr(l + <span class="number">1</span>, r - l - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
  <entry>
    <title>Python程序设计作业#6</title>
    <url>/2020/11/30/py6-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计-6作业"><a href="#Python程序设计-6作业" class="headerlink" title="Python程序设计#6作业"></a>Python程序设计#6作业</h1><p>截止时间：2020年11月30日23:59:59</p>
<h2 id="作业题目"><a href="#作业题目" class="headerlink" title="作业题目"></a>作业题目</h2><p>在作业#5的基础上实现localProxy的图形管理界面localGui</p>
<p>localGui单独一个源文件</p>
<p>可通过图形界面（可以使用QDialog）关闭和开启localProxy</p>
<p>界面上提供remoteProxy的主机地址和端口、认证的用户名和密码（掩码显示）</p>
<p>建议使用QProcess类管理localProxy进程</p>
<p>可以实时查看localProxy的运行状态（是否运行、实时吞吐率）</p>
<p>localGui与localProxy之间采用WebSocket连接（localGui为client）</p>
<h2 id="localProxy代码"><a href="#localProxy代码" class="headerlink" title="localProxy代码"></a>localProxy代码</h2><p>localProxy代码嵌入下方的code block中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line"><span class="keyword">import</span> websockets</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line">VERSION = <span class="number">5</span></span><br><span class="line"></span><br><span class="line">gSendBandwidth = <span class="number">0.0</span></span><br><span class="line">gRecvBandwidth = <span class="number">0.0</span></span><br><span class="line">updateBytes = <span class="number">0</span></span><br><span class="line">downloadBytes = <span class="number">0</span></span><br><span class="line">remoteHost = <span class="string">&#x27;&#x27;</span></span><br><span class="line">remotePort = <span class="number">0</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">socks5</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    header = first + header</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> cmd == <span class="number">1</span>:</span><br><span class="line">            reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(remoteHost, remotePort)</span><br><span class="line">            http_connect = <span class="string">&#x27;CONNECT &#x27;</span> + address + <span class="string">&#x27;:&#x27;</span> + str(port[<span class="number">0</span>]) + <span class="string">&#x27; HTTP/1.1&#x27;</span></span><br><span class="line">            print(<span class="string">&#x27;http_connect&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">            print(http_connect)</span><br><span class="line">            writer_remote.write(http_connect.encode())</span><br><span class="line">            <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">            reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            writer.close()</span><br><span class="line">            writer.wait_closed()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> error:</span><br><span class="line">        logging.error(error)</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#第一个字节为0表示成功代理</span></span><br><span class="line">    <span class="keyword">if</span> cmd == <span class="number">1</span> <span class="keyword">and</span> reply[<span class="number">1</span>] == <span class="number">0</span>:</span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">global</span> updateBytes</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>) <span class="comment">#上传</span></span><br><span class="line">        updateBytes += len(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">global</span> downloadBytes</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>) <span class="comment"># 下载</span></span><br><span class="line">        downloadBytes += len(data)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">httptunnel</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = (first + http_connect).decode()</span><br><span class="line">    http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(remoteHost,remotePort)</span><br><span class="line">    writer_remote.write(http_connect.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    reply = <span class="keyword">await</span> (reader_remote.read(<span class="number">1024</span>))</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    <span class="comment">#连接建立成功</span></span><br><span class="line">    tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">reader, writer</span>):</span></span><br><span class="line">    first = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(first == <span class="string">b&#x27;\x05&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> socks5(first, reader, writer)</span><br><span class="line">    <span class="keyword">elif</span>(first == <span class="string">b&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> httptunnel(first, reader, writer)</span><br><span class="line"></span><br><span class="line">username = <span class="string">&#x27;&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># async def main():</span></span><br><span class="line"><span class="comment">#     global username, password</span></span><br><span class="line"><span class="comment">#     if(len(sys.argv) != 3):</span></span><br><span class="line"><span class="comment">#         logging.info(&#x27;usage: local-proxy.py username, password&#x27;)</span></span><br><span class="line"><span class="comment">#     else:</span></span><br><span class="line"><span class="comment">#         username = sys.argv[1]</span></span><br><span class="line"><span class="comment">#         password = sys.argv[2]</span></span><br><span class="line"><span class="comment">#     print(username)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#     print(password)</span></span><br><span class="line"><span class="comment">#     server = await asyncio.start_server(test, &#x27;0.0.0.0&#x27;, 10086)</span></span><br><span class="line"><span class="comment">#     async with server:</span></span><br><span class="line"><span class="comment">#         await server.serve_forever()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">localConsole</span>(<span class="params">ws, path</span>):</span></span><br><span class="line">    <span class="keyword">global</span> gSendBandwidth <span class="comment">#全局变量，表示当前上传带宽</span></span><br><span class="line">    <span class="keyword">global</span> gRecvBandwidth <span class="comment">#全局变量，表示当前下载带宽</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>) <span class="comment">#每隔一秒向gui发送当前速率</span></span><br><span class="line">            print(gSendBandwidth)</span><br><span class="line">            print(gRecvBandwidth)</span><br><span class="line">            msg = <span class="keyword">await</span> ws.send(<span class="string">f&#x27;<span class="subst">&#123;gSendBandwidth&#125;</span> <span class="subst">&#123;gRecvBandwidth&#125;</span>&#x27;</span>)</span><br><span class="line">            print(msg)</span><br><span class="line">    <span class="keyword">except</span> websockets.exceptions.ConnectionClosedError <span class="keyword">as</span> exc:</span><br><span class="line">        logging.error(<span class="string">f&#x27;<span class="subst">&#123;exc&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> websockets.exceptions.ConnectionClosedOK <span class="keyword">as</span> exc:</span><br><span class="line">        logging.error(<span class="string">f&#x27;<span class="subst">&#123;exc&#125;</span>&#x27;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">calcBandwidth</span>():</span> <span class="comment">#计算带宽函数</span></span><br><span class="line">    <span class="keyword">global</span> gSendBandwidth</span><br><span class="line">    <span class="keyword">global</span> gRecvBandwidth</span><br><span class="line">    <span class="keyword">global</span> updateBytes</span><br><span class="line">    <span class="keyword">global</span> downloadBytes</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        gSendBandwidth = updateBytes / <span class="number">0.5</span>  <span class="comment"># Bps</span></span><br><span class="line">        gRecvBandwidth = downloadBytes / <span class="number">0.5</span></span><br><span class="line">        updateBytes = <span class="number">0</span></span><br><span class="line">        downloadBytes = <span class="number">0</span></span><br><span class="line">        print(gSendBandwidth)</span><br><span class="line">        print(gRecvBandwidth)</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)<span class="comment">#每0.5s计算一次带宽</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">localTask</span>():</span></span><br><span class="line">    _parser = argparse.ArgumentParser(description=<span class="string">&#x27;socks5 https dual proxy&#x27;</span>)</span><br><span class="line">    _parser.add_argument(<span class="string">&#x27;-p&#x27;</span>, dest=<span class="string">&#x27;listenPort&#x27;</span>, metavar=<span class="string">&#x27;listen_port&#x27;</span>, required=<span class="literal">True</span>, help=<span class="string">&#x27;proxy listen port&#x27;</span>)</span><br><span class="line">    _parser.add_argument(<span class="string">&#x27;-u&#x27;</span>, dest=<span class="string">&#x27;username&#x27;</span>, metavar=<span class="string">&#x27;username&#x27;</span>, required=<span class="literal">True</span>, help=<span class="string">&#x27;username in local mode&#x27;</span>)</span><br><span class="line">    _parser.add_argument(<span class="string">&#x27;-w&#x27;</span>, dest=<span class="string">&#x27;password&#x27;</span>, metavar=<span class="string">&#x27;password&#x27;</span>, required=<span class="literal">True</span>, help=<span class="string">&#x27;password in local mode&#x27;</span>)</span><br><span class="line">    _parser.add_argument(<span class="string">&#x27;-k&#x27;</span>, dest=<span class="string">&#x27;consolePort&#x27;</span>, metavar=<span class="string">&#x27;consolePort&#x27;</span>, required=<span class="literal">True</span>, help=<span class="string">&#x27;websockets consolePort port&#x27;</span>) </span><br><span class="line">    _parser.add_argument(<span class="string">&#x27;remoteHost&#x27;</span>, nargs=<span class="string">&#x27;?&#x27;</span>, help=<span class="string">&#x27;remote host in local mode&#x27;</span>)</span><br><span class="line">    _parser.add_argument(<span class="string">&#x27;remotePort&#x27;</span>, nargs=<span class="string">&#x27;?&#x27;</span>, type=int, help=<span class="string">&#x27;remote port in local mode&#x27;</span>)</span><br><span class="line">    args = _parser.parse_args()</span><br><span class="line">    <span class="comment"># if(len(sys.argv) != 7):</span></span><br><span class="line">    <span class="comment">#     logging.info(&#x27;usage: local-proxy.py ip, port, username, password, websockets-port&#x27;)</span></span><br><span class="line">    <span class="comment">#     return</span></span><br><span class="line">    <span class="keyword">global</span> username, password, remoteHost, remotePort</span><br><span class="line">    <span class="comment">#if args.consolePort: # 这是localproxy的websocket监听端口</span></span><br><span class="line">    ws_server = <span class="keyword">await</span> websockets.serve(localConsole, <span class="string">&#x27;127.0.0.1&#x27;</span>, int(args.consolePort))</span><br><span class="line">    logging.info(<span class="string">f&#x27;CONSOLE LISTEN <span class="subst">&#123;ws_server.sockets[<span class="number">0</span>].getsockname()&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    asyncio.create_task(calcBandwidth()) <span class="comment"># calcBandwidth()函数计算带宽</span></span><br><span class="line">    username = args.username</span><br><span class="line">    password = args.password</span><br><span class="line">    remoteHost = args.remoteHost</span><br><span class="line">    remotePort = args.remotePort</span><br><span class="line">    srv = <span class="keyword">await</span> asyncio.start_server(test, <span class="string">&#x27;127.0.0.1&#x27;</span>, int(args.listenPort)) <span class="comment">#ip 端口号</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> srv:</span><br><span class="line">        <span class="keyword">await</span> srv.serve_forever()</span><br><span class="line"><span class="comment">#gui传过来的参数有 ip 端口号 用户名 密码 websockets端口</span></span><br><span class="line">asyncio.run(localTask())</span><br></pre></td></tr></table></figure>

<h2 id="localGui代码"><a href="#localGui代码" class="headerlink" title="localGui代码"></a>localGui代码</h2><p>localGui代码嵌入下方的code bock中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtNetwork <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWebSockets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> mainwindow <span class="keyword">import</span> Ui_MainWindow</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWidgets, uic</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> humanfriendly</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>(<span class="params">QtWidgets.QMainWindow</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=None</span>):</span></span><br><span class="line">        super(MainWindow,self).__init__(parent)</span><br><span class="line">        <span class="comment">#self.pushButton = QPushButton(&#x27;start&#x27;) #注意一会把</span></span><br><span class="line">        uic.loadUi(<span class="string">&quot;mainwindow.ui&quot;</span>, self) <span class="comment"># 加载界面</span></span><br><span class="line">        self.pushButton.clicked.connect(self.startClicked)</span><br><span class="line">        </span><br><span class="line">        self.process = QProcess()</span><br><span class="line">        self.process.setProcessChannelMode(QProcess.MergedChannels)</span><br><span class="line">        <span class="comment">#self.process.finished.connect(self.processFinished)#当进程结束，触发processFinished</span></span><br><span class="line">        self.process.started.connect(self.processStarted)<span class="comment"># 当进程已经开始了，触发processStarted</span></span><br><span class="line">        self.process.readyReadStandardOutput.connect(self.processReadyRead) <span class="comment">#信号 如果stdio有输入，那么执行processReadyRead</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processReadyRead</span>(<span class="params">self</span>):</span></span><br><span class="line">        data = self.process.readAll()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            msg = data.data().decode().strip()</span><br><span class="line">            logging.debug(<span class="string">f&#x27;msg=<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            <span class="comment">#logging.error(f&#x27;&#123;traceback.format_exc()&#125;&#x27;)</span></span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processStarted</span>(<span class="params">self</span>):</span>  <span class="comment">#进程开始后，调用该函数</span></span><br><span class="line">        process = self.sender() <span class="comment"># 此处等同于 self.process 只不过使用sender适应性更好</span></span><br><span class="line">        processId = process.processId()</span><br><span class="line">        logging.debug(<span class="string">f&#x27;pid=<span class="subst">&#123;processId&#125;</span>&#x27;</span>)</span><br><span class="line">        self.pushButton.setText(<span class="string">&#x27;stop&#x27;</span>)</span><br><span class="line">        <span class="comment">#self.processIdLine.setText(str(processId))  #先注释掉这里</span></span><br><span class="line"></span><br><span class="line">        self.websocket = QWebSocket()</span><br><span class="line">        self.websocket.connected.connect(self.websocketConnected)</span><br><span class="line">        self.websocket.disconnected.connect(self.websocketDisconnected)</span><br><span class="line">        self.websocket.textMessageReceived.connect(self.websocketMsgRcvd) <span class="comment">#当收到对方发的信息后</span></span><br><span class="line">        self.websocket.open(QUrl(<span class="string">f&#x27;ws://127.0.0.1:<span class="subst">&#123;self.consolePortLine.text()&#125;</span>/&#x27;</span>)) <span class="comment">#打开websocket连接，里面是端口号</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">startClicked</span>(<span class="params">self</span>):</span>  <span class="comment">#当点击开始按钮时</span></span><br><span class="line">        btn = self.sender()</span><br><span class="line">        text = btn.text().lower()</span><br><span class="line">        <span class="keyword">if</span> text.startswith(<span class="string">&#x27;start&#x27;</span>):</span><br><span class="line">            listenPort = self.listenPortLine.text()  <span class="comment">#本地端口10086</span></span><br><span class="line">            username = self.usernameLine.text()      <span class="comment">#用户名</span></span><br><span class="line">            password = self.passwordLine.text()      <span class="comment">#密码</span></span><br><span class="line">            consolePort = self.consolePortLine.text() <span class="comment">#websockts端口</span></span><br><span class="line">            remoteHost = self.remoteHostLine.text() <span class="comment">#远程主机ip</span></span><br><span class="line">            remotePort = self.remotePortLine.text() <span class="comment">#远程主机端口</span></span><br><span class="line">            pythonExec = os.path.basename(sys.executable)</span><br><span class="line">            <span class="comment"># 从localgui启动localproxy直接使用-w 提供用户密码，不再使用命令行交互输入，因为有些许问题</span></span><br><span class="line">            cmdLine = <span class="string">f&#x27;<span class="subst">&#123;pythonExec&#125;</span> local-proxy.py -p <span class="subst">&#123;listenPort&#125;</span> -u <span class="subst">&#123;username&#125;</span> -w <span class="subst">&#123;password&#125;</span> -k <span class="subst">&#123;consolePort&#125;</span> <span class="subst">&#123;remoteHost&#125;</span> <span class="subst">&#123;remotePort&#125;</span>&#x27;</span></span><br><span class="line">            print(cmdLine)</span><br><span class="line">            logging.debug(<span class="string">f&#x27;cmd=<span class="subst">&#123;cmdLine&#125;</span>&#x27;</span>)</span><br><span class="line">            self.process.start(cmdLine)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.process.kill()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketConnected</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.websocket.sendTextMessage(<span class="string">&#x27;secret&#x27;</span>) <span class="comment">#连接建立后随便发的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketDisconnected</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.process.kill()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#def format_bandwidth()</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketMsgRcvd</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        logging.debug(<span class="string">f&#x27;msg=<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        sendBandwidth, recvBandwidth, *_ = msg.split()</span><br><span class="line">        nowTime = QDateTime.currentDateTime().toString(<span class="string">&#x27;hh:mm:ss&#x27;</span>)</span><br><span class="line">        print(sendBandwidth)</span><br><span class="line">        print(recvBandwidth)</span><br><span class="line">        self.sendBandwidthLine.setText(<span class="string">f&#x27;<span class="subst">&#123;nowTime&#125;</span> <span class="subst">&#123;sendBandwidth&#125;</span> Bps&#x27;</span>)</span><br><span class="line">        self.lineEdit_2.setText(<span class="string">f&#x27;<span class="subst">&#123;nowTime&#125;</span> <span class="subst">&#123;recvBandwidth&#125;</span> Bps&#x27;</span>)</span><br><span class="line">app = QApplication(sys.argv)</span><br><span class="line">app.aboutToQuit.connect(app.deleteLater)</span><br><span class="line">form = MainWindow()</span><br><span class="line">form.show()</span><br><span class="line">app.exec_()</span><br></pre></td></tr></table></figure>



<h2 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h2><p>源代码中不要出现大段的说明注释，所有文字描述在本节中以行号引用说明。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAfIAAAKtCAYAAADcoexvAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAADLDSURBVHhe7d3rs6zZXR/2/g9w3nneQF7ElyrhGGOX4xqboowLlwtwmBgDBnxRGXx0myQTfEuOA5YISAgJNCAhJCEQY924jSwJaUwAR0lIOXZFsVN2CE7kN0K2YIQ0N400IzTSk/3rs39n1l5nPbfu3bt77fP5Vn2q+1lrPZfuc6a//exzjrT5o1/xFQMA0KdtkYuIiEifUeQiIiIdR5GLiIh0nM0DDzxw/lRERER6iyIXERHpOIpcRESk4yhyERGRjqPIRUREOo4iFxER6TiKXEREpOMsLvJf+ZVfHd718+9Z5S1ve+fwI69/6/CaH33L8NaH3j3899//uuEd73z38IUvfOH8qCIiIrJPFhf5O975ruHf/Mb/e+Y39/Bvh59481uHZ5555vyoIiIisk9WFfkTT3367G76uVmf//znb3vuuc/fHv/c5z43vPFNPzl89rOfPT/q1eaRG5thc++Dw0fOtw+dyzvfR4YH7z071o1HzrdFRE4rm83ZZ9QKPSeu/8Mf/vD51nhizVW81tVF/jMP/2/D97zxkeF73/TB4R++5YPDy3/qA8Mr3vZLw/c99L7hLQ//6tnd9meH3/3d3x0+/vGPbz355BPDR3/78eE7X/W+4Rf/538zW+QfefDeW7/QMwW4Lcmzdcu77bwMVxTrrXPcGO44xUceHO49O/e9D9ZHKgt3/fnGo8hF5LSzprCuotwOmSzoqTJfsuaysrrIX/OP/qfhvpe/Y/im73to+OZX/czwra/96eHbfvQnh+/48TcPr/zZ9w2ffurJC0X+xBNR5I8NN37kPcM//uf/almR33vvWVHeO9zRk5ltkZ6tOSu3g3bbIzfOfiHuvI7tNZ79At1R0ucFf/nXpMhF5LRzNxV5ZKqop+YOkcVF/vZ3vHP41ONPDq//uf9l+Js/8nPDd/7Yu4YXvv4fDd/+Yz85/JU3vHH4tp94/fDKn3vPtsgfe+xTw6OPPrr11Nn2b33iU8P9P/Xu4f3/8v8YXv/GNy+4I78x3Ii74ZHi2q65cbbmIKVZ5pHtOS7eed8q1RsPRmlXd+sjxb9/FLmInHbutiKPtAq7NXborCryT3zy8eEn3/frw40ff/fwTa958/B1r35w+IYf/uHhP//R1wz3/firh5f/7Lu3Rf7kk1Hmj209/fTTw8c++cnhb//8Q8MH/vU/H370DW9aVOSPnN9131mKUa4xfqtkL3bbeeGdjd9ysWgv/pn18+V465ytfc7XXLjzHj9//Wfi6893nu0XgpyPfR5sF/n5TwDKtVPXExkdq48tIrIi8fmzNGvWnnrK4i6fX2VWF/mDv/Crw9e98vXD1//Q64ZveN0PD9/4+tcM/8VP/ODwl9/yA8P3/cI7iyL/1NZnPvP08O8f+93hv/ulNw+//Ju/vrzIz55HwdR/Dr2d35bOnUX6kQdvFMV/Zwk3i/XsGM+f49Yxy1Irr2ebKNnzY1y8vlv7lte7y/m2xz8buzh0a7+5dVnst49/x08Izs93YezWdV04johcWrb/7a7Qa9Zce8+vs5Us8HDVJR5ZXeQ/+LMfGL7+ta8b/uKDrx3ue8MPDX/pTa8avvmt3z9869teMXz/w2/fFvkTTzw+fPLsLjw8/fSnh//wxKPDK/7p64Zf/ciHVhX5rSIq71jL8i6fj6Tav1msRdFH7iju6s+9t8c439iuzf0bP0FYf747vwzcyvm+t1/s2Lr28Z7f7Vaxx98tuL3v6E8+RESWR5GffUafiedXndVF/upfeP/wjT92dhf+xlcP3/TmVw7f/FP/w/BXHnr58B3v+N7hle99aPu31OPPxR9//LGtp556anji008Mv/nxfzt87JP/YV2RnxfYhTvM20XYLvLbd6+3zRR5dYCL54+U11CdsyjBO/fb4XzVl4bnU+07uu4s1V34HV88zp5vH8+vq3wuIrJr4vN2adasPfV8+LzE47F8fpVZXeSvec/7zkr81o/Sv+Wnv2/4trMS/6vv/J7hb/zszeEH3//T27vx8i+7fepTn9qW+7bYn3hiZZGXRVOVel2q59sXynTJHXnVhvX5I7f32xZoOff8NZSFmTmFIq/fv+0+xeuIa2zd2YuIrMndWOQfbhR3a+zQWV3kr33vP779o/Rvf/s/HP7qu/7B8Dd+7r8d/uYv/t3hhz7w1uHxxx7blvcnPvHo8Du/8zvbf4oWf+ktfsz+2OOPry7y22V542Ip3x7PgarAIvWxdi3yPPaNG1mKz+dWgbf/Bv368916TXcW6/mXlOdf7Mi6xvVvS/vsfXmk/BKSpR7HufieiYjskrutyD88UdhTc4fI6iJ/6IO/MvzAw+8aXvWedwyvfu/bhx96/0PDa37pbcNrP/jTw0994OFtiUd5//Zv//ZW3JVHiW8Lfaciz7G6uFpFXmyf37VeSpGfn+vOazjL+XnrLxGRXc633ac61q2xi/vme3LhcPV7sM15accXoXr/+Pf61RcTEZFdEp89S7Nm7SnmwwuKesmay8rqIn/2mWeGTz/11AXxZ+L54/Mnn7j1Z+TxPwQT2/nP0MLjTzy5U5GfDd66q7zQOFWRn+XWvuelFwW1LbbLKPLny7Rafn5t5XGfz67nu13c52480t43i/t57bvrfF8u7H5+3X6sLiKXkYufRfN6Tlz/hxcUdKy5ite6+aNf8RXnT6fzyD/55eE9H/iV4f3/5J/u7H2P/Nrw+jf8hP/TFBERkUvK4jvy+L8ejR+Tf+xjH9tL/Jj9i1/84vlRRUREZJ8sLnIRERE5vShyERGRjqPIRUREOo4iFxER6TiKXEREpOMochERkY6jyEVERDqOIhcREek4ilxERKTjKHIREZGOo8hFREQ6zrbI4/+pDADojyIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDo2E5FvtlsbmvNh7l5AGB/e92R91jkeV211loAOHUHK/LLcKjjt457iHP5ggDAoSnyibF9KXIADu0gRR7jqTUfyjX1unqunm+tqcfrNTmf4+X21Fhr33K83q7H6jkAuEwHvSMfm6/Hl66bGi/H4nm9pjVfKtfmmtbzcmzJmnoMAC7TSRT5mDX7l2O7zJfm9m9ttyxZAwD7OEqRh5hLrfkwNlfuWyrny/X1WGu+NLd/a7tlyRoA2MfRirw0tm7teGrNl2P77t/ablmyBgD20c2fkY89b43tMl9bc7wxa88JAGvtVORRSrV95su52tiacv9yfm6slPNjWuvK/VvztSVrAGBXe92RAwDHpcgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOri/zmzZsAwAG1+nfMTkUuIiIih4kiFxER6TiKXEREpOMochERkY6jyEVERDqOIhcREek4ilxERKTjHK3IN5vN+bN2Yn5qzdR8zi1ZIyIi0nOuvMjnCjZSzrXWTc3PrY9M7S8iItJTTu6OfK6IDzEvIiLSa+7aIo/HJCIi0muuXZFHYrtUZmxMRESkx1zbIs9MzWVaYyIiIj3k2hX5vvMiIiI9RZGfpTUmIiLSQ06uyCNrireen1sfWbKPiIhID7nyIo/SrLUyNRdZsu/SNSIiIr3maHfkIiIisn8UuYiISMdR5CIiIh1HkYuIiHQcRS4iItJxrqTIAYDDafXvmNVFDgCcDkUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1bXeSbzWZr6Vhrbmq+Hhvbbs2VxubK8db82LrWGgA4tp3uyFvFVo7V83PbrbHYLsfq5631redT2/VjPT83BgDHdiVFXltSlFPHWLJ/OT527Pqxnp8bA4BjO0iR53Yqx+u5Ur2m3C615lr751hrrvVYzreUawDgFBysyEv13JJSXHO8emzufLldP9bzAHDqLqXIY7scmyvGers11lqT5vavn9frc7t+rOfnxgDg2HYq8hDFlsrtei7HamNr6vFyrp5fMjb3vB5LOdaaA4BTsXORAwDHp8gBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOKHAA6psgBoGOri/zmzZsAwAG1+nfMTkUuIiIih4kiFxER6TiKXEREpOMochERkY6jyEVERDqOIhcREek4XRf5ZrPZEhERuVvTbZGXBa7MRUTkbs21KHIREZG7NYpcRESk41x5kUcBt9Rzre1IOVbPiYiI3G05SpGXaRVxXdBja0RERO72XHmRlxkr4yUlrchFRESOWORTRazIRURElkWRi4iIdJyjFHldwnPbrShyERGRI/1lt5axuTpL1oiIiNwtOcoduYiIiFxOFLmIiEjHUeQiIiIdR5GLiIh0HEUuIiLSca6kyAGAw2n175jNfffd15wAAE7f6jtyAOB0bO6///7mBABw+hQ5AHRs87KXvaw5AQCcPkUOAB1T5ADQsc1LX/rS5gQAcPoUOQB0bHPPPfc0JwCA0+eOHAA6tnnJS17SnAAATp8iB4COKXIA6NjmxS9+cXMCADh9ihwAOuafnwFAxzYvetGLmhMAwOlT5ADQMUW+wGaz2WrNAcAxbW7cuNGc4CJFDsAp2tx3333NCS5S5ACcos0DDzzQnOAiRQ7AKVpd5OWfF+fzVslNzdXzrTVj8+V2+ViuSa3xHMvxeru1rjUPAKdgpzvyVrGV21Nzl7ldP5bKsbH5sTVj6+sxADi2nYt8yViO13Nzpbh0vn6s56fGWmvSkv0B4BQcrMhjO8fG1pdr1sznWP1Yz0+NtdakJfsDwCk4SJHX83MluMt8jk3NTY211qSlxwSAYzv4n5HPrd1luxxrzdXjU/u31HOxPbUeAI5lrzvyLLhWyZXj9ZrcrseXzuea8rGltX+Olcr51rpyu14HAMd0aT9aBwCu3uoizztTZQ4Ax7fTHTkAcBoUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0bHWR37x5EwA4oFb/jtmpyEVEROQwUeQiIiIdR5GLiIh0HEUuIiLScRS5iIhIxzmJIt9sNhesybH2FREROYUctcjrIq1NpbW+NJXW+pKIiEgvOVqRtwq0pZXWupZWWutaREREeogiHyEiItJDjlLkreKcUqY1P6VMa36KiIjIqUeRTxARETn1KPIJIiIipx5FPkFEROTUc5Qij7SKs6WV1rqWVlrrWkRERHqIIh8hIiLSQ45W5JFWgZam0lpfmkprfUlERKSXHLXIM/sU6bH2FREROYWcRJGLiIjIblHkIiIiHUeRi4iIdBxFLiIi0nEUuYiISMe5kiIHAA6n1b9jVhc5AHA6FDkAdEyRA0DHFDkAdEyRA0DHFDkAdEyRA0DHFDkAdEyRA0DHFDkAdEyRA0DHFDkAdEyRA0DHFDkAdEyRA0DHFDkAdEyRA0DHFDkAdOxaFvlms7mtNQ8A18W1viPfpcjLLwGl1loAODZF3tDa7xBl7gsCAPtS5A2KHIBe7FXkUURpan5sLJ/Xa+q51ny5pjUX5uZK9Vy5PTXW2rccr7frsXoOANbYucjr8pnabs2tXV9u12Ot+bXj9fFq5dpc03peji1ZU48BwBo7FflcAc2V1i7zpbn9p8bGxsuxsf3SknPNHSMsWQMAU06yyHM7leM5t+tYjreU8+X6Wmu+Hps7RliyBgCmnGyRl+q5pfuPHXPqXGGX+Xps7hhhyRoAmHK0PyMvt+uxfdfvMr7keKW59ZdxDACYs3ORhyifNDXfGivH67FyO8daxubLfZeuaY2X61ta68r9W/O1JWsAYMxeRQ4AHJciB4COKXIA6JgiB4COKXIA6JgiB4COKXIA6JgiB4COKXIA6JgiB4COKXIA6JgiB4COKXIA6JgiB4COKXIA6JgiB4COKXIA6JgiB4COrS7ymzdvAgAH1OrfMTsVuYiIiBwmilxERKTjKHIREZGOo8hFREQ6jiIXERHpOIpcRESk4yhyERGRjnOUIt9sNhfUOfS8iIjIdcmVF/lY8WYOPS8iInKdoshFREQ6jiIXERHpOFde5JEo1lKdQ8+LiIhclxytyDOtoj30vIiIyHXJlRf5IYp5zbyIiMh1iiIXERHpOIpcRESk41x5kUeiWEt1Dj0vIiJyXXKUIhcREZHLiSIXERHpOIpcRESk4yhyERGRjqPIRUREOs6VFDkAcDit/h2zusgBgNOhyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocOvLkxz/eHAfuXoocjmxpOT/9a788DF/6+4bPvPcXm/On7smP/H/Dp//Zr28fW/Nz4n2ae6+WrDm2XV8/jLnrinyz2dzW2oarFB/q23J+x9ua86Vc+9xX/bHm/Jwo0V3tWo5xzVlcn33Tj22vPx5vz6847jOv+YHt/vGFpjUf4ktOfY45rdcb8rpbc2OWvJ7f+8Y/t/01zOPv66n/6182ryXlNcX5WvMpjlMfmz50XeS7lm+936FK3JcDlvjcC791tqDSM9/z97Zr44O3NT8l9ttV63xREDEe5RnFGZ79r1+0fT1RVLlvXHOsr4s8S3fpTxjymFMFGOePNUveyxTrW/I6W3Nj5n5d8tcv3qNYu9RUyebvn3gs5fsV+8e6fP/ji0S9Nvevjx3yi0LrfZ/6clCv5XAUeWP7sihylohCjA/SEB+aWZAtUXrxgduaS2N3hXmO8gN8Tl0GY8eckkUex4jtLMh4rbkmx8bk2ijq1nzK47XmxuQ++Zqj6GK7LvLyfanl+zRVuFniu4hztI4ZYi7W1ONZ3PlrV2+Xps6Rx2/9GuUxx8Sv19R7wuVYXeRRTqm13VpXztXj5VxtbL7cd+maem5quxyfm2utqefqeajln3/Hh2YW3q6mSjdKKuaXmvsJQPy4Oz6s4wO9/FBvfXjHMWKuLISyzLPwSzEf++Wdduyb15Zybf0etrSuK/fJ7ViX52rNt+Rrb82FusRbd8UtuX7qC0yuq8fzmuL1tLZLMR7HqcdDHj/fj1IeM/dP5U9kgjI/rJ3vyOuCGnveGsvn9WOptb62Zrw+Xq1cm2taz5dsz41DS/w5edxNx4de+aG41tiHZvnBulbrw78l17fm6oJMcb0xHuVW/zQhXk8ec0yuzbKfEscrjx/q8V2KPK+zHo/XU76GLPTWay3FXL6eubVj566Lu94uxfjYa8zj179uIY/Z2jffxxDFXs9zefYq8tZ4aM2VY/m8fqzndxkbGy/H6vm57XqsNd+ydB3sY+lfmsoP1fjQXWrqR+tRwDFeynPU4yG+qMRclFlrLu6o43n5RSSuYeya81yxLoout1trowxzLo+d6vG4hhgbK/L6dWeZxTlyTaivKV9X/t2A0Pqz/DxeiPdqqsRDHDvWltcU8ktDPI91edx4r+u1Md56b0IeP9+PUh5zbN/ytZa/rlyugxV5SznfeqzndxnL8ZZyvl4/td0ai+1Ujpem5uAyxIfj2IdsbeoDd0x+UGcZlPID/rKV15jnKM/bmitLql4XpsoqxqOEs9TyC0e+p/V++bfna61SjmO1/jJf/Lrll6Q4duybryHEXOs9b8n3IR5L9ZewPH681npt7l8fO+R8vh+lPObYviHmw9LXw3pXdkdeyvn6sZ7fZWxqPM2db825wtjc1D7H9vQH3tccZ7n48H3mta8cfu+//K7hua//6uFzZ4+tdWPqv/Fb37Fsj39WGuVYLe+6lvzN71hXFtYS9V1dKa4tiyDlh3Y9nubmQ/maYzvWl+et58o737G717j+PG89l/vWxoo8/8Jhih+Bt96fOXGtsX993rlf81r+OtTjeZ1xbfF7Lbfj91kof5IT42PnzWtU5KfrJH+0Xo+15uvxufVT8/uub+1fj4+tuWpPfuy3ht970V8fnvuGr2nO382e/Hcf2ZZn+Mx7fn549lUvH579/u/ZFvUXvuorhy/8Zy8YvvjlXzoMX/YfbT+YvvjH/pPhub/4NcPn/t5/td3nqf/n/24ed0x+CKb6wzBLNMZbBZV340v//LE811pLP4RzfWsuxNzYh37rNWaJ1OPlXL6P8bhPkcdcyB/DZ3HF86VfgOrz55e1+P0Rx8vSzXOmsbEQ+4Uo4jhW/YVvTv6EIfbNsfIvD5ZrW/LaWmtjLK+1ngv5ezSsvW6WW13kUUi1Jevq8Xxej5XGxktz+9bz9Vi9XZobH5svLVlzVT79v35o+MKf+vLtf1RR5q0110V8YclSDttSPvd7L/yW4fPf9Be2vviVf/D2B80FXxaPUdhn4vkfvGd47mvvHZ79B39nePp//GDznGuVd3ZxztaHYXzwx1yUdf1BmPvF6yvHx+S5drH0Qzjfv3IsCiReazzPH/eW8yG+tERZjr3Gcqyei/LMoovjt8o8riHWxj71XD2ea7O44vlSZVnmF7GWOF8cv1wfYjvG87W1lH98EOvnZGnH75NyPM+RXxBS/Xcucl2+H6UYi7ny/Uvx65BfipZ+2WQ3O9+R05dnfvhV2/+g0rOvuNlcd6rKUn7mDT/yfCmffSHJUv7CV/+JC69xkW1h3/n8i3/kPz4r/LMP27f8+PDUv/o/m9d0meKcrQ/DEB+0eV1ZiPkBGh/S9foUH6TlB/RlqT/oS3mdWcy5na8tS6Es2yy8WF+XcK5vXUceP9fGWGy33pOca73H9XiuzeKK5yHPF4+xvpRfUGLfPE68TzEXx4nyjbn69W3HJt7P+GITv+fjGPE+1a+tvo5aXnuK62ytK+XvsfIcsW++H6X8fRjvSbyWFK8335MQY/W+XB5Ffs3Fj4vjx+j5H1SKgmqtvwqf/hf/7HYpx3VkKX/u79x/u5Rb17y787vq8g57+/z5NV98wZduvxRcVXHX4hriA7M1F+IDPa8177BCXQyl+PDMdZcpP9DjmuJ5XE/5oV0ryyF/whDXFteer6VV4iFLZEq5PoulvGsN+V60/hw4xsv3Ptfm68z5/DXI8VJ+GWm9hjheS35Bi31b86Wpsm+J/7byvYvHuK54nte/5nh5nNbrzvd7Slx/vR+XS5FfY/HnvFFQrf+4Lusvu8WfC2cpf+bdb79dynHHn6UcWtdwECN32LVtcb/wW7Z39/HFovXarlJcU1kmLfHhm3eFYe4DMoonjrlEHrM1V6tLuSXWtMoifp/EfBR4eYc79oUkzhdr6mvI8VDvk8eN159j8V7FWKuMYjz2ydLMP1POtfE8zpfP6x8TZ0nmmlrM7at13SFeY15z68/fyy8ucZ3lfLzmmI9j52sP5fsWcp/WNcRYHi/Wpfj13f4eGPl15XIp8uvo0Ue3d7f5H1hL666z/MteUfS3S/lMWcpjXw6uzvmddT6fKOx0asVdi2uMD8DWXMoSTNsCXHmnNrZ+yflrcT1RBPGBnR/+eW312lTeGYa6xOsP/rimseONzUUZ5bHrsVYZxXhLro3n+d7knXccL/fPMssvOLXYtyV/itGaS/EaymsplSVaiuPGr8vYr3Vce/lTnVr904y4jhifuoZYU89xdRT5NRMlteTPiuNH11HK+Zff+nDxx+FTTr24a3HNUx+G5Yd2fNCWH8T1HdSY+GCP9eVdWorxKI34kB+z5Dx5Ta25KOkswu11nD2vSzzGyyLJEsnt0tRcnifLNa4/tltlFOMhjhfq8sy5eJ7v4e3t82uu79KXyCJvzaX88ta67jh3vgdxrO1d8Nl7V/+65Xsc116Ox7HjuHmMEM/rLwA537qGGMv96jmujiK/RqK0hj/w+2//R9mP8g57N70Vdy1eQ+vDMD5ws1hCWaZlKY7dDZbyQzc+wOu5PM6UJR/WubYciyLJc5fqYojXWo9niZTrlszFOcsvBFOFWI/X1xHPy9d++0vC2fHzGmKfnF8iryeO1ZpPcQ1zx89riMdSflHIffNY8fupXpv718cOOd967/KYY/tyNRT5NRA/Ev/8t9+3/Q/qpF34Efie5X32hSVec/xt/Phnda33pSfxmsoPw/jwLe+643neWZXi7jrXtD5oU+yb61p31jkX1zCmdSdfy+PE87izyw/68vhZlKF8TfFlJMbKLyWxPsZyuzQ1V8vrqN+jvJZyvB6L53GunC/fy7DkfSnF+5/71ne/tbzuLOOWsfeh3nfqWDFevsZSHr98j1Iec2xfroYi71z8Wfbov4U+irNyXvgXzla5ZsVdygKLO6goiSySHJv6EA+5fxgrhvzATbFdlmiM7fJhHKUU1xfyLjPEXHldcezydbQKIL+UlF80skTyHKX8SUWunZLni8dyvHWnHscux+J5/d7k8UL5xWNOHnvpfvkaW1++Ur5H9XheY5yztV2K8fo1pjx++R6lPObYvlwNRd6rRx/d/s3w+I/oaLYlfX5nfft5Mb+Pa1zcpbLsQnwgRsHGB+Sagoi1Yx/2eQcYx87nKe7088M4SiM+5OeU5yl/apDKD/Uo59gnt0tZUvEYhdr6M+MskSnl+jH54/A4z4Xx8y8P5TXG8xjL4orn5WvK8s/rDXGc8otRLeam/igk39tS/rqEcm0t36N6PPePY7W2SzFevsZSvLaYa/1+jLGYizX1HFdHkXco/sb55f476xmHuMOu3SXFXYoPwXz9UY7lB308jw/eWFN+uI+JdbE+xHaeI4s7yjKLJsbyw38X5Yd2fpCnuO65HxenuJ4s89vHPtu/XJPXWZ4j5T7l+vp9CVlgob621peH2CfGYr/YjudxvnieJZ7vZ26n2Kc8R/3rGuI9y/lUvp5aXseY3Ld+3XneeB7r8n1o/YW4GM/XSH8UeWc++9BbD/QX2sq76gPcYTfE35qPf9p2txR3LT9YyzvcvEPcRxZFfkCXJV6KwokP9bzjWqq83n3FdcX7EMfdfgmorjPG4zWUY1NzOdZSf0nI9yfLN0o5xrIA8+49nsdx473K45TXGfuWP5koi/fCXXvsV32RSPkelOKYeQ1TYm0cv94/zx2vKdbl77f4/VCvzf3rY9MHRd6J/D87if/g9nYVd9gNWdxLPpzuBlEGrbuz2wV79sFff+AukSUThbstqaoce5JfMpbOjRVi830+e1/K96f+/ZpfWOIY8WsRa6d+726/BBQ/rSjHxgr8Moy9R/nTknwd9XZp+xqra6cfirwDcce6/t97n99Z5/MrLOykuOlJlFnye5aeKPITF0XYKslxh/1x+BTFDXD1FPmJin8b/oWv+VNFUZZ32Kch/sJd/M15xQ1wPIr8BD339V99XpanVd63izv+D1cefbR57QBcLUV+wuLPxp+9+d27/f9sXwLFDXD6FHkn4t+Ox/+O+HNfe2+zdC+D4gboz+oiv3nzJkf2qu/+b4b3/uVvHH7jTz//b1R39Vtf+YeHn3nhXxu+9+///ea5ALh6rf4ds1ORywnl2WeH4X0PD8P93zkMX/5lzbKe9Mf/0K1jiIjISUSR3+350K+d/S747mG49z9tF3dLfBEQEZGTiCKX5/Mb/3oYfvAVw/Bn/2S7wNNf+KrzHURE5NhR5NLOxz46DG994zB86ze0y/yXP3C+UEREjhlFLvP5xKPD8PPvHIa/9R3P/x+wuCsXETmJKHJZl/iLbnE3/rdfOgz/+6+fD4qIyLGiyEVERDrO0Yp8s9mcP7szMVeqMzc/lXrfVGdsfGnm9t13fi5Lr3/f84iIyHFz5UWeBTNWIK3xcmxufi5L1s6dbyqxPrWy7/ySlPtOHWff84iIyPFzcnfkrfFybG5+LnNr1xxrKvueZ9frWLNfrN31PCIicho5uSJvZWrt2iLK8iqVye2x+aWZ22/f+bHkfvGYWinXiYhIvzn5Ip8qol1KqLVPOdY67mWdp8y+82OJ/ep9p7Z3PY+IiJxGTrrIL2vNXOaKbZdzzO2z7/xY5q6/nt/1PCIicho52SJfUzD7llG5f+tYuxx/bp9958cyd/3xfIyIiPSXkyzytXNrSmhu/32Pn5nbZ9/5say9/l3PIyIip5GTK/K5Iloy31qTmds/MrUdz1vHqDO3Ztf5Jeev56fWzx1LREROO1de5FlEpTKt+VBmydxUyn3H1o7NT+0TKfdrrb2s+bmM7Z8p58fWiIjI6edod+QiIiKyfxS5iIhIx1HkIiIiHUeRi4iIdBxFLiIi0nGupMgBgMNp9e+Y1UUOAJwORQ4AHVPkANAxRQ4AHVPkANAxRQ4AHVPkANAxRQ4AHVPkANAxRQ4AHVPkANAxRQ4AHVPkANAxRQ4AHVPkANAxRQ4AHVPkANAxRQ4AHVPkANCxu67IN5tNU2stAJy6rot81wJu7XeIMvcFAYBDU+QTY/tS5AAc2uoij3JKre3WunKuHi/namPz5b5L19Rz5fbUWGvfcrzersfqOQC4TDvfkdcFNfa8NZbP68dSa31tzXh9vFq5Nte0npdjS9bUYwBwmfYq8tZ4mCu1fF4/1vO7jI2Nl2Nj+6Ul55o7RliyBgD2cbAibynnW4/1/C5jOd5Szpfra635emzuGGHJGgDYx5XdkZdyvn6s53cZmxpPu8zXY3PHCEvWAMA+TvJH6/VYa74en1u/5HilNccbs/acALDW6iKPQqotWVeP5/N6rDQ2Xprbt55vjY1prSv3b83XlqwBgF3tfEcOAByfIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjq0u8ps3bwIAB9Tq3zE7FbmIiIgcJopcRESk4yhyERGRjqPIRUREOo4iFxER6TiKXEREpOMochERkY5ztCLfbDbnz9qJ+ak1S+anMre/iIhID7nyIs8CnSrRcq61bmo+ttNYpvYXERHpKSd3R94anyvepWORNWtFREROPYr8LGNrRURETj2K/Cxja0VERE49ivwsY2tFREROPYr8LGNrRURETj2K/Cxja0VERE49J1fkkXJurnjHjrPP8UVERHrJlRd5FGetlam5yNh8jpdamZoTERHpJUe7IxcREZH9o8hFREQ6jiIXERHpOIpcRESk4yhyERGRjnMlRQ4AHE6rf8esLnIA4HQocgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDomCIHgI4pcgDo2FmRf1dzAgA4fZvv+ro/05wAAE6fH60DQMcUOQB0bPNn7rmnOQEAnL7NPff8keYEAHD6zorcHTkA9GrzXV/njhwAeuUvuwFAx7oo8s1ms9Wauwq7nH/NPodaC8D1180deZZXFlmtXn/Z1p5j7XUdai0A11t3RV4/nxq7TMc4/tg5D30tAPRDkS90jOOPnfPQ1wJAP3Yu8iiT0tL5crs1X69rrSmft7ZzrN6vHJ9aU8+Va+rn9Vi9b47VyjX12qm5nK/XlfMA3D12KvKxYhnbrsfi+dQ+S/dP5bqcn9ueWlPP1WP5vH6srRlfOpbj9dzYWgCut0sp8lprvhy77PnW+hRzS9aXY0vn68famvGlY2PjY2sBuN4u5UfrU3Olcr5cX4/tO5/bOdaaK7frsaXz9WNtzfjSsbHxsbUAXG+X8pfd6hKZK5W5Irrs+bntemxuvtxurU1jc0uOPzY2Nj62FoDr7Wh/Rl7O1WOt4+26f71vPd8aa60fO0Y9Xhqbax2rtbYcG3s+NQbA9bdzkZfWrNl1rNxuyf3q/cee5/bSsdZ8+VjKtaWpNeX22Lp6e24MgLvDpfxoHQA4DkUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1bXeQ3b94EAA6o1b9jdipyEREROUwUuYiISMdR5CIiIh1HkYuIiHQcRS4iItJxFLmIiEjHUeQiIiId5yhFvtlsLqgzNz+Vet80lqm5qcztN3feuSw5/ljy3EvOv2RNK0uPXyb3qYmIyO658iJvfXCXY3Pzc1m7ds36SO4ztV85d9nHXzJfZmxdZOo4Uyn3Wbt/a/0u1yAiIreiyFesLzO2X2t8l3PM7XMZ54/xufPUWXP8VvbdX0RELubKi7yVuQ/ysQ//qfFSKzk+NT82F5k7bpmp44xlbp99z59jc+eps/T4Y6nXltvxPLfzeTmfKeda8yIid1OOXuRzH8Rj82Mf4kvGyu3W+kiMj81FpvarM3Wcsczts/T8sd0ay4wdZyyt9WuOEWtLdVrj5fbUnIjI3ZijFvnch/BlfUgfogjG9muN73KOuX2m5mMu5Xam3q/enktr/ZpjzJ1/7vhrziUicjfkaEU+94F8mR/YdRGMWZOx9a3xtceOzO2z5pjl2ng+Zkla65buG5nbf8nxYzuJiNztOUqRz30A7/MB3dp36ni7nmtsv7XnH8vcPmuOObV27bW11u97LeXY2uOvObeIyHXMlRf5ZX2Qx9iatWMZmxs7fmbp3NS6qcztd1nnr+dje80+c2vrtNbXx6vX1PNl6m0RkbstRynylkxrLtQZG4+U++26Zm681MrU3FTK47aOMTefmZqLlPuX6+rtsSxdVyb3qZXJ7an5sTkRkbsxV17kIlNRziIi66LI5WTiTltEZH0UuYiISMdR5CIiIh1HkYuIiHScKylyAOBwWv07ZnWRAwCnQ5EDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcUOQB0TJEDQMcU+QKbzWarNTdmzT6HWgvA9dddkWeR1VprL9Pac6y9rkOtBeB66/KOvFVkhy63Yxx/7JyHvhYA+qHIFzrG8cfOeehrAaAfq4s8SiS1tlvr6rnWmrGxejvH8nlrO8fq/crxqTX1XLmmfl6P1fvmWK1cU6+dmsv5el05D8DdY+c78rpAxp6PjU1tL1lbKudyfm57ak09V4/l8/qxtmZ86ViO13NjawG43vYq8tZ4aM2VY3OlU8+v3S7F3JL15djS+fqxtmZ86djY+NhaAK63gxV5Szlfrm/JNa21S8Zie+wYc/svna8fa2vGl46NjY+tBeB6u7I78tKS0sk1rbVzY/X83HY9NjdfbrfWprG5JccfGxsbH1sLwPV2lB+tL9keGxsbL8fq5/X6Nfvn9tgx6vHS2FzrWK215djY86kxAK6/1UUehVFbsm5uzdh8a6xlbN3Y89xeOtaaLx9LubY0tabcHltXb8+NAXB32PmOHAA4PkUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1T5ADQMUUOAB1bXeQ3b94EAA6o1b9jdipyEREROUxWF/l9993XnBijyEVERA4Xd+QiIiIdZ3WR33///c2JMYpcRETkcFHkIiIiHWd1kb/sZS9rToxR5CIiIoeLIhcREek4RynyzWZzQZ25+anU+6axTM1NZW6/ufNOJfcd27+cb62Zm49MzZVZsqaVpccvk/vURERkPKuL/KUvfWlzYkxd5K0P5nJsbn4ua9euWR/Jfab2K+d2OX6Zue3I3PmmjtFan4m5qfmxLD1+K631u1yDiMjdEkW+Yn2Zsf1a42uvqU45duj5MjE+NjeWNcdvZd/9RUTutqwu8nte8OebE2PqIm9l7oN67MN9arzUSo5PzY/NReaOW2bqOHXm9l97/Hpu6f45NnXsVpYefyz12nI7nud2Pi/nM+Vca15E5DpldZH/+Rfc05wYM1fkcx+0Y/NjH9JLxsrt1vpIjI/NRab2qzN1nDr12tgeG2vNZcbmloyV2631U1l6zrHE2lKd1ni5PTUnInIds7rIX/LXL++OfO5D9rI+hA/xQT+2X2t87TlifcrtMuV2PVdnat/M1PHmjl9n7vhzmTv/3PHXnEtE5DpkdZHfc8/l3JHPfeBe5gdy/UE/Zk3G1rfG1x67Trn/Lsdfs388H7MkrXVL943M7b/k+LGdRESue9bfkb/kJc2JMa0in/uA3ecDuLXv1PF2PdfYfmvPvyTl/nPH33e+ztRcK2uPX2du/7XHX3NuEZEes7rIX/ziFzcnxtRFflkf1DG2Zu1YxubGjp9ZOje1bixT+7eON3e+qWO01pdp7btmn7m1dVrr6+PVa+r5MvW2iMh1y/oi/2tf25wY0yrylkxrLtQZG4+U++26Zm681MrU3JIsOfbYmrn5yNRcpNy/XFdvj2XpujK5T61Mbk/Nj82JiFzHrC7ye16wX5GL7BPlLCJyMauL/EUvelFzYowil8uKO20RkTujyEVERDqOIhcREek4q4v8xo0bzYkxilxERORwWV3k9913X3NiTJwAADicVv+O2TzwwAPNCQDg9ClyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjilyAOiYIgeAjt0u8ocffhgA6MgdRf7Rj350+JIv+RKPHj169OjR44k/Nos8JwGA0xV9PXpHDgCcPnfkANApd+QA0Dl35ADQKXfkANA5d+QA0Cl35ADQOXfkcA1tNpvmOHC9uCOHa0qRw93DHTl0Jkq6NDVXz9frxsbyeb0GOC3uyKEzdbGOFe1UAZdzreO1xspt4LS4I4eOLC3VsXWt8XJsbh44Le7IoUNRrKk1H8bmWuPl2Nw8cHrckUPH1hT22Hg5NjcPnBZ35NCZulTHSnaqnOfmptYDp8cdOXQki7ZVuLWpNWNzOZbzrTXA6XBHDlyguKE/7siBLXfh0B935ADQOXfkANApd+QA0LnJO3KPHj169OjR42k/NoscAOjHhSIHAPqjyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgY4ocADqmyAGgAx/60IduK8cVOQB0QJEDQMcUOQBcQ4ocAE5QfQdebydFDgAnqC7uejspcgA4QXVx19tJkQNAxxQ5AJyIqTvwejspcgA4EVPFXW8nRQ4AJ2KquOvtpMgBoGOKHAC69cTw/wOta3amV9eNmgAAAABJRU5ErkJggg==" alt="avatar"></p>
]]></content>
  </entry>
  <entry>
    <title>Python程序设计课程大作业</title>
    <url>/2020/12/28/py9-2018211308-2018211430-%E5%91%A8%E7%91%9E%E5%8F%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Python程序设计课程大作业"><a href="#Python程序设计课程大作业" class="headerlink" title="Python程序设计课程大作业"></a>Python程序设计课程大作业</h1><p>班级：2018211308</p>
<p>学号：2018211430</p>
<p>姓名：周瑞发</p>
<h1 id="本地系统"><a href="#本地系统" class="headerlink" title="本地系统"></a>本地系统</h1><p>【文字描述】</p>
<p>local-proxy提供socks5和http-tunnel服务，接收来自客户端的请求。同时为了方便用户操作，提供了图形界面供用户登录连接。</p>
<h2 id="SOCKS5服务"><a href="#SOCKS5服务" class="headerlink" title="SOCKS5服务"></a>SOCKS5服务</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">socks5</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    header = first + header</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="keyword">assert</span> cmd == <span class="number">1</span></span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    print(address.decode(), str(port[<span class="number">0</span>]))</span><br><span class="line">    <span class="comment"># 得到了地址和端口号，sock5连接建立完成,然后调用函数，与remote-proxy连接</span></span><br><span class="line">    <span class="keyword">await</span> xfer_remote(reader, writer, address.decode(), str(port[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、根据socks5协议，首先收到客户端发送过来的协议版本及认证方式，格式为</p>
<table>
<thead>
<tr>
<th>VER</th>
<th>NMETHODS</th>
<th>METHODS</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>1TO255</td>
</tr>
</tbody></table>
<p>第一个字段如果是0x05，则表示为socks5协议</p>
<p>第二个字段表示支持的认证方式的数量</p>
<p>第三个字段是一个数组，包含了支持的认证方式列表，我们只考虑了无需认证的方式，即METHOD为0x00</p>
<p>2、local-proxy收到客户端的代理请求后，选择双方都支持的加密方式回复给客户端：</p>
<table>
<thead>
<tr>
<th>VER</th>
<th>METHOD</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
</tr>
</tbody></table>
<p>我们这里回复的应该是5，0</p>
<p>此时客户端收到服务端的响应请求后，双方握手完成，开始进行协议交互。</p>
<p>3、认证结束后，客户端发送请求信息，服务端通过解析客户端发过来的请求，获取地址和端口号。</p>
<p>4、获取地址和端口号之后，就可以与remote-proxy建立连接了</p>
<h2 id="HTTPS隧道服务"><a href="#HTTPS隧道服务" class="headerlink" title="HTTPS隧道服务"></a>HTTPS隧道服务</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">httptunnel</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = (first + http_connect).decode()</span><br><span class="line">    <span class="comment">#从http请求中解析出ip和端口号</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    <span class="keyword">await</span> xfer_remote(reader, writer, domain_name, port)</span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、<code>CONNECT www.example.com:443 HTTP/1.1</code>http协议很简单，只需要从请求中解析出地址和端口号就可以了。</p>
<p>2、回复<code>&#39;HTTP/1.1 200 OK\r\n\r\n&#39;</code>表明连接建立成功，注意一定要加上<code>\r\n\r\n</code></p>
<p>3、连接建立好后，就可以与remote-proxy通信了</p>
<h2 id="与远端模块通信"><a href="#与远端模块通信" class="headerlink" title="与远端模块通信"></a>与远端模块通信</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">xfer_remote</span>(<span class="params">reader, writer, address, port</span>):</span></span><br><span class="line">    <span class="comment">#与remote通信的协议是自己定的，为了方便，我直接使用了http协议</span></span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;123.56.111.64&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">    http_connect = <span class="string">&#x27;CONNECT &#x27;</span> + address + <span class="string">&#x27;:&#x27;</span> + port + <span class="string">&#x27; HTTP/1.1&#x27;</span></span><br><span class="line">    http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">    logging.info(http_connect)</span><br><span class="line">    writer_remote.write(http_connect.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">    reply = <span class="keyword">await</span> reader_remote.read(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;HTTP/1.1 200 OK&#x27;</span> <span class="keyword">in</span> reply.decode()):<span class="comment">#与remote连接建立成功</span></span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.info(<span class="string">&#x27;connect to remote failed!&#x27;</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、local-proxy与remote-proxy之间的通信协议是自己制定的，为了方便，我这里直接使用了http协议。</p>
<p>2、该函数与remote-proxy建立连接后，得到reader_remote和writer_remote。我们的目标是，将从本地reader读到的信息写进writer_remote，将reader_remote读到的信息写进本地writer。</p>
<p>3、建立一个task，使从远端读和像远端写并发执行。<code>tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</code></p>
<p>4、read_trans是用来将本地读到的消息转发给远端，write_trans是将从远端读到的消息转发给本地</p>
<h2 id="图形管理界面"><a href="#图形管理界面" class="headerlink" title="图形管理界面"></a>图形管理界面</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>(<span class="params">QtWidgets.QMainWindow</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=None</span>):</span></span><br><span class="line">        super(MainWindow,self).__init__(parent)</span><br><span class="line">        uic.loadUi(<span class="string">&quot;mainwindow.ui&quot;</span>, self) <span class="comment"># 加载界面</span></span><br><span class="line">        self.pushButton.clicked.connect(self.startClicked)</span><br><span class="line">        </span><br><span class="line">        self.process = QProcess()</span><br><span class="line">        self.process.setProcessChannelMode(QProcess.MergedChannels)</span><br><span class="line">        self.process.finished.connect(self.processFinished)<span class="comment">#当进程结束，触发processFinished</span></span><br><span class="line">        self.process.started.connect(self.processStarted)<span class="comment"># 当进程已经开始了，触发processStarted</span></span><br><span class="line">        self.process.readyReadStandardOutput.connect(self.processReadyRead) <span class="comment">#信号 如果stdio有输入，那么执行processReadyRead</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processReadyRead</span>(<span class="params">self</span>):</span></span><br><span class="line">        data = self.process.readAll()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            msg = data.data().decode().strip()</span><br><span class="line">            logging.debug(<span class="string">f&#x27;msg=<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            logging.error(<span class="string">f&#x27;<span class="subst">&#123;traceback.format_exc()&#125;</span>&#x27;</span>)</span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processStarted</span>(<span class="params">self</span>):</span>  <span class="comment">#进程开始后，调用该函数</span></span><br><span class="line">        process = self.sender() <span class="comment"># 此处等同于 self.process 只不过使用sender适应性更好</span></span><br><span class="line">        processId = process.processId()</span><br><span class="line">        logging.debug(<span class="string">f&#x27;pid=<span class="subst">&#123;processId&#125;</span>&#x27;</span>)</span><br><span class="line">        self.pushButton.setText(<span class="string">&#x27;stop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.websocket = QWebSocket()</span><br><span class="line">        self.websocket.connected.connect(self.websocketConnected)</span><br><span class="line">        self.websocket.disconnected.connect(self.websocketDisconnected)</span><br><span class="line">        self.websocket.textMessageReceived.connect(self.websocketMsgRcvd) <span class="comment">#当收到对方发的信息后</span></span><br><span class="line">        self.websocket.open(QUrl(<span class="string">f&#x27;ws://127.0.0.1:<span class="subst">&#123;self.consolePortLine.text()&#125;</span>/&#x27;</span>)) <span class="comment">#打开websocket连接，里面是端口号</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">startClicked</span>(<span class="params">self</span>):</span>  <span class="comment">#当点击开始按钮时</span></span><br><span class="line">        btn = self.sender()</span><br><span class="line">        text = btn.text().lower()</span><br><span class="line">        <span class="keyword">if</span> text.startswith(<span class="string">&#x27;start&#x27;</span>):</span><br><span class="line">            listenPort = self.listenPortLine.text()  <span class="comment">#本地端口10086</span></span><br><span class="line">            username = self.usernameLine.text()      <span class="comment">#用户名</span></span><br><span class="line">            password = self.passwordLine.text()      <span class="comment">#密码</span></span><br><span class="line">            consolePort = self.consolePortLine.text() <span class="comment">#websockts端口</span></span><br><span class="line">            remoteHost = self.remoteHostLine.text() <span class="comment">#远程主机ip</span></span><br><span class="line">            remotePort = self.remotePortLine.text() <span class="comment">#远程主机端口</span></span><br><span class="line">            pythonExec = os.path.basename(sys.executable)</span><br><span class="line">            cmdLine = <span class="string">f&#x27;<span class="subst">&#123;pythonExec&#125;</span> local-proxy.py -p <span class="subst">&#123;listenPort&#125;</span> -u <span class="subst">&#123;username&#125;</span> -w <span class="subst">&#123;password&#125;</span> -k <span class="subst">&#123;consolePort&#125;</span> <span class="subst">&#123;remoteHost&#125;</span> <span class="subst">&#123;remotePort&#125;</span>&#x27;</span></span><br><span class="line">            logging.info(cmdLine)</span><br><span class="line">            logging.debug(<span class="string">f&#x27;cmd=<span class="subst">&#123;cmdLine&#125;</span>&#x27;</span>)</span><br><span class="line">            self.process.start(cmdLine)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.process.kill()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processFinished</span>(<span class="params">self</span>):</span></span><br><span class="line">        process = self.sender()</span><br><span class="line">        log.debug(<span class="string">f&#x27;pid=<span class="subst">&#123;process.processId()&#125;</span>&#x27;</span>)</span><br><span class="line">        self.startBtn.setText(<span class="string">&#x27;Start&#x27;</span>)</span><br><span class="line">        self.processIdLine.setText(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketConnected</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.websocket.sendTextMessage(<span class="string">&#x27;connect successful&#x27;</span>) <span class="comment">#连接建立后发送</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketDisconnected</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.process.kill()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketMsgRcvd</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        logging.debug(<span class="string">f&#x27;msg=<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        sendBandwidth, recvBandwidth, *_ = msg.split()</span><br><span class="line">        nowTime = QDateTime.currentDateTime().toString(<span class="string">&#x27;hh:mm:ss&#x27;</span>)</span><br><span class="line">        logging.info(sendBandwidth)</span><br><span class="line">        logging.info(recvBandwidth)</span><br><span class="line">        self.sendBandwidthLine.setText(<span class="string">f&#x27;<span class="subst">&#123;nowTime&#125;</span> <span class="subst">&#123;sendBandwidth&#125;</span> Bps&#x27;</span>)</span><br><span class="line">        self.lineEdit_2.setText(<span class="string">f&#x27;<span class="subst">&#123;nowTime&#125;</span> <span class="subst">&#123;recvBandwidth&#125;</span> Bps&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、界面使用QT的designer设计的，然后将其转换为python的ui代码，<code>uic.loadUi(&quot;mainwindow.ui&quot;, self) # 加载界面</code>加载ui文件，将设计好的界面导入。</p>
<p>2、当点击开始按钮时，会触发信号startClicked，该函数会打开local-proxy.py程序<code>self.process.start(cmdLine)</code>，当程序开始运行时，又会触发信号processStarted，该函数在界面模块和local-proxy之间建立websocket连接，之后在界面进行的操作就可以发送给local-proxy了。</p>
<p>3、websocket负责与local-proxy通信，将用户信息发送给local-proxy，然后接收来自local-proxy的速率。</p>
<h1 id="远端系统"><a href="#远端系统" class="headerlink" title="远端系统"></a>远端系统</h1><p>【文字描述】</p>
<p>remote-proxy接收来自local-proxy的连接，验证local-proxy的用户，并且提供了流控措施。同时，为了方便对用户数据库的管理，，提供了用户数据库的REST管理接口。</p>
<h2 id="与本地模块通信"><a href="#与本地模块通信" class="headerlink" title="与本地模块通信"></a>与本地模块通信</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">reader_local, writer_local</span>):</span></span><br><span class="line">    logging.info(<span class="string">&#x27;start working&#x27;</span>)</span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(<span class="string">&#x27;user.db&#x27;</span>)</span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader_local.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = http_connect.decode()</span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    j = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    k = j + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[k] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">    username = http_connect[i + <span class="number">1</span>: j]</span><br><span class="line">    password = http_connect[j + <span class="number">1</span>: k]</span><br><span class="line">    sql = <span class="string">&#x27;SELECT * FROM user where name = \&#x27;&#x27;</span> + username + <span class="string">&#x27;\&#x27; and password = \&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span></span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">await</span> cursor.close()</span><br><span class="line">    <span class="keyword">if</span>(len(row) != <span class="number">1</span>):</span><br><span class="line">        logging.error(<span class="string">&#x27;wrong account&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.info(<span class="string">&#x27;right account&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(username <span class="keyword">not</span> <span class="keyword">in</span> username_to_token_bucket.keys()):<span class="comment">#用户名不在dict中，要创建令牌桶</span></span><br><span class="line">        username_to_token_bucket[username] = <span class="number">0</span></span><br><span class="line">        logging.info(<span class="string">&#x27;init bucket&#x27;</span>)</span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(domain_name,port)</span><br><span class="line">    sql = <span class="string">&#x27;select dataRate FROM user where name = \&#x27;&#x27;</span> + username + <span class="string">&#x27;\&#x27;&#x27;</span> </span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">await</span> cursor.close()</span><br><span class="line">    speed = row[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer_local.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_local.drain()</span><br><span class="line"></span><br><span class="line">    tasks = [read_trans(reader_local, writer_remote), write_trans(reader_remote, writer_local, username, speed)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks,return_when=asyncio.FIRST_COMPLETED)</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect from clinet&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer, username, speed</span>):</span></span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            data = <span class="keyword">await</span> reader_remote.read(int(<span class="number">0.01</span> * speed))<span class="comment"># 10.01s    speed  Bytes/s</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect from server&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span>(username_to_token_bucket[username] &lt; <span class="number">10</span>):<span class="comment">#如果桶里的令牌不够那么就等待，注意，这里用了asyncio.sleep(0)</span></span><br><span class="line">            <span class="comment"># 目的是让cpu去执行其他部分的代码，防止在此处阻塞</span></span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:<span class="comment">#令牌够了，把data发出去，同时把data清空</span></span><br><span class="line">            username_to_token_bucket[username] -= <span class="number">10</span></span><br><span class="line">            writer.write(data)</span><br><span class="line">            <span class="keyword">await</span> writer.drain()</span><br><span class="line">            data = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、local-proxy和remote-proxy之间的通信协议是自己定的，我这里直接使用了http协议。</p>
<p>2、在收到local-proxy的消息后，从消息中解析出地址、端口号、用户名和密码。</p>
<p>3、然后进行用户名密码验证，验证通过之后，从数据库中查询该用户的速率。</p>
<p>4、向local-proxy回复<code>&#39;HTTP/1.1 200 OK\r\n\r\n&#39;</code>，表明连接建立成功</p>
<p>5、接下来local-proxy和remote-proxy就可以进行通信了。</p>
<p>6、在remote-proxy向local-proxy发送数据时，要在此处执行限速。只有当令牌的数量足够，才会发送数据包，这也就实现了下载限速。</p>
<h2 id="多用户管理"><a href="#多用户管理" class="headerlink" title="多用户管理"></a>多用户管理</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    asyncio.create_task(token_bucket_plus_one())</span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(handle, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、利用start_server函数，监听来自所有IP地址对端口10010的连接。</p>
<p>2、连接建立后回调handle函数，在handle函数对连接进行处理</p>
<p>3、每来一个用户，就会新建一个连接并且调用handle函数，这样就实现了多用户管理。</p>
<h2 id="用户流控"><a href="#用户流控" class="headerlink" title="用户流控"></a>用户流控</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer, username, speed</span>):</span></span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            data = <span class="keyword">await</span> reader_remote.read(int(<span class="number">0.01</span> * speed))<span class="comment"># 10.01s    speed  Bytes/s</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect from server&#x27;</span>)</span><br><span class="line">            username_to_token_bucket.pop(username)<span class="comment">#去掉该用户</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span>(username_to_token_bucket[username] &lt; <span class="number">10</span>):<span class="comment">#如果桶里的令牌不够那么就等待，注意，这里用了asyncio.sleep(0)</span></span><br><span class="line">            <span class="comment"># 目的是让cpu去执行其他部分的代码，防止在此处阻塞</span></span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:<span class="comment">#令牌够了，把data发出去，同时把data清空</span></span><br><span class="line">            username_to_token_bucket[username] -= <span class="number">10</span></span><br><span class="line">            writer.write(data)</span><br><span class="line">            <span class="keyword">await</span> writer.drain()</span><br><span class="line">            data = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">token_bucket_plus_one</span>():</span></span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> username_to_token_bucket.keys():<span class="comment"># 每1秒可以攒够1000个令牌，所以平均速率为100KB/s</span></span><br><span class="line">            <span class="keyword">if</span> username_to_token_bucket[k] &lt; <span class="number">10000</span>:</span><br><span class="line">                username_to_token_bucket[k] += <span class="number">10</span></span><br><span class="line">                print(username_to_token_bucket[k])</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span>)</span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、username_to_token_bucket是一个dict，键为用户名，因为用户名是唯一的，值是该用户对应的令牌桶。</p>
<p>2、为token_bucket_plus_one创建一个task，每隔一定时间将所有用户对应的令牌桶里令牌的数量加一</p>
<p>3、限速发生在下载时。当有数据发过来时，不会立即发送到local-proxy，而是等待令牌的数量，只有令牌数量够了，才会将数据转发出去。</p>
<p>4、每个用户都会建立一个连接，向local-proxy转发数据时，首先根据用户名创建相应的令牌桶，然后根据该用户的限制速度来进行限速。</p>
<p>5、当用户断开连接时，要在username_to_token_bucket里去掉该用户。</p>
<h2 id="用户数据库管理接口"><a href="#用户数据库管理接口" class="headerlink" title="用户数据库管理接口"></a>用户数据库管理接口</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.exception(exceptions.NotFound)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">ignore_404</span>(<span class="params">req, exc</span>):</span></span><br><span class="line">    <span class="keyword">return</span> response.text(<span class="string">&#x27;err_url&#x27;</span>, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得所有用户信息</span></span><br><span class="line"><span class="meta">@app.get(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">userList</span>(<span class="params">req</span>):</span></span><br><span class="line">    userList = list()</span><br><span class="line">    sql = <span class="string">&#x27;select name, password, dataRate from user;&#x27;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiosqlite.connect(app.config.DB_NAME) <span class="keyword">as</span> db:</span><br><span class="line">        cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> row <span class="keyword">in</span> cursor:</span><br><span class="line">            user = &#123;<span class="string">&#x27;name&#x27;</span> : row[<span class="number">0</span>], <span class="string">&#x27;password&#x27;</span> : row[<span class="number">1</span>], <span class="string">&#x27;dataRate:&#x27;</span> : row[<span class="number">2</span>]&#125;</span><br><span class="line">            logging.debug(<span class="string">f&#x27;<span class="subst">&#123;user&#125;</span>&#x27;</span>)</span><br><span class="line">            userList.append(user)</span><br><span class="line">    <span class="keyword">return</span> response.json(userList)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新用户信息</span></span><br><span class="line"><span class="meta">@app.put(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">updateUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    update_user_info = req.json</span><br><span class="line">    name = update_user_info.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    password = update_user_info.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    dataRate = update_user_info.get(<span class="string">&#x27;dataRate&#x27;</span>)</span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user not exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;update user set password = \&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;, dataRate = &#x27;</span> + str(dataRate) + <span class="string">&#x27; where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;update successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加用户信息</span></span><br><span class="line"><span class="meta">@app.post(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">insertUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    insert_user_info = req.json</span><br><span class="line">    name = insert_user_info.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    password = insert_user_info.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    dataRate = insert_user_info.get(<span class="string">&#x27;dataRate&#x27;</span>)</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span>    </span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) != <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user already exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;insert into user values(\&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;,&#x27;</span> + str(dataRate) + <span class="string">&#x27;);&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;insert successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除用户信息</span></span><br><span class="line"><span class="meta">@app.delete(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">deleteUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    delete_user_info = req.json</span><br><span class="line">    name = delete_user_info.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span>  </span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user not exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;delete from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()    </span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;delete successful&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>【文字描述】</p>
<p>1、通过不同的http请求来实现对用户数据库的增删改查，对应的http请求分别为post,delete,put,get。</p>
<p>2、在进行删除、增加、更新用户数据时均有<strong>错误处理</strong>，例如，对于更新来说，首先查询待更新的用户是否存在，如果不存在，则返回错误信息，如果存在，则更新并且返回更新成功信息。</p>
<h1 id="程序完整源码"><a href="#程序完整源码" class="headerlink" title="程序完整源码"></a>程序完整源码</h1><p>【此处根据个人具体情况粘贴程序源码，可以是单个文件或多个文件，但是只限于自己编写的源程序】</p>
<p>local.py </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line">VERSION = <span class="number">5</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">socks5</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    addr_from = writer.get_extra_info(<span class="string">&#x27;peername&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">f&#x27;connect from<span class="subst">&#123;addr_from&#125;</span>&#x27;</span>)</span><br><span class="line">    header = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    header = first + header</span><br><span class="line">    ver, num_method = struct.unpack(<span class="string">&quot;!BB&quot;</span>, header)</span><br><span class="line">    logging.info(<span class="string">f&#x27;ver == VERSION:<span class="subst">&#123;ver == VERSION&#125;</span>&#x27;</span>)</span><br><span class="line">    logging.info(<span class="string">&#x27;num_method = %d&#x27;</span> % num_method)</span><br><span class="line">    methods = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_method):</span><br><span class="line">        methods.append(ord(<span class="keyword">await</span> reader.read(<span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> <span class="keyword">not</span> <span class="keyword">in</span> methods:<span class="comment">#无需认证</span></span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="comment">#回应一个数据包，包括协议版本号，指定认证方法</span></span><br><span class="line">    writer.write(struct.pack(<span class="string">&quot;!BB&quot;</span>, VERSION, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    request = <span class="keyword">await</span> reader.read(<span class="number">4</span>)</span><br><span class="line">    ver, cmd, rsv, atype = struct.unpack(<span class="string">&quot;!BBBB&quot;</span>, request)</span><br><span class="line">    <span class="keyword">assert</span> ver == VERSION</span><br><span class="line">    <span class="keyword">assert</span> cmd == <span class="number">1</span></span><br><span class="line">    <span class="comment">#ipv4</span></span><br><span class="line">    <span class="keyword">if</span> atype == <span class="number">1</span>:</span><br><span class="line">        address = socket.inet_ntoa(<span class="keyword">await</span> reader.read(<span class="number">4</span>))</span><br><span class="line">    <span class="comment">#域名</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">3</span>:</span><br><span class="line">        domain_length = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">        address = <span class="keyword">await</span> reader.read(domain_length[<span class="number">0</span>])</span><br><span class="line">    <span class="comment">#ipv6</span></span><br><span class="line">    <span class="keyword">elif</span> atype == <span class="number">4</span>:</span><br><span class="line">        address = socket.inet_ntop(socket.AF_INET6, <span class="keyword">await</span> reader.read(<span class="number">16</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        writer.close()</span><br><span class="line">        writer.wait_closed()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    port = struct.unpack(<span class="string">&#x27;!H&#x27;</span>, <span class="keyword">await</span> reader.read(<span class="number">2</span>))</span><br><span class="line">    reply = struct.pack(<span class="string">&quot;!BBBBIH&quot;</span>, VERSION, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    writer.write(reply)</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    logging.info(address.decode(), str(port[<span class="number">0</span>]))</span><br><span class="line">    <span class="comment"># 得到了地址和端口号，sock5连接建立完成,然后调用函数，与remote-proxy连接</span></span><br><span class="line">    <span class="keyword">await</span> xfer_remote(reader, writer, address.decode(), str(port[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">httptunnel</span>(<span class="params">first, reader, writer</span>):</span></span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = (first + http_connect).decode()</span><br><span class="line">    <span class="comment">#从http请求中解析出ip和端口号</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer.drain()</span><br><span class="line">    <span class="keyword">await</span> xfer_remote(reader, writer, domain_name, port)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">xfer_remote</span>(<span class="params">reader, writer, address, port</span>):</span></span><br><span class="line">    <span class="comment">#与remote通信的协议是自己定的，为了方便，我直接使用了http协议</span></span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(<span class="string">&#x27;123.56.111.64&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">    http_connect = <span class="string">&#x27;CONNECT &#x27;</span> + address + <span class="string">&#x27;:&#x27;</span> + port + <span class="string">&#x27; HTTP/1.1&#x27;</span></span><br><span class="line">    http_connect += <span class="string">&#x27; %&#x27;</span> + username + <span class="string">&#x27;%&#x27;</span> + password + <span class="string">&#x27;%&#x27;</span></span><br><span class="line">    logging.info(http_connect)</span><br><span class="line">    writer_remote.write(http_connect.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line">    reply = <span class="keyword">await</span> reader_remote.read(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&#x27;HTTP/1.1 200 OK&#x27;</span> <span class="keyword">in</span> reply.decode()):<span class="comment">#与remote连接建立成功</span></span><br><span class="line">        tasks = [read_trans(reader, writer_remote), write_trans(reader_remote, writer)]</span><br><span class="line">        <span class="keyword">await</span> asyncio.wait(tasks)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.info(<span class="string">&#x27;connect to remote failed!&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader_remote.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        writer.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">reader, writer</span>):</span></span><br><span class="line">    first = <span class="keyword">await</span> reader.read(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span>(first == <span class="string">b&#x27;\x05&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> socks5(first, reader, writer)</span><br><span class="line">    <span class="keyword">elif</span>(first == <span class="string">b&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="keyword">await</span> httptunnel(first, reader, writer)</span><br><span class="line"></span><br><span class="line">username = str()</span><br><span class="line">password = str()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">global</span> username, password</span><br><span class="line">    <span class="keyword">if</span>(len(sys.argv) != <span class="number">3</span>):</span><br><span class="line">        logging.info(<span class="string">&#x27;usage: local-proxy.py username, password&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        username = sys.argv[<span class="number">1</span>]</span><br><span class="line">        password = sys.argv[<span class="number">2</span>]</span><br><span class="line">    logging.info(username)</span><br><span class="line">    logging.info(password)</span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(start, <span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">10086</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">        </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p>localGui.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5.QtCore <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtGui <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtNetwork <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWidgets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> PyQt5.QtWebSockets <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> mainwindow <span class="keyword">import</span> Ui_MainWindow</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtWidgets, uic</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> humanfriendly</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>(<span class="params">QtWidgets.QMainWindow</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, parent=None</span>):</span></span><br><span class="line">        super(MainWindow,self).__init__(parent)</span><br><span class="line">        uic.loadUi(<span class="string">&quot;mainwindow.ui&quot;</span>, self) <span class="comment"># 加载界面</span></span><br><span class="line">        self.pushButton.clicked.connect(self.startClicked)</span><br><span class="line">        </span><br><span class="line">        self.process = QProcess()</span><br><span class="line">        self.process.setProcessChannelMode(QProcess.MergedChannels)</span><br><span class="line">        self.process.finished.connect(self.processFinished)<span class="comment">#当进程结束，触发processFinished</span></span><br><span class="line">        self.process.started.connect(self.processStarted)<span class="comment"># 当进程已经开始了，触发processStarted</span></span><br><span class="line">        self.process.readyReadStandardOutput.connect(self.processReadyRead) <span class="comment">#信号 如果stdio有输入，那么执行processReadyRead</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processReadyRead</span>(<span class="params">self</span>):</span></span><br><span class="line">        data = self.process.readAll()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            msg = data.data().decode().strip()</span><br><span class="line">            logging.debug(<span class="string">f&#x27;msg=<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            logging.error(<span class="string">f&#x27;<span class="subst">&#123;traceback.format_exc()&#125;</span>&#x27;</span>)</span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processStarted</span>(<span class="params">self</span>):</span>  <span class="comment">#进程开始后，调用该函数</span></span><br><span class="line">        process = self.sender() <span class="comment"># 此处等同于 self.process 只不过使用sender适应性更好</span></span><br><span class="line">        processId = process.processId()</span><br><span class="line">        logging.debug(<span class="string">f&#x27;pid=<span class="subst">&#123;processId&#125;</span>&#x27;</span>)</span><br><span class="line">        self.pushButton.setText(<span class="string">&#x27;stop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        self.websocket = QWebSocket()</span><br><span class="line">        self.websocket.connected.connect(self.websocketConnected)</span><br><span class="line">        self.websocket.disconnected.connect(self.websocketDisconnected)</span><br><span class="line">        self.websocket.textMessageReceived.connect(self.websocketMsgRcvd) <span class="comment">#当收到对方发的信息后</span></span><br><span class="line">        self.websocket.open(QUrl(<span class="string">f&#x27;ws://127.0.0.1:<span class="subst">&#123;self.consolePortLine.text()&#125;</span>/&#x27;</span>)) <span class="comment">#打开websocket连接，里面是端口号</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">startClicked</span>(<span class="params">self</span>):</span>  <span class="comment">#当点击开始按钮时</span></span><br><span class="line">        btn = self.sender()</span><br><span class="line">        text = btn.text().lower()</span><br><span class="line">        <span class="keyword">if</span> text.startswith(<span class="string">&#x27;start&#x27;</span>):</span><br><span class="line">            listenPort = self.listenPortLine.text()  <span class="comment">#本地端口10086</span></span><br><span class="line">            username = self.usernameLine.text()      <span class="comment">#用户名</span></span><br><span class="line">            password = self.passwordLine.text()      <span class="comment">#密码</span></span><br><span class="line">            consolePort = self.consolePortLine.text() <span class="comment">#websockts端口</span></span><br><span class="line">            remoteHost = self.remoteHostLine.text() <span class="comment">#远程主机ip</span></span><br><span class="line">            remotePort = self.remotePortLine.text() <span class="comment">#远程主机端口</span></span><br><span class="line">            pythonExec = os.path.basename(sys.executable)</span><br><span class="line">            cmdLine = <span class="string">f&#x27;<span class="subst">&#123;pythonExec&#125;</span> local-proxy.py -p <span class="subst">&#123;listenPort&#125;</span> -u <span class="subst">&#123;username&#125;</span> -w <span class="subst">&#123;password&#125;</span> -k <span class="subst">&#123;consolePort&#125;</span> <span class="subst">&#123;remoteHost&#125;</span> <span class="subst">&#123;remotePort&#125;</span>&#x27;</span></span><br><span class="line">            print(cmdLine)</span><br><span class="line">            logging.debug(<span class="string">f&#x27;cmd=<span class="subst">&#123;cmdLine&#125;</span>&#x27;</span>)</span><br><span class="line">            self.process.start(cmdLine)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.process.kill()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">processFinished</span>(<span class="params">self</span>):</span></span><br><span class="line">        process = self.sender()</span><br><span class="line">        log.debug(<span class="string">f&#x27;pid=<span class="subst">&#123;process.processId()&#125;</span>&#x27;</span>)</span><br><span class="line">        self.startBtn.setText(<span class="string">&#x27;Start&#x27;</span>)</span><br><span class="line">        self.processIdLine.setText(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketConnected</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.websocket.sendTextMessage(<span class="string">&#x27;connect successful&#x27;</span>) <span class="comment">#连接建立后随便发的</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketDisconnected</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.process.kill()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">websocketMsgRcvd</span>(<span class="params">self, msg</span>):</span></span><br><span class="line">        logging.debug(<span class="string">f&#x27;msg=<span class="subst">&#123;msg&#125;</span>&#x27;</span>)</span><br><span class="line">        sendBandwidth, recvBandwidth, *_ = msg.split()</span><br><span class="line">        nowTime = QDateTime.currentDateTime().toString(<span class="string">&#x27;hh:mm:ss&#x27;</span>)</span><br><span class="line">        logging.info(sendBandwidth)</span><br><span class="line">        logging.info(recvBandwidth)</span><br><span class="line">        self.sendBandwidthLine.setText(<span class="string">f&#x27;<span class="subst">&#123;nowTime&#125;</span> <span class="subst">&#123;sendBandwidth&#125;</span> Bps&#x27;</span>)</span><br><span class="line">        self.lineEdit_2.setText(<span class="string">f&#x27;<span class="subst">&#123;nowTime&#125;</span> <span class="subst">&#123;recvBandwidth&#125;</span> Bps&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = QApplication(sys.argv)</span><br><span class="line">app.aboutToQuit.connect(app.deleteLater)</span><br><span class="line">form = MainWindow()</span><br><span class="line">form.show()</span><br><span class="line">app.exec_()</span><br></pre></td></tr></table></figure>

<p>remote.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">logging.basicConfig(level=logging.INFO)</span><br><span class="line"><span class="keyword">import</span> nest_asyncio</span><br><span class="line">nest_asyncio.apply()</span><br><span class="line"><span class="keyword">import</span> aiosqlite</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">handle</span>(<span class="params">reader_local, writer_local</span>):</span></span><br><span class="line">    logging.info(<span class="string">&#x27;start working&#x27;</span>)</span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(<span class="string">&#x27;user.db&#x27;</span>)</span><br><span class="line">    http_connect = (<span class="keyword">await</span> reader_local.read(<span class="number">1024</span>))</span><br><span class="line">    http_connect = http_connect.decode()</span><br><span class="line">    logging.info(http_connect)</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;:&#x27;</span>): </span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    domain_name = http_connect[<span class="number">8</span> : i]</span><br><span class="line">    j = i</span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27; &#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    port = http_connect[i + <span class="number">1</span> : j]</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[i] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    j = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[j] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        j += <span class="number">1</span></span><br><span class="line">    k = j + <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span>(http_connect[k] != <span class="string">&#x27;%&#x27;</span>):</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">    username = http_connect[i + <span class="number">1</span>: j]</span><br><span class="line">    password = http_connect[j + <span class="number">1</span>: k]</span><br><span class="line">    sql = <span class="string">&#x27;SELECT * FROM user where name = \&#x27;&#x27;</span> + username + <span class="string">&#x27;\&#x27; and password = \&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;&#x27;</span></span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">await</span> cursor.close()</span><br><span class="line">    <span class="keyword">if</span>(len(row) != <span class="number">1</span>):</span><br><span class="line">        logging.error(<span class="string">&#x27;wrong account&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logging.info(<span class="string">&#x27;right account&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(username <span class="keyword">not</span> <span class="keyword">in</span> username_to_token_bucket.keys()):<span class="comment">#用户名不在dict中，要创建令牌桶</span></span><br><span class="line">        username_to_token_bucket[username] = <span class="number">0</span></span><br><span class="line">        logging.info(<span class="string">&#x27;init bucket&#x27;</span>)</span><br><span class="line">    reader_remote,writer_remote = <span class="keyword">await</span> asyncio.open_connection(domain_name,port)</span><br><span class="line">    sql = <span class="string">&#x27;select dataRate FROM user where name = \&#x27;&#x27;</span> + username + <span class="string">&#x27;\&#x27;&#x27;</span> </span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">await</span> cursor.close()</span><br><span class="line">    speed = row[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    reply = <span class="string">&#x27;HTTP/1.1 200 OK\r\n\r\n&#x27;</span></span><br><span class="line">    writer_local.write(reply.encode())</span><br><span class="line">    <span class="keyword">await</span> writer_local.drain()</span><br><span class="line"></span><br><span class="line">    tasks = [read_trans(reader_local, writer_remote), write_trans(reader_remote, writer_local, username, speed)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.wait(tasks,return_when=asyncio.FIRST_COMPLETED)</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">read_trans</span>(<span class="params">reader, writer_remote</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = <span class="keyword">await</span> reader.read(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect from clinet&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        writer_remote.write(data)</span><br><span class="line">        <span class="keyword">await</span> writer_remote.drain()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">write_trans</span>(<span class="params">reader_remote, writer, username, speed</span>):</span></span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span>(data == <span class="string">&#x27;&#x27;</span>):</span><br><span class="line">            data = <span class="keyword">await</span> reader_remote.read(int(<span class="number">0.01</span> * speed))<span class="comment"># 10.01s    speed  Bytes/s</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            logging.info(<span class="string">&#x27;disconnect from server&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span>(username_to_token_bucket[username] &lt; <span class="number">10</span>):<span class="comment">#如果桶里的令牌不够那么就等待，注意，这里用了asyncio.sleep(0)</span></span><br><span class="line">            <span class="comment"># 目的是让cpu去执行其他部分的代码，防止在此处阻塞</span></span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">0</span>)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:<span class="comment">#令牌够了，把data发出去，同时把data清空</span></span><br><span class="line">            username_to_token_bucket[username] -= <span class="number">10</span></span><br><span class="line">            writer.write(data)</span><br><span class="line">            <span class="keyword">await</span> writer.drain()</span><br><span class="line">            data = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">token_bucket_plus_one</span>():</span></span><br><span class="line">    <span class="keyword">global</span> username_to_token_bucket</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> username_to_token_bucket.keys():<span class="comment"># 每1秒可以攒够1000个令牌，所以平均速率为100KB/s</span></span><br><span class="line">            <span class="keyword">if</span> username_to_token_bucket[k] &lt; <span class="number">10000</span>:</span><br><span class="line">                username_to_token_bucket[k] += <span class="number">10</span></span><br><span class="line">                print(username_to_token_bucket[k])</span><br><span class="line">        <span class="keyword">await</span> asyncio.sleep(<span class="number">0.01</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    asyncio.create_task(token_bucket_plus_one())</span><br><span class="line">    server = <span class="keyword">await</span> asyncio.start_server(handle, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">10010</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> server:</span><br><span class="line">        <span class="keyword">await</span> server.serve_forever()</span><br><span class="line">username_to_token_bucket = &#123;&#125;</span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<p>remoteRest.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> response</span><br><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> aiosqlite</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">app = Sanic(<span class="string">&quot;RemoteProxyAdmin&quot;</span>)</span><br><span class="line">app.config.DB_NAME = <span class="string">&#x27;user.db&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception(exceptions.NotFound)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">ignore_404</span>(<span class="params">req, exc</span>):</span></span><br><span class="line">    <span class="keyword">return</span> response.text(<span class="string">&#x27;err_url&#x27;</span>, status=<span class="number">404</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得所有用户信息</span></span><br><span class="line"><span class="meta">@app.get(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">userList</span>(<span class="params">req</span>):</span></span><br><span class="line">    userList = list()</span><br><span class="line">    sql = <span class="string">&#x27;select name, password, dataRate from user;&#x27;</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiosqlite.connect(app.config.DB_NAME) <span class="keyword">as</span> db:</span><br><span class="line">        cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">for</span> row <span class="keyword">in</span> cursor:</span><br><span class="line">            user = &#123;<span class="string">&#x27;name&#x27;</span> : row[<span class="number">0</span>], <span class="string">&#x27;password&#x27;</span> : row[<span class="number">1</span>], <span class="string">&#x27;dataRate:&#x27;</span> : row[<span class="number">2</span>]&#125;</span><br><span class="line">            logging.debug(<span class="string">f&#x27;<span class="subst">&#123;user&#125;</span>&#x27;</span>)</span><br><span class="line">            userList.append(user)</span><br><span class="line">    <span class="keyword">return</span> response.json(userList)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新用户信息</span></span><br><span class="line"><span class="meta">@app.put(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">updateUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    update_user_info = req.json</span><br><span class="line">    name = update_user_info.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    password = update_user_info.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    dataRate = update_user_info.get(<span class="string">&#x27;dataRate&#x27;</span>)</span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user not exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;update user set password = \&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;, dataRate = &#x27;</span> + str(dataRate) + <span class="string">&#x27; where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;update successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加用户信息</span></span><br><span class="line"><span class="meta">@app.post(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">insertUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    insert_user_info = req.json</span><br><span class="line">    name = insert_user_info.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    password = insert_user_info.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">    dataRate = insert_user_info.get(<span class="string">&#x27;dataRate&#x27;</span>)</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span>    </span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) != <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user already exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;insert into user values(\&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;,\&#x27;&#x27;</span> + password + <span class="string">&#x27;\&#x27;,&#x27;</span> + str(dataRate) + <span class="string">&#x27;);&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()</span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;insert successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除用户信息</span></span><br><span class="line"><span class="meta">@app.delete(&#x27;/user&#x27;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">deleteUserInfo</span>(<span class="params">req</span>):</span></span><br><span class="line">    delete_user_info = req.json</span><br><span class="line">    name = delete_user_info.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    sql = <span class="string">&#x27;select * from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span>  </span><br><span class="line">    db = <span class="keyword">await</span> aiosqlite.connect(app.config.DB_NAME)</span><br><span class="line">    cursor = <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    row = <span class="keyword">await</span> cursor.fetchall()</span><br><span class="line">    <span class="keyword">if</span>(len(row) == <span class="number">0</span>):</span><br><span class="line">        <span class="keyword">await</span> cursor.close()</span><br><span class="line">        <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;user not exist&quot;</span>&#125;)</span><br><span class="line">    sql = <span class="string">&#x27;delete from user where name = \&#x27;&#x27;</span> + name + <span class="string">&#x27;\&#x27;;&#x27;</span></span><br><span class="line">    <span class="keyword">await</span> db.execute(sql)</span><br><span class="line">    <span class="keyword">await</span> db.commit()</span><br><span class="line">    <span class="keyword">await</span> db.close()    </span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;delete successful&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(&quot;/zrf&quot;)</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> response.json(&#123;<span class="string">&quot;hello&quot;</span>: <span class="string">&quot;world&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>宠物小精灵对战系统文档</title>
    <url>/2020/11/10/%E5%AE%A0%E7%89%A9%E5%B0%8F%E7%B2%BE%E7%81%B5%E6%96%87%E6%A1%A3/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="宠物小精灵对战系统文档"><a href="#宠物小精灵对战系统文档" class="headerlink" title="宠物小精灵对战系统文档"></a>宠物小精灵对战系统文档</h1><h2 id="一、题目要求"><a href="#一、题目要求" class="headerlink" title="一、题目要求"></a>一、题目要求</h2><p><strong>题目一：宠物小精灵的加入</strong></p>
<blockquote>
<p>要求：</p>
<p>设计宠物小精灵的类，为简化游戏设计，精灵的属性包括种类（力量型：高攻击； 肉盾型：高生命值； 防御型：高防御； 敏捷型：低攻击间隔，共四种）、名字、等级、经验值、攻击力、防御力、生命值、攻击间隔等（以上属性必须，其他属性可自行添加）（基本要求：本游戏中只有上面的4种类型。 进一步要求：上述4种类型可以进一步深入划分，比如力量型又可以再细分为：沙瓦朗、火爆猴、腕力等）</p>
<p>每个精灵初始等级为1，满级15级，每当精灵升级的时候，宠物对应的属性值会有少量增加（主属性增加量相对较多）</p>
<p>每个精灵有自己独特的攻击方式，如“闪电攻击”，“火焰攻击”等等，请设计一个精灵的基类，并将精灵的攻击方法设为虚方法以方便子类重写</p>
<p>请写一个测试程序对设计的精灵类的相关属性和方法（包括攻击函数，升级函数等）进行测试</p>
<p>题目主要考察点：类的继承，对象数据成员设计，成员函数设计 </p>
</blockquote>
<p><strong>题目二：用户注册与平台登录</strong></p>
<blockquote>
<p>要求：</p>
<p>每个用户需要注册一个账号，用户名全局唯一，不能有任何两个用户名相同，要考虑注册失败的场景时的反馈</p>
<p>实现注册、登录、登出功能，均采用C/S模式，客户端和服务端用socket进行通信，服务端保存所有用户的信息</p>
<p>每个用户拥有：用户名、拥有的精灵，两个属性。 用户注册成功时，系统自动随机分发三个1级精灵给用户</p>
<p>用户可以查看所有成功注册用户拥有的精灵，也可以查看所有当前在线的用户</p>
<p>题目主要考察点：socket通信，交互场景反馈，用户信息存储方式，界面交互，其它合理的新颖设计。</p>
</blockquote>
<p><strong>题目三：游戏对战的设计</strong></p>
<blockquote>
<p>要求：</p>
<p>已经登录的在线用户可以和服务器进行虚拟决斗，决斗分两种：升级赛和决斗赛，两种比赛都能增长精灵宠物经验值。服务器上有一个虚拟精灵的列表，用户可以挑选其中任意一个进行比赛（升级赛或者决斗赛）。另外决斗赛中用户胜出可以直接获得该战胜的精灵，失败则系统从用户的精灵中随机选三个（不够三个精灵的情况就选择他所有的精灵），然后由用户选一个送出。</p>
<p>升级赛 只是用户用来增加精灵经验值，规则开发者自定；</p>
<p>累积多少经验值升一级，规则开发者自定；</p>
<p>决斗赛的上述规则同升级赛，只是额外还可以赢得一个宠物或失去一个宠物。</p>
<p>用户如果没有精灵（比如总是失败，已经全部送出去），则系统会随机放给他一个初级精灵。</p>
<p>请让你的系统自动模拟每场比赛的每次出招。另外，为了增加不确定性，可以加入概率闪避攻击和暴击伤害机制</p>
<p>比赛的过程和结果由系统根据上述规则自动模拟完成，要求结果具有一定的随机性。</p>
<p>用户增加新功能，可以查看某个用户的胜率</p>
<p>用户增加新属性，为宠物个数徽章（金银铜）和高级宠物徽章（金银铜），分别根据拥有的宠物个数的多少和拥有高级宠物（15级）个数的多少颁发</p>
<p>题目主要考察点：客户端与服务器数据交互（可采用多进程或异步通信或其他方法均可），并发请求处理，类的方法设计，伤害计算方法设计，界面交互，其它合理的新颖设计。</p>
</blockquote>
<p><strong>软件设计要求</strong></p>
<blockquote>
<p>如有必要的友元函数，要在报告（课程设计报告）和程序中说明每个友元函数的不可替代性，为什么一定要用友元才能实现。</p>
<p>自己编写的代码，除主函数和必要的友元函数外，不允许出现任何一个非类成员函数。</p>
<p>任何不改变对象状态（不改写自身对象数据成员值）的成员函数均需显式标注const。</p>
</blockquote>
<p><strong>代码规范性要求</strong></p>
<blockquote>
<p>代码需遵循课件提出的编码规范要求。</p>
<p>通过开发环境自动生成的界面类代码，全部数据成员和成员函数需在类声明时加以注释，函数体内的必要步骤要加以注释。</p>
<p>其他全部类代码的数据成员和成员函数的声明和实现均需加以注释，成员函数的必要步骤要加以注释。</p>
</blockquote>
<h2 id="二、类的设计"><a href="#二、类的设计" class="headerlink" title="二、类的设计"></a>二、类的设计</h2><h3 id="题目一"><a href="#题目一" class="headerlink" title="题目一"></a>题目一</h3><p>首先设计精灵的基类，所有精灵都有具备这些属性以及函数</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">pet_base_class</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="built_in">string</span> name;<span class="comment">//宠物名字</span></span><br><span class="line">    pet_type type;<span class="comment">//宠物类别</span></span><br><span class="line">    <span class="keyword">int</span> id;<span class="comment">//宠物身份唯一标识</span></span><br><span class="line">    <span class="keyword">int</span> atk;<span class="comment">//攻击值</span></span><br><span class="line">    <span class="keyword">int</span> def;<span class="comment">//防御值</span></span><br><span class="line">    <span class="keyword">int</span> hp;<span class="comment">//总血量</span></span><br><span class="line">    <span class="keyword">int</span> speed;<span class="comment">//闪避速度</span></span><br><span class="line">    <span class="keyword">int</span> crit_rate;<span class="comment">//暴击率</span></span><br><span class="line">    <span class="keyword">int</span> remaining_hp;<span class="comment">//当前血量</span></span><br><span class="line">    pet_status status;<span class="comment">//宠物当前状态</span></span><br><span class="line">    <span class="keyword">int</span> remaining_chaos_time;<span class="comment">//状态异常剩余时间</span></span><br><span class="line">    <span class="comment">//string skill_name[4];//普通攻击和三种技能</span></span><br><span class="line">    <span class="comment">//string skill_description[4];</span></span><br><span class="line">    <span class="comment">//int skill_pp[3];//普通攻击pp为无限</span></span><br><span class="line">    <span class="keyword">int</span> level;<span class="comment">//宠物等级</span></span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">exp</span>;<span class="comment">//总的经验值</span></span><br><span class="line">    <span class="keyword">int</span> attack_interval;<span class="comment">//攻击间隔,先只弄一个技能，后续再添加,20/9/1 考虑攻击间隔为出招速度，在对战开始时，出招速度</span></span><br><span class="line">    <span class="comment">//快的宠物优先出招，只需要在战斗开始时判断一下谁的出招速度快就可以了</span></span><br><span class="line">    <span class="keyword">int</span> total_pp;<span class="comment">//只有一个技能</span></span><br><span class="line">    <span class="built_in">string</span> skill_name;</span><br><span class="line">    <span class="keyword">int</span> remaining_pp;<span class="comment">//剩余技能使用次数，目前只有普通攻击，以后再考虑,2020/9/1考虑添加技能pp</span></span><br><span class="line">    <span class="keyword">int</span> exp_need[<span class="number">14</span>];<span class="comment">//每升一级需要的经验，英雄初始为一级，2-15；</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> atk_debuff;<span class="comment">//被干扰后的攻击力</span></span><br><span class="line">    <span class="keyword">int</span> def_debuff;<span class="comment">//被干扰后的防御力</span></span><br><span class="line">    <span class="keyword">int</span> speed_debuff;<span class="comment">//被干扰后的闪避速度</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    pet_base_class(pet_type);</span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">get_name</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> name; &#125;<span class="comment">//获得宠物名字</span></span><br><span class="line">    <span class="function">pet_type <span class="title">get_type</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> type; &#125;<span class="comment">//获得宠物类型</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_id</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> id; &#125;<span class="comment">//获得宠物id，唯一标识</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_atk</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> atk; &#125;<span class="comment">//获得宠物攻击值</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_def</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> def; &#125;<span class="comment">//获得宠物防御值</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_hp</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> hp; &#125;<span class="comment">//获得宠物总血量</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_speed</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> speed; &#125;<span class="comment">//获得宠物攻速</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_crit_rate</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> crit_rate; &#125;<span class="comment">//获得宠物暴击率</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_remaining_hp</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> remaining_hp; &#125;<span class="comment">//获得宠物当前血量</span></span><br><span class="line">    <span class="function">pet_status <span class="title">get_status</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> status; &#125;<span class="comment">//获得宠物当前状态</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_remaining_chaos_time</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> remaining_chaos_time;&#125;<span class="comment">//获得宠物异常状态剩余时间</span></span><br><span class="line">    <span class="comment">//string* get_skill_name() &#123; return skill_name; &#125;;//获得技能名字</span></span><br><span class="line">    <span class="comment">//string* get_skill_description() &#123; return skill_description; &#125;;//获得技能描述</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_pp</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> total_pp; &#125;<span class="comment">//获得技能总pp</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_remaining_pp</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> remaining_pp;&#125;<span class="comment">//获得技能剩余pp</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_level</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> level; &#125;<span class="comment">//获得宠物等级</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_exp</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">exp</span>; &#125;<span class="comment">//获得宠物总经验值</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_attack_interval</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> attack_interval; &#125;<span class="comment">//获得宠物攻击间隔</span></span><br><span class="line">    <span class="comment">//int* get_remaining_pp() &#123; return remaining_pp; &#125;;//获得技能剩余次数</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_atk_debuff</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> atk_debuff;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_def_debuff</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> def_debuff;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get_speed_debuff</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> speed_debuff;&#125;</span><br><span class="line">    <span class="function">bullet* <span class="title">normal_attack</span><span class="params">(<span class="keyword">int</span>&amp;)</span></span>;<span class="comment">//普通攻击,返回攻击对象的指针，将其传入对方的unde_attack函数中</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">under_attack</span><span class="params">(bullet*,<span class="keyword">int</span>&amp;)</span></span>;<span class="comment">//受到攻击,返回true说明战斗失败，接收攻击方的攻击信息</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> bullet* <span class="title">skill</span><span class="params">()</span> </span>= <span class="number">0</span>;<span class="comment">//使用技能,纯虚函数，使用方法与normal_attack类似</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;<span class="comment">//输出精灵信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_exp</span><span class="params">(<span class="keyword">int</span>)</span></span>;<span class="comment">//获取经验值,每次执行完该函数就要执行level_up_exp（）；</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">level_up_exp</span><span class="params">()</span></span>;<span class="comment">//通用升级函数，当exp经验值到了，会自动升一级，函数有潜在的问题，没有考虑一下子升多级的情况</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deal_chaos</span><span class="params">()</span></span>;<span class="comment">//处理异常状态函数,每次受到技能攻击后执行该函数</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">chaos_recover</span><span class="params">()</span></span>;<span class="comment">//当宠物战败时，用于恢复到原来的状态</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">level_up_attribute</span><span class="params">()</span> </span>= <span class="number">0</span>;<span class="comment">//将自身属性升级，在level_up_exp（）中被调用</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">string</span> <span class="title">get_status_string</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (status)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> normal:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;normal&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> critical:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;critical&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> dizz:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;dizz&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> attack_debased:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;attack_debased&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> defence_debased:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;defence_debased&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> speed_debased:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;speed_debased&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>枚举类型，pet_type表示宠物类型，pet_status表示宠物的状态</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> pet_type</span><br><span class="line">&#123;</span><br><span class="line">    ATK, <span class="comment">//high attack</span></span><br><span class="line">    HP,	<span class="comment">//high HP</span></span><br><span class="line">    DEF, <span class="comment">//high defence</span></span><br><span class="line">    SPE	<span class="comment">//high speed</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">enum</span> pet_status</span><br><span class="line">&#123;</span><br><span class="line">    normal,<span class="comment">//正常</span></span><br><span class="line">    critical,<span class="comment">//暴击</span></span><br><span class="line">    dizz,<span class="comment">//眩晕，无法释放技能</span></span><br><span class="line">    attack_debased,<span class="comment">//攻击力被降低</span></span><br><span class="line">    defence_debased,<span class="comment">//防御值被降低</span></span><br><span class="line">    speed_debased<span class="comment">//闪避速度被降低</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>攻击类的设计，每当宠物使用技能时，就会将攻击的信息传入bullet中，由对方的宠物接收该bullet，进行血量以及状态的修改</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bullet</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    bullet();</span><br><span class="line">    bullet(<span class="keyword">const</span> bullet&amp;);</span><br><span class="line">    <span class="keyword">void</span> <span class="keyword">operator</span>=(<span class="keyword">const</span> bullet&amp;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> damage;<span class="comment">//基础伤害</span></span><br><span class="line">    pet_status status;<span class="comment">//该技能会对对方造成的debuff</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>设计不同属性的精灵，完成升级函数的设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Speed</span> :</span> <span class="keyword">public</span> pet_base_class</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        Speed() :pet_base_class(SPE) &#123;&#125;;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">level_up_attribute</span><span class="params">()</span></span>;<span class="comment">//升级属性</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Attack</span> :</span><span class="keyword">public</span> pet_base_class</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        Attack() :pet_base_class(ATK) &#123;&#125;;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">level_up_attribute</span><span class="params">()</span></span>;<span class="comment">//升级属性</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Defence</span> :</span><span class="keyword">public</span> pet_base_class</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        Defence() :pet_base_class(DEF) &#123;&#125;;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">level_up_attribute</span><span class="params">()</span></span>;<span class="comment">//升级属性</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tank</span> :</span><span class="keyword">public</span> pet_base_class</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        Tank() :pet_base_class(HP) &#123;&#125;;</span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">level_up_attribute</span><span class="params">()</span></span>;<span class="comment">//升级属性</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>具体精灵的实现，设计每个精灵独有的攻击属性</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//皮卡丘</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pikachu</span> :</span> <span class="keyword">public</span> Speed</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Pikachu(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//火球鼠</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cyndaquil</span> :</span> <span class="keyword">public</span> Speed</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Cyndaquil(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//烈焰猴</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Infernape</span> :</span> <span class="keyword">public</span> Attack</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Infernape(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//喷火龙</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Charizard</span> :</span> <span class="keyword">public</span> Attack</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Charizard(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//妙蛙种子</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bulbasaur</span> :</span> <span class="keyword">public</span> Defence</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Bulbasaur(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//卡比兽</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Snorlax</span> :</span> <span class="keyword">public</span> Defence</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Snorlax(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//杰尼龟</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Squirtle</span> :</span> <span class="keyword">public</span> Tank</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Squirtle(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//独角虫</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Weedle</span> :</span> <span class="keyword">public</span> Tank</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">bullet* <span class="title">skill</span><span class="params">()</span></span>;</span><br><span class="line">    Weedle(<span class="keyword">int</span>,<span class="keyword">int</span>);<span class="comment">//生成相应等级的宠物</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="题目二"><a href="#题目二" class="headerlink" title="题目二"></a>题目二</h3><p>用户的注册和登录，使用socket进行通信，分为客户端和服务器端</p>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>用户类的设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    user();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="built_in">string</span> user_name;</span><br><span class="line">    <span class="built_in">string</span> user_password;</span><br><span class="line">    <span class="keyword">int</span> win_session;<span class="comment">//胜场</span></span><br><span class="line">    <span class="keyword">int</span> total_session;<span class="comment">//总场</span></span><br><span class="line">    <span class="keyword">int</span> senior_pet_medal;<span class="comment">//高级精灵奖章:15级精灵个数</span></span><br><span class="line">    <span class="keyword">int</span> number_pet_medal;<span class="comment">//精灵个数奖章:精灵个数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>登录窗口设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Ui &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login_widget</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login_widget</span> :</span> <span class="keyword">public</span> QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">login_widget</span><span class="params">(QWidget *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    ~login_widget();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::login_widget *ui;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(<span class="built_in">string</span>,<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">regist</span><span class="params">(<span class="built_in">string</span>, <span class="built_in">string</span>)</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_login_button</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_regist_button</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_exit_button</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_regist_in_regist</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_return_to_login</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">warning</span><span class="params">(QString warn)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>网络层 接收端设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">server</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	SOCKET sock;<span class="comment">//创建套接字</span></span><br><span class="line">    <span class="comment">//const int PORT = 8000;</span></span><br><span class="line">	<span class="comment">//char buf[1024];//用于接收信息</span></span><br><span class="line">    sockaddr_in servAddr;<span class="comment">//服务端地址</span></span><br><span class="line">    sockaddr fromAddr;</span><br><span class="line">    QString username;</span><br><span class="line">    <span class="comment">//struct sockaddr clntAddr;//客户端地址</span></span><br><span class="line">	<span class="comment">//Pikachu* pet;//定义了一只宠物</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	server();</span><br><span class="line">    ~server();</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">login_success</span><span class="params">(QString)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">warning</span><span class="params">(QString)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init_user</span><span class="params">(user&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_pet_backpack</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_user_info</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_user_status</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">receive_pet_information</span><span class="params">(<span class="built_in">string</span>&amp;)</span></span>;<span class="comment">//接收宠物信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show_choose_defeat_pet</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_user_medal</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(<span class="built_in">string</span> username, <span class="built_in">string</span> password)</span></span>;<span class="comment">//发送登录请求</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">regist</span><span class="params">(<span class="built_in">string</span> username, <span class="built_in">string</span> password)</span></span>;<span class="comment">//发送注册信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_all_user_information</span><span class="params">()</span></span>;<span class="comment">//获得所有用户信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_all_user_status</span><span class="params">()</span></span>;<span class="comment">//获得所有用户在线状态</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_user_pet_information</span><span class="params">(<span class="built_in">string</span> username)</span></span>;<span class="comment">//获得某个用户的精灵信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">logout</span><span class="params">(<span class="built_in">string</span> username)</span></span>;<span class="comment">//退出登录</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">update_user_pet_information</span><span class="params">(pet_base_class&amp; pet,<span class="built_in">string</span> username)</span></span>;<span class="comment">//更新某用户的精灵信息 </span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">update_user_information</span><span class="params">(user&amp; u)</span></span>;<span class="comment">//更新用户信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">delete_user_pet</span><span class="params">(<span class="keyword">int</span> id)</span></span>;<span class="comment">//删除某个精灵信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_server_pet_information</span><span class="params">()</span></span>;<span class="comment">//获得服务器精灵信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_1_level_pet</span><span class="params">(<span class="built_in">string</span> username)</span></span>;<span class="comment">//获得一个初始精灵</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_myuser</span><span class="params">()</span></span>;<span class="comment">//get user information</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_user_pet_through_id</span><span class="params">(<span class="keyword">int</span> id)</span></span>;<span class="comment">//根据宠物id获取宠物的详细信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert_pet</span><span class="params">(pet_base_class&amp;,<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_random_3_pet</span><span class="params">(<span class="built_in">string</span>)</span></span>;<span class="comment">//决斗赛失败，用户随机失去一个精灵</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">query_number_pet_and_15_number_pet</span><span class="params">(<span class="built_in">string</span>)</span></span>;<span class="comment">//查询用户宠物个数，15级宠物个数</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>展示用户信息的窗口</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Ui &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user_info_widget</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user_info_widget</span> :</span> <span class="keyword">public</span> QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">user_info_widget</span><span class="params">(QWidget *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    ~user_info_widget();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_user_info_widget</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::user_info_widget *ui;</span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_user_info</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show_others_pet_backpack</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_user_info</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_user_status</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_my_item</span><span class="params">(QTableWidgetItem*)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="服务器端"><a href="#服务器端" class="headerlink" title="服务器端"></a>服务器端</h4><p>数据库的设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">database</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	sqlite3* db;</span><br><span class="line">	</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	database();</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">insert_user</span><span class="params">(user&amp;)</span></span>;<span class="comment">//插入用户</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">query_user</span><span class="params">(<span class="built_in">string</span> user_name, user&amp;)</span></span>;<span class="comment">//根据用户名查询用户,查询的结果保存在user类中</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">update_user</span><span class="params">(user&amp;)</span></span>;<span class="comment">//更新用户信息</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">get_user_list</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;&gt;&amp;)</span></span>;<span class="comment">//获得用户信息列表</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">get_pet_list</span><span class="params">(<span class="built_in">string</span> user_name, <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="built_in">string</span>&gt;&gt;&amp;)</span></span>;<span class="comment">//获取某用户的精灵信息,第一个参数为精灵名</span></span><br><span class="line">	<span class="built_in">unordered_map</span>&lt;<span class="built_in">string</span>, <span class="keyword">int</span>&gt; user_online_status;<span class="comment">//每当注册一个用户，就把用户名放进来 &lt;用户名，状态&gt;</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">update_num_of_pet</span><span class="params">()</span></span>;<span class="comment">//每当精灵数改变时，就执行该函数，更新精灵数量</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_pet_number</span><span class="params">(<span class="built_in">string</span>,<span class="built_in">string</span>&amp; uname)</span></span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">insert_pet</span><span class="params">(pet&amp;)</span></span>;<span class="comment">//插入精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">update_pet</span><span class="params">(pet&amp;)</span></span>;<span class="comment">//更新精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">delete_pet</span><span class="params">(<span class="built_in">string</span>&amp;)</span></span>;<span class="comment">//删除精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">query_pet</span><span class="params">(<span class="keyword">int</span> id, pet&amp;)</span></span>;<span class="comment">//根据id查询精灵</span></span><br><span class="line">	<span class="keyword">int</span> num_of_pet;<span class="comment">//计数，当前数据库有多少条记录，就是宠物的id，唯一身份标识</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>网络层 发送端设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">server</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	SOCKET sock;<span class="comment">//创建套接字</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> PORT = <span class="number">8000</span>;</span><br><span class="line">	<span class="comment">//char buf[1024];//用于接收信息</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servAddr</span>;</span><span class="comment">//服务端地址</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">clntAddr</span>;</span><span class="comment">//客户端地址</span></span><br><span class="line">	database* my_database;</span><br><span class="line">	<span class="built_in">unordered_map</span>&lt;<span class="keyword">int</span>, <span class="built_in">string</span>&gt; itos_pet;<span class="comment">//8个精灵精灵名字和序号对照表，用于随机选取数字</span></span><br><span class="line">	<span class="keyword">int</span> pet_id;<span class="comment">//服务器有16个精灵，id为1-16.每当分发新精灵时，id要加一。</span></span><br><span class="line">	<span class="comment">//注意：每当启动服务器时要计算出当前宠物个数，初始化pet_id和user_online_status,暂时未做，要放在构造函数中初始化</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	server();</span><br><span class="line">	~server() &#123; <span class="keyword">delete</span> my_database; &#125;;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">deal_login</span><span class="params">(<span class="built_in">string</span> username,<span class="built_in">string</span> password)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">deal_regist</span><span class="params">(<span class="built_in">string</span> username, <span class="built_in">string</span> password)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">deal_logout</span><span class="params">(<span class="built_in">string</span> username)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send_all_user_status</span><span class="params">()</span></span>;<span class="comment">//发送所有用户的在线状态信息、</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send_all_user_information</span><span class="params">()</span></span>;<span class="comment">//发送所有用户的信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send_user_pet_infomation</span><span class="params">(<span class="built_in">string</span> username)</span></span>;<span class="comment">//发送某用户拥有的精灵信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send_server_pet_information</span><span class="params">()</span></span>;<span class="comment">//发送服务器精灵信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">new_1_level_pet</span><span class="params">(<span class="built_in">string</span> username, <span class="built_in">string</span> pet_name)</span></span>;<span class="comment">//给用户分发一个1级精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">update_user_pet_information</span><span class="params">(pet&amp;)</span></span>;<span class="comment">//更新用户精灵的信息，这里输入暂定为一个精灵对象</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">delete_user_pet</span><span class="params">(<span class="built_in">string</span>&amp;)</span></span>;<span class="comment">//删除用户的一个精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">update_user_information</span><span class="params">(user&amp;)</span></span>;<span class="comment">//更新用户信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send_user_information</span><span class="params">(<span class="built_in">string</span> username)</span></span>;<span class="comment">//发送用户信息</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">send_user_pet_through_id</span><span class="params">(<span class="keyword">int</span> id)</span></span>;<span class="comment">//通过id发送精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_pet_when_win</span><span class="params">(pet&amp;)</span></span>;<span class="comment">//决斗赛胜利了，那么获得对手的精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_random_3_pet</span><span class="params">(<span class="built_in">string</span> username)</span></span>;<span class="comment">//随机获得三个精灵</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">get_pet_number</span><span class="params">(<span class="built_in">string</span> uname)</span></span>;<span class="comment">//查询宠物个数和15级宠物个数</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">receive</span><span class="params">()</span></span>;<span class="comment">//从客户端收到的信息</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>用户类设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    user();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="built_in">string</span> user_name;</span><br><span class="line">    <span class="built_in">string</span> user_password;</span><br><span class="line">    <span class="keyword">int</span> win_session;<span class="comment">//胜场</span></span><br><span class="line">    <span class="keyword">int</span> total_session;<span class="comment">//总场</span></span><br><span class="line">    <span class="keyword">int</span> senior_pet_medal;<span class="comment">//高级精灵奖章:15级精灵个数</span></span><br><span class="line">    <span class="keyword">int</span> number_pet_medal;<span class="comment">//精灵个数奖章:精灵个数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="题目三"><a href="#题目三" class="headerlink" title="题目三"></a>题目三</h3><p>选择精灵场景</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Ui &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">choose_pet_widget</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">choose_pet_widget</span> :</span> <span class="keyword">public</span> QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">choose_pet_widget</span><span class="params">(QWidget *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    ~choose_pet_widget();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_choose_pet_widget</span><span class="params">()</span></span>;</span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_choose_pet</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start_battle</span><span class="params">(<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::choose_pet_widget *ui;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_choose_pet_backpack</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_pet_1</span><span class="params">(QTableWidgetItem*)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">get_pet_2</span><span class="params">(QTableWidgetItem*)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_start_button</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_promotion_competition</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_duels_competition</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对战场景</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Ui &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">battle_widget</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">battle_widget</span> :</span> <span class="keyword">public</span> QWidget</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">battle_widget</span><span class="params">(QWidget *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    ~battle_widget();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">battle</span><span class="params">(pet_base_class&amp; a,pet_base_class&amp; b)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::battle_widget *ui;</span><br><span class="line">    pet_base_class * user_pet;</span><br><span class="line">    pet_base_class * server_pet;</span><br><span class="line">    <span class="keyword">int</span> battle_style;<span class="comment">//1为升级赛，2为决斗赛</span></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init_two_pet</span><span class="params">(<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_after_battle</span><span class="params">(<span class="keyword">bool</span> is_win,<span class="built_in">string</span> server_pet_name,<span class="keyword">int</span> server_pet_level,<span class="keyword">int</span> battle_s,<span class="keyword">int</span> user_pet_id)</span></span>;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init_battle_ground</span><span class="params">(<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="keyword">int</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_normal_attack</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_skill</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">click_quit</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>主界面的设计</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Ui &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span> :</span> <span class="keyword">public</span> QMainWindow</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MainWindow</span><span class="params">(QWidget *parent = <span class="number">0</span>)</span></span>;</span><br><span class="line">    ~MainWindow();</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">paintEvent</span><span class="params">(QPaintEvent *)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">closeEvent</span><span class="params">(QCloseEvent *)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::MainWindow *ui;</span><br><span class="line">    login_widget *login_window;</span><br><span class="line">    pet_backpack *pet_backpack_window;</span><br><span class="line">    user_info_widget * user_info_window;</span><br><span class="line">    choose_pet_widget * choose_pet_window;</span><br><span class="line">    battle_widget * battle_window;</span><br><span class="line">    server * myserver;</span><br><span class="line">    user* myuser;</span><br><span class="line">    <span class="comment">//battle_controller * battle;</span></span><br><span class="line">    pet_base_class * mypet;</span><br><span class="line">    <span class="built_in">string</span> save_user_pet_information;</span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">(QString)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init_user</span><span class="params">(user&amp;)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_MainWindow</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show_pet_backpack</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_pet_backpack</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show_others_pet_backpack</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="comment">//void exit_others_pet_backpack();</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show_user_info_window</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_user_info_window</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show_choose_pet_window</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">exit_choose_pet_window</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start_battle</span><span class="params">(<span class="built_in">string</span>,<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init_two_pet</span><span class="params">(<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="built_in">string</span>,<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_after_battle</span><span class="params">(<span class="keyword">bool</span> is_win,<span class="built_in">string</span> server_pet_name,<span class="keyword">int</span> server_pet_level,<span class="keyword">int</span> battle_s,<span class="keyword">int</span> user_pet_id)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">receive_pet_information</span><span class="params">(<span class="built_in">string</span>&amp;)</span></span>;<span class="comment">//接收宠物信息</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">show_choose_defeat_pet</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refresh_user_medal</span><span class="params">(<span class="built_in">string</span>)</span></span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="三、具体实现"><a href="#三、具体实现" class="headerlink" title="三、具体实现"></a>三、具体实现</h2><h3 id="题目一-1"><a href="#题目一-1" class="headerlink" title="题目一"></a>题目一</h3><h4 id="1、精灵的构造"><a href="#1、精灵的构造" class="headerlink" title="1、精灵的构造"></a>1、精灵的构造</h4><p>每个精灵都会在自己的父类上进行构造。基类的构造函数初始化所有精灵的通用属性，属性类的构造函数初始化精灵的升级函数，具体的精灵类则实现该精灵特有的攻击函数，下面以Cyndaquil为例</p>
<p>基类</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">pet_base_class::pet_base_class(pet_type t)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;type = t;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk = <span class="number">50</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def = <span class="number">20</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;hp = <span class="number">500</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;speed = <span class="number">10</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;crit_rate = <span class="number">0</span>;<span class="comment">//初始暴击率为0%</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">this</span>-&gt;status = normal;</span><br><span class="line">	<span class="keyword">this</span>-&gt;level = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;<span class="built_in">exp</span> = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;attack_interval = <span class="number">2000</span>;<span class="comment">//2000毫秒</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_chaos_time = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>属性类</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Speed::level_up_attribute</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk += <span class="keyword">this</span>-&gt;level / <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk_debuff += <span class="keyword">this</span>-&gt;level / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def += <span class="keyword">this</span>-&gt;level / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def_debuff += <span class="keyword">this</span>-&gt;level / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;hp += <span class="keyword">this</span>-&gt;level;</span><br><span class="line">	<span class="keyword">this</span>-&gt;speed += <span class="keyword">this</span>-&gt;level / <span class="number">4</span>;<span class="comment">//speed应该是闪避速度，攻击间隔才是攻击速度</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;speed_debuff += <span class="keyword">this</span>-&gt;level / <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;crit_rate += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">this</span>-&gt;attack_interval -= <span class="number">50</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk_debuff = <span class="keyword">this</span>-&gt;atk;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def_debuff = <span class="keyword">this</span>-&gt;def;</span><br><span class="line">	<span class="keyword">this</span>-&gt;speed_debuff = <span class="keyword">this</span>-&gt;speed;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_hp = <span class="keyword">this</span>-&gt;hp;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_pp = <span class="keyword">this</span>-&gt;total_pp;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>精灵类</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//火球鼠</span></span><br><span class="line">Cyndaquil::Cyndaquil(<span class="keyword">int</span> level,<span class="keyword">int</span> _id)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;name = <span class="string">&quot;Cyndaquil&quot;</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;type = SPE;</span><br><span class="line">    <span class="keyword">this</span>-&gt;id = _id;</span><br><span class="line">    <span class="keyword">this</span>-&gt;total_pp = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_pp = <span class="keyword">this</span>-&gt;total_pp;</span><br><span class="line">	<span class="keyword">this</span>-&gt;skill_name = <span class="string">&quot;Cyndaquil_skill&quot;</span>;</span><br><span class="line">	<span class="comment">//this-&gt;level = level;</span></span><br><span class="line">	<span class="keyword">if</span> (level &lt; <span class="number">2</span>) <span class="keyword">this</span>-&gt;<span class="built_in">exp</span> = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">this</span>-&gt;<span class="built_in">exp</span> = <span class="keyword">this</span>-&gt;exp_need[level - <span class="number">2</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; level; i++) <span class="keyword">this</span>-&gt;level_up_exp();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">bullet* <span class="title">Cyndaquil::skill</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_pp--;</span><br><span class="line">	bullet* attack = <span class="keyword">new</span> bullet;</span><br><span class="line">	attack-&gt;damage = <span class="keyword">this</span>-&gt;atk_debuff * <span class="keyword">this</span>-&gt;level / <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">int</span> p = rand() % <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">if</span> (p &lt; <span class="number">40</span>)<span class="comment">//有40%的几率降低对方防御</span></span><br><span class="line">	&#123;</span><br><span class="line">		attack-&gt;status = defence_debased;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		attack-&gt;status = normal;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="keyword">this</span>-&gt;get_name() &lt;&lt; <span class="string">&quot; use skill_attack, damage = &quot;</span> &lt;&lt; attack-&gt;damage &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> attack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、精灵攻击方式"><a href="#2、精灵攻击方式" class="headerlink" title="2、精灵攻击方式"></a>2、精灵攻击方式</h4><h5 id="普通攻击"><a href="#普通攻击" class="headerlink" title="普通攻击"></a>普通攻击</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">bullet* <span class="title">pet_base_class::normal_attack</span><span class="params">(<span class="keyword">int</span> &amp; i)</span><span class="comment">//普通攻击暴击i为1，不暴击为0</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	bullet* attack = <span class="keyword">new</span> bullet;</span><br><span class="line">	attack-&gt;status = normal;</span><br><span class="line">    attack-&gt;damage = <span class="keyword">this</span>-&gt;atk_debuff * <span class="keyword">this</span>-&gt;level / <span class="number">3</span>;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; &quot;normal attack damage &quot; &lt;&lt; attack-&gt;damage;</span></span><br><span class="line">	<span class="keyword">int</span> p = rand() % <span class="number">100</span>;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (p &lt;= <span class="keyword">this</span>-&gt;crit_rate)<span class="comment">//普通攻击如果暴击</span></span><br><span class="line">	&#123;</span><br><span class="line">        i = <span class="number">1</span>;</span><br><span class="line">		attack-&gt;status = critical;</span><br><span class="line">        <span class="keyword">if</span>(attack-&gt;damage != <span class="number">0</span>)</span><br><span class="line">            attack-&gt;damage += <span class="number">10</span> * <span class="keyword">this</span>-&gt;level;<span class="comment">//伤害增加</span></span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;critical!&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="keyword">this</span>-&gt;get_name() &lt;&lt;<span class="string">&quot; use normal_attack, damage = &quot;</span> &lt;&lt; attack-&gt;damage &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> attack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>普通攻击造成一定的伤害，并且有一定几率暴击，暴击的效果和精灵的当前等级有关</p>
<h5 id="技能攻击"><a href="#技能攻击" class="headerlink" title="技能攻击"></a>技能攻击</h5><p>不同精灵的技能有不同的攻击属性，下面以Pikachu为例</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">bullet* <span class="title">Pikachu::skill</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_pp--;</span><br><span class="line">	bullet* attack = <span class="keyword">new</span> bullet;</span><br><span class="line">	attack-&gt;damage = <span class="keyword">this</span>-&gt;atk_debuff * <span class="keyword">this</span>-&gt;level / <span class="number">3</span>;</span><br><span class="line">	<span class="keyword">int</span> p = rand() % <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">if</span> (p &lt; <span class="number">30</span>)<span class="comment">//有30%的几率降低对方攻击力</span></span><br><span class="line">	&#123;</span><br><span class="line">		attack-&gt;status = attack_debased;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		attack-&gt;status = normal;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="keyword">this</span>-&gt;get_name() &lt;&lt; <span class="string">&quot; use skill_attack, damage = &quot;</span> &lt;&lt; attack-&gt;damage &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> attack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>技能攻击会造成一定伤害，并且有一定几率使对手陷入异常状态，异常状态包括攻击力下降，防御力下降，闪避速度下降，眩晕</p>
<h5 id="受到伤害"><a href="#受到伤害" class="headerlink" title="受到伤害"></a>受到伤害</h5><p>精灵使用技能后，计算出该技能的伤害和异常状态，返回值传入bullet类中，然后对手精灵接收该bullet类</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">pet_base_class::under_attack</span><span class="params">(bullet* attack,<span class="keyword">int</span>&amp; i)</span><span class="comment">//被攻击精灵 的 状态</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> damage;</span><br><span class="line">	<span class="keyword">int</span> p = rand() % <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">if</span> (p &lt; <span class="keyword">this</span>-&gt;speed_debuff)<span class="comment">//如果闪避</span></span><br><span class="line">	&#123;</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">		damage = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;sidestep&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	damage = attack-&gt;damage - <span class="keyword">this</span>-&gt;def_debuff * <span class="keyword">this</span>-&gt;level / <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> (damage &lt; <span class="number">0</span>) damage = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="keyword">this</span>-&gt;get_name() &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">	<span class="keyword">switch</span> (attack-&gt;status)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> normal:</span><br><span class="line">        i = <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;under normal attack&quot;</span> &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//受到了普通攻击效果，可能是普通攻击或者技能攻击</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> critical:</span><br><span class="line">        i =<span class="number">2</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;under critical normal attack&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> dizz:</span><br><span class="line">        i=<span class="number">3</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;under dizz&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> attack_debased:</span><br><span class="line">        i=<span class="number">4</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;under attack_debased&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> defence_debased:</span><br><span class="line">        i=<span class="number">5</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;under defence_debased&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> speed_debased:</span><br><span class="line">        i=<span class="number">6</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;under speed_debased&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="keyword">this</span>-&gt;get_name() &lt;&lt; <span class="string">&quot; takes damage: &quot;</span> &lt;&lt; damage &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">this</span>-&gt;remaining_chaos_time == <span class="number">0</span> || attack-&gt;status != normal)<span class="comment">//如果不处于异常状态</span></span><br><span class="line">		<span class="keyword">this</span>-&gt;status = attack-&gt;status;<span class="comment">//被攻击 获得debuff</span></span><br><span class="line">	<span class="keyword">if</span> (attack-&gt;status != normal &amp;&amp; attack-&gt;status != critical)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;remaining_chaos_time = <span class="number">2</span>;<span class="comment">//默认会debuff两个回合</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (damage &gt;= <span class="keyword">this</span>-&gt;remaining_hp)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">this</span>-&gt;remaining_hp = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;<span class="comment">//血量为0，返回true，战斗失败</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;remaining_hp -= damage;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="keyword">this</span>-&gt;get_name() &lt;&lt; <span class="string">&quot; hp is : &quot;</span> &lt;&lt; <span class="keyword">this</span>-&gt;remaining_hp &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="异常状态处理"><a href="#异常状态处理" class="headerlink" title="异常状态处理"></a>异常状态处理</h5><p>异常状态会持续两个回合</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pet_base_class::deal_chaos</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (remaining_chaos_time == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;atk_debuff = <span class="keyword">this</span>-&gt;atk;</span><br><span class="line">		<span class="keyword">this</span>-&gt;def_debuff = <span class="keyword">this</span>-&gt;def;</span><br><span class="line">		<span class="keyword">this</span>-&gt;speed_debuff = <span class="keyword">this</span>-&gt;speed;</span><br><span class="line">		<span class="keyword">this</span>-&gt;status = normal;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (<span class="keyword">this</span>-&gt;status)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> dizz:</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;status:dizz  &quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">this</span>-&gt;atk_debuff = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> attack_debased:</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;status:attack_debased&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">this</span>-&gt;atk_debuff = <span class="keyword">this</span>-&gt;atk - <span class="number">2</span> * <span class="keyword">this</span>-&gt;level;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> defence_debased:</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;status:defence_debased&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">this</span>-&gt;def_debuff = <span class="keyword">this</span>-&gt;def - <span class="number">2</span> * <span class="keyword">this</span>-&gt;level;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> speed_debased:</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;status:speed_debased&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">this</span>-&gt;speed_debuff = <span class="keyword">this</span>-&gt;speed - <span class="number">2</span> * <span class="keyword">this</span>-&gt;level;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">this</span>-&gt;remaining_chaos_time &gt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">this</span>-&gt;remaining_chaos_time--;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pet_base_class::chaos_recover</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;status = normal;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_chaos_time = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk_debuff = <span class="keyword">this</span>-&gt;atk;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def_debuff = <span class="keyword">this</span>-&gt;def;</span><br><span class="line">	<span class="keyword">this</span>-&gt;speed_debuff = <span class="keyword">this</span>-&gt;speed;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_hp = <span class="keyword">this</span>-&gt;hp;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_pp = <span class="keyword">this</span>-&gt;remaining_pp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="升级函数"><a href="#升级函数" class="headerlink" title="升级函数"></a>升级函数</h5><p>每种属性的精灵有着不同的升级函数，当经验累积到一定程度，就会自动升级</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Speed::level_up_attribute</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk += <span class="keyword">this</span>-&gt;level / <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk_debuff += <span class="keyword">this</span>-&gt;level / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def += <span class="keyword">this</span>-&gt;level / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def_debuff += <span class="keyword">this</span>-&gt;level / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;hp += <span class="keyword">this</span>-&gt;level;</span><br><span class="line">	<span class="keyword">this</span>-&gt;speed += <span class="keyword">this</span>-&gt;level / <span class="number">4</span>;<span class="comment">//speed应该是闪避速度，攻击间隔才是攻击速度</span></span><br><span class="line">	<span class="keyword">this</span>-&gt;speed_debuff += <span class="keyword">this</span>-&gt;level / <span class="number">4</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;crit_rate += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">this</span>-&gt;attack_interval -= <span class="number">50</span>;</span><br><span class="line">	<span class="keyword">this</span>-&gt;atk_debuff = <span class="keyword">this</span>-&gt;atk;</span><br><span class="line">	<span class="keyword">this</span>-&gt;def_debuff = <span class="keyword">this</span>-&gt;def;</span><br><span class="line">	<span class="keyword">this</span>-&gt;speed_debuff = <span class="keyword">this</span>-&gt;speed;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_hp = <span class="keyword">this</span>-&gt;hp;</span><br><span class="line">	<span class="keyword">this</span>-&gt;remaining_pp = <span class="keyword">this</span>-&gt;total_pp;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="题目二-1"><a href="#题目二-1" class="headerlink" title="题目二"></a>题目二</h3><h4 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h4><h5 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">server::server()</span><br><span class="line">&#123;</span><br><span class="line">    WSADATA wsaData;</span><br><span class="line">    WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsaData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建套接字</span></span><br><span class="line">    sock = socket(PF_INET, SOCK_DGRAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绑定套接字</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;servAddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(servAddr));  <span class="comment">//每个字节都用0填充</span></span><br><span class="line">    servAddr.sin_family = PF_INET;  <span class="comment">//使用IPv4地址</span></span><br><span class="line">    servAddr.sin_addr.s_addr = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    servAddr.sin_port = htons(<span class="number">1234</span>);  <span class="comment">//端口</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="发送登录请求"><a href="#发送登录请求" class="headerlink" title="发送登录请求"></a>发送登录请求</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::login</span><span class="params">(<span class="built_in">string</span> username, <span class="built_in">string</span> password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;username = QString::fromStdString(username);</span><br><span class="line">    <span class="built_in">string</span> msg;</span><br><span class="line">    msg += <span class="string">&quot;1;&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += password;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span> &lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">    <span class="comment">//qDebug()&lt;&lt;WSAGetLastError();</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;receive();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="发送注册请求"><a href="#发送注册请求" class="headerlink" title="发送注册请求"></a>发送注册请求</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::regist</span><span class="params">(<span class="built_in">string</span> username, <span class="built_in">string</span> password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg;</span><br><span class="line">    msg += <span class="string">&quot;2;&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += password;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span> &lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">    <span class="keyword">this</span>-&gt;receive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="获得所有用户信息"><a href="#获得所有用户信息" class="headerlink" title="获得所有用户信息"></a>获得所有用户信息</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::get_all_user_information</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg = <span class="string">&quot;3&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">    <span class="keyword">this</span>-&gt;receive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="获取所有用户在线状态"><a href="#获取所有用户在线状态" class="headerlink" title="获取所有用户在线状态"></a>获取所有用户在线状态</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::get_all_user_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg = <span class="string">&quot;4&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">    <span class="keyword">this</span>-&gt;receive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="获得某个用户的精灵信息"><a href="#获得某个用户的精灵信息" class="headerlink" title="获得某个用户的精灵信息"></a>获得某个用户的精灵信息</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::get_user_pet_information</span><span class="params">(<span class="built_in">string</span> username)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg = <span class="string">&quot;5;&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">    <span class="keyword">this</span>-&gt;receive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="发送注销请求"><a href="#发送注销请求" class="headerlink" title="发送注销请求"></a>发送注销请求</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::logout</span><span class="params">(<span class="built_in">string</span> username)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg = <span class="string">&quot;6;&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="更新用户的精灵信息"><a href="#更新用户的精灵信息" class="headerlink" title="更新用户的精灵信息"></a>更新用户的精灵信息</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::update_user_pet_information</span><span class="params">(pet_base_class&amp; pet,<span class="built_in">string</span> username)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg;</span><br><span class="line">    msg += <span class="string">&quot;7;&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_id());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += pet.get_name();</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_atk());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_def());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_hp());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_crit_rate());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_speed());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_level());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_exp());</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="更新用户的信息"><a href="#更新用户的信息" class="headerlink" title="更新用户的信息"></a>更新用户的信息</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::update_user_information</span><span class="params">(user&amp; u)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg;</span><br><span class="line">    msg += <span class="string">&quot;8;&quot;</span>;</span><br><span class="line">    msg += u.user_name;</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += u.user_password;</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(u.win_session);</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(u.total_session);</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(u.senior_pet_medal);</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(u.number_pet_medal);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="删除用户宠物"><a href="#删除用户宠物" class="headerlink" title="删除用户宠物"></a>删除用户宠物</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::delete_user_pet</span><span class="params">(<span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg;</span><br><span class="line">    msg += <span class="string">&quot;9;&quot;</span>;</span><br><span class="line">    msg += to_string(id);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="获得服务器端宠物信息"><a href="#获得服务器端宠物信息" class="headerlink" title="获得服务器端宠物信息"></a>获得服务器端宠物信息</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::get_server_pet_information</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg = <span class="string">&quot;:&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="随机获得一个一级的宠物"><a href="#随机获得一个一级的宠物" class="headerlink" title="随机获得一个一级的宠物"></a>随机获得一个一级的宠物</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::get_1_level_pet</span><span class="params">(<span class="built_in">string</span> username)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg = <span class="string">&quot;;;&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="插入一个宠物"><a href="#插入一个宠物" class="headerlink" title="插入一个宠物"></a>插入一个宠物</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::insert_pet</span><span class="params">(pet_base_class&amp; pet,<span class="built_in">string</span> username)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg;</span><br><span class="line">    msg += <span class="string">&quot;&gt;;&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_id());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += pet.get_name();</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_atk());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_def());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_hp());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_crit_rate());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_speed());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_level());</span><br><span class="line">    msg += <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    msg += to_string(pet.get_exp());</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="随机获得三个宠物"><a href="#随机获得三个宠物" class="headerlink" title="随机获得三个宠物"></a>随机获得三个宠物</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::get_random_3_pet</span><span class="params">(<span class="built_in">string</span> username)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> msg;</span><br><span class="line">    msg += <span class="string">&quot;?;&quot;</span>;</span><br><span class="line">    msg += username;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ch = msg.c_str();</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">&quot;clinet:&quot;</span>&lt;&lt; ch;</span><br><span class="line">    sendto(sock, ch, <span class="built_in">strlen</span>(ch), <span class="number">0</span>, (struct sockaddr*)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr));</span><br><span class="line">    <span class="keyword">this</span>-&gt;receive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="接收来自服务器的信息"><a href="#接收来自服务器的信息" class="headerlink" title="接收来自服务器的信息"></a>接收来自服务器的信息</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::receive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> addrLen = <span class="keyword">sizeof</span>(fromAddr);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    recvfrom(sock, buf, <span class="number">1023</span>, <span class="number">0</span>, &amp;fromAddr, &amp;addrLen);<span class="comment">//接收请求报文</span></span><br><span class="line">    <span class="comment">//if (buff_size &lt;= 0) continue;</span></span><br><span class="line">    qDebug() &lt;&lt;  <span class="string">&quot;server:&quot;</span> &lt;&lt; buf;</span><br><span class="line">    <span class="keyword">switch</span>(buf[<span class="number">0</span>]-<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="comment">//login successful</span></span><br><span class="line">        <span class="function">emit <span class="title">login_success</span><span class="params">(<span class="keyword">this</span>-&gt;username)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="function">emit <span class="title">warning</span><span class="params">(<span class="string">&quot;Wrong password!&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="function">emit <span class="title">warning</span><span class="params">(<span class="string">&quot;User does not exist!&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="function">emit <span class="title">warning</span><span class="params">(<span class="string">&quot;User already exists!&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="comment">//regist successful</span></span><br><span class="line">        <span class="function">emit <span class="title">warning</span><span class="params">(<span class="string">&quot;Regist successful! Login again please&quot;</span>)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> msg;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        user* u = <span class="keyword">new</span> user;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">        u-&gt;user_name = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">        <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">        u-&gt;user_password = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">        u-&gt;win_session = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">        <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">        u-&gt;total_session = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">        <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">        u-&gt;senior_pet_medal = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">        <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">        u-&gt;number_pet_medal = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">        <span class="function">emit <span class="title">init_user</span><span class="params">(*u)</span></span>;</span><br><span class="line">        <span class="keyword">delete</span> u;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> msg = buf;</span><br><span class="line">        <span class="function">emit <span class="title">refresh_pet_backpack</span><span class="params">(msg)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> msg = buf;</span><br><span class="line">        <span class="function">emit <span class="title">refresh_user_info</span><span class="params">(msg)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> msg = buf;</span><br><span class="line">        <span class="function">emit <span class="title">refresh_user_status</span><span class="params">(msg)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> msg = buf;</span><br><span class="line">        <span class="function">emit <span class="title">receive_pet_information</span><span class="params">(msg)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">11</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> msg = buf;</span><br><span class="line">        <span class="function">emit <span class="title">show_choose_defeat_pet</span><span class="params">(msg)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">12</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">string</span> msg = buf;</span><br><span class="line">        <span class="function">emit <span class="title">refresh_user_medal</span><span class="params">(msg)</span></span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务器端-1"><a href="#服务器端-1" class="headerlink" title="服务器端"></a>服务器端</h4><h5 id="接收来自客户端的信息"><a href="#接收来自客户端的信息" class="headerlink" title="接收来自客户端的信息"></a>接收来自客户端的信息</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">server::receive</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="keyword">int</span> nSize = <span class="keyword">sizeof</span>(SOCKADDR);</span><br><span class="line">        <span class="keyword">int</span> buff_size = recvfrom(sock, buf, <span class="number">1023</span>, <span class="number">0</span>, (struct sockaddr*)&amp;clntAddr, &amp;nSize);<span class="comment">//接收请求报文 </span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (buff_size &lt;= <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;form ip adrress&quot;</span> &lt;&lt; ntohl(clntAddr.sin_addr.s_addr) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">switch</span> (buf[<span class="number">0</span>] - <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//登陆请求,buf里包含着用户名和密码，中间用，分隔     1;username,password</span></span><br><span class="line">            <span class="built_in">string</span> uname, pword;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                pword += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (deal_login(uname, pword))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//注册请求，buf里包含着用户名和密码，中间用，分隔     2;username,password</span></span><br><span class="line">            <span class="built_in">string</span> uname, pword;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                pword += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            deal_regist(uname, pword);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获取所有的用户信息   3</span></span><br><span class="line">            send_all_user_information();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获得用户在线状态   4</span></span><br><span class="line">            send_all_user_status();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//获得某用户的精灵信息  5;uname</span></span><br><span class="line">            <span class="built_in">string</span> uname;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            send_user_pet_infomation(uname);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//退出登录 6;uname</span></span><br><span class="line">            <span class="built_in">string</span> uname;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            deal_logout(uname);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//更新某用户的精灵信息     7;id,username,name,atk,def,hp,crit_rate,speed,level,exp</span></span><br><span class="line">            <span class="built_in">string</span> msg;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            pet *p = <span class="keyword">new</span> pet;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;id = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;username = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;name = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;atk = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;def = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;hp = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;crit_rate = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;speed = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;level = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;<span class="built_in">exp</span> = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            update_user_pet_information(*p);</span><br><span class="line">            p-&gt;print();</span><br><span class="line">            <span class="keyword">delete</span> p;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//更新用户信息     8;name,password,win,total,senior_pet_model,number_pet_medel </span></span><br><span class="line">            <span class="built_in">string</span> msg;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            user* u = <span class="keyword">new</span> user;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            u-&gt;user_name = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            u-&gt;user_password = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            u-&gt;win_session = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            u-&gt;total_session = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            u-&gt;senior_pet_medal = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            u-&gt;number_pet_medal = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            update_user_information(*u);</span><br><span class="line">            <span class="comment">//u-&gt;print();</span></span><br><span class="line">            <span class="keyword">delete</span> u;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//删除某用户的精灵信息     9;id</span></span><br><span class="line">            <span class="built_in">string</span> id;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                id += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">cout</span> &lt;&lt; id &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">            delete_user_pet(id);</span><br><span class="line">           </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">10</span>:   <span class="comment">//:冒号</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//发送服务器精灵信息    10</span></span><br><span class="line">            send_server_pet_information();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">11</span>: <span class="comment">//;分号</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//给用户一个初始精灵    ;;username</span></span><br><span class="line">            <span class="built_in">string</span> uname;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> p = rand() % <span class="number">8</span>;</span><br><span class="line">            new_1_level_pet(uname, itos_pet[p]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">12</span>:<span class="comment">//&lt; 小于号 &lt;;uname</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> uname;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            send_user_information(uname);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13</span>:<span class="comment">//=等号  &lt;;id</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> id;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                id += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            send_user_pet_through_id(stoi(id));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">14</span>: <span class="comment">// &gt;大于号   插入获得的精灵  &gt;;id,username,name,atk,def,hp,crit_rate,speed,level,exp</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> msg;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            pet* p = <span class="keyword">new</span> pet;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;id = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;username = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;name = msg; msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;atk = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;def = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;hp = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;crit_rate = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;speed = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;,&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;level = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            <span class="keyword">for</span> (; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++) msg += buf[i];</span><br><span class="line">            p-&gt;<span class="built_in">exp</span> = stoi(msg); msg = <span class="string">&quot;&quot;</span>; i++;</span><br><span class="line">            get_pet_when_win(*p);</span><br><span class="line">            p-&gt;print();</span><br><span class="line">            <span class="keyword">delete</span> p;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">15</span>:<span class="comment">//随机三个精灵，  ?;username</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> uname;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            get_random_3_pet(uname);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">16</span>:<span class="comment">//查询用户宠物个数和15级宠物个数</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> uname;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; buf[i] != <span class="string">&#x27;\0&#x27;</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                uname += buf[i];</span><br><span class="line">            &#125;</span><br><span class="line">            get_pet_number(uname);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>15. 三数之和</title>
    <url>/2021/01/08/hot-100/15.%E4%B8%89%E6%95%B0%E4%B9%8B%E5%92%8C/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="解法-双指针"><a href="#解法-双指针" class="headerlink" title="解法 双指针"></a>解法 双指针</h3><p>首先我们对数组排序。</p>
<p>因为要找三数之和，用$i,j,k$来表示，用$i$表示第一个数，我们对$j, k$用双指针算法。</p>
<p>令$i &lt; j &lt; k$，固定好$i$，使$j$指向$i$的后一项，$k$指向最后一个数。如果$nums[i] + nums[j] + nums[k] &gt; 0$，说明$k$指向的数字比较大，将$k$左移；如果小于0，那么需要将$j$右移。</p>
<p>如何去除重复的三元组呢？</p>
<p>对于$i$来说，如果有重复的，我们跳过即可。</p>
<p>我们还要考虑重复的$j$，处理方式也是跳过去即可。</p>
<p>对于重复的$k$呢？$i, j$确定下来以后，那么$nums[k]$的值是确定的，我们只要找到<strong>一个</strong>值为$nums[k]$的$k$就可以了，因此$k$不会重复。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt; <span class="title">threeSum</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&amp; nums)</span> </span>&#123;</span><br><span class="line">        sort(nums.begin(), nums.end());</span><br><span class="line">        <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt;&gt; res;</span><br><span class="line">        <span class="keyword">int</span> t;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nums.size(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(i &amp;&amp; nums[i] == nums[i - <span class="number">1</span>]) <span class="keyword">continue</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i + <span class="number">1</span>, k = nums.size() - <span class="number">1</span>; j &lt; k; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(j &gt; i + <span class="number">1</span> &amp;&amp; nums[j] == nums[j - <span class="number">1</span>]) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">//注意此处为什么写j &lt; k - 1，如果写j &lt; k，那么在执行k--后，发现j &lt; k不满足，那么k和j就重复了！</span></span><br><span class="line">                <span class="comment">//执行下面的if语句可能会导致k和j指向同一个数字，加入到答案中。</span></span><br><span class="line">                <span class="keyword">while</span>(j &lt; k - <span class="number">1</span> &amp;&amp; nums[i] + nums[j] + nums[k] &gt; <span class="number">0</span>) k--;</span><br><span class="line">                <span class="keyword">if</span>(nums[i] + nums[j] + nums[k] == <span class="number">0</span>)</span><br><span class="line">                    res.push_back(&#123;nums[i], nums[j], nums[k2]&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>HOT-100</tag>
      </tags>
  </entry>
</search>
